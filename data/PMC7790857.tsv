	section	paragraph	sentence	text
1	Title	1	1	Neuronal diversity and convergence in a visual system developmental atlas
2	Abstract	1	1	Deciphering how neuronal diversity is established and maintained requires a detailed knowledge of neuronal gene expression throughout development.
3	Abstract	1	2	In contrast to mammalian brains1,2, the large neuronal diversity of the Drosophila optic lobes3 and its connectome4-6 are almost completely characterized.
4	Abstract	1	3	However, a molecular characterization of this diversity, particularly during development, has been lacking.
5	Abstract	1	4	We present novel insights into brain development through a nearly exhaustive description of the transcriptomic diversity of the optic lobes.
6	Abstract	1	5	We acquired the transcriptome of 275,000 single-cells at adult and five pupal stages, and developed a machine learning framework to assign them to almost 200 cell-types at all timepoints.
7	Abstract	1	6	We discovered two large neuronal populations that wrap neuropils during development but die just before adulthood, as well as neuronal subtypes that partition dorsal and ventral visual circuits by differential Wnt signaling throughout development.
8	Abstract	1	7	Moreover, we showed that neurons of the same type but produced days apart synchronize their transcriptomes shortly after being produced.
9	Abstract	1	8	We also resolved during synaptogenesis neuronal subtypes that converge to indistinguishable transcriptomic profiles in adults while greatly differing in morphology and connectivity.
10	Abstract	1	9	Our datasets almost completely account for the known neuronal diversity of the optic lobes and serve as a paradigm to understand brain development across species.
11	[Introduction]	1	1	The optic lobes constitute two thirds of the fly brain with approximately 60,000 neurons per lobe and around 200 morphologically distinct neuronal types [3], [7-12].
12	[Introduction]	1	2	The visual information detected by the photoreceptors is integrated in its four neuropils: lamina, medulla, lobula and lobula plate (Fig.1a), which are each divided into ~750 columns, corresponding to the ~750 ommatidia in the compound eye.
13	[Introduction]	1	3	This highly parallel processing depends on neurons that are either present at a 1:1 ratio with the number of columns (unicolumnar neurons), or are present at a lower ratio but contact multiple columns to cover the entire visual map (multicolumnar neurons) [3], [7], [13].
14	[Introduction]	1	4	This modular structure in which the same cell types are present multiple times renders the system particularly amenable to single-cell sequencing studies that rely heavily on clustering of numerous cells of the same type.
15	[Introduction]	2	1	Most optic lobe neurons are produced continuously through larval and early pupal development from two crescent-shaped neuroepithelia called the Outer and Inner Proliferation Centers (OPC and IPC).
16	[Introduction]	2	2	Immediately after birth, neurons project their processes to build the columns and protolayers of all neuropils, which is completed by 30% of pupal development (P30) [14].
17	[Introduction]	2	3	Synapse formation commences around P45 and continues until eclosion [15].
18	[Introduction]	2	4	These processes are genetically hardwired [16] and appear to be strictly determined by the initial specification of neuronal identity as both the morphology of specific cell types and the identity of their synaptic partners are largely invariant [4].
19	[Introduction]	2	5	Although we have a good understanding of the molecular mechanisms that specify neuronal identity [17], it remains unclear how morphological and functional diversity is established and maintained throughout development and how brain wiring is achieved.
20	[Introduction]	2	6	Characterizing both the common and cell type-specific genetic programs implemented by neurons at different stages of their development is thus essential.
21	Developmental atlases of the optic lobe	1	1	The single-cell transcriptomic atlases of the adult Drosophila optic lobe previously generated by us [18] and others [19], or bulk sequencing of isolated cell types [18], [20], did not fully account for its cellular diversity.
22	Developmental atlases of the optic lobe	1	2	To produce an exhaustive catalog of neurons in the adult optic lobe (Fig1a-b), we obtained 109,743 single-cell transcriptomes (Methods) using the Chromium system (10x Genomics).
23	Developmental atlases of the optic lobe	1	3	We used the Seurat v3 integration pipeline [21] to remove batch effects between libraries (Extended Data Fig1a-b, Methods).
24	Developmental atlases of the optic lobe	1	4	The single-cell transcriptomes were clustered [21], [22] using parameters that optimized the biological significance of the resulting clusters.
25	Developmental atlases of the optic lobe	1	5	We then tested the statistical significance of the clusters and merged improperly separated clusters that did not display biologically significant differences in gene expression, resulting in 193 final clusters (Extended Data Fig1c-f, Suppl.
26	Developmental atlases of the optic lobe	1	6	Table 1, Methods).
27	Developmental atlases of the optic lobe	2	1	We identified 172 clusters as optic lobe neurons and 19 clusters as glia that were sharply separated within the hierarchical tree of the clusters (Extended Data Fig5a), and one cluster of low-quality transcriptomes (Extended Data Fig2, Suppl.
28	Developmental atlases of the optic lobe	2	2	Table 1, Methods).
29	Developmental atlases of the optic lobe	2	3	We annotated neuronal clusters by calculating the Pearson correlations between the average gene expression of each cluster and 52 published bulk-transcriptomes obtained from purified optic lobe neuronal types [18], [20] and 2 additional (Pm2 and T4) sequenced for this study (Methods).
30	Developmental atlases of the optic lobe	2	4	A clear match between a cell-type and a cluster should result in an obvious correlation gap between the best and second-best matches (Fig1c).
31	Developmental atlases of the optic lobe	2	5	We could thereby identify the corresponding clusters for 53 of these 54 neurons (Extended Data Fig3, Methods), with only one exception (LPi3-4).
32	Developmental atlases of the optic lobe	2	6	In addition, we identified the clusters corresponding to LC12, LC14, LC17, Pm1, T2a, TmY4, TmY8 and TmY14 neurons using the binarized expression (Methods) of combinations of protein markers identified by antibody or reporter line stainings (Extended Data Fig4, Suppl.
33	Developmental atlases of the optic lobe	2	7	Table 1).
34	Developmental atlases of the optic lobe	2	8	In summary, we were able to identify 61 of our 172 neuronal clusters (Fig1d).
35	Developmental atlases of the optic lobe	2	9	The relative size of the identified clusters was consistent with the known abundance of these cell types (Extended Data Fig5b).
36	Developmental atlases of the optic lobe	2	10	The very high resolution of this atlas is highlighted by the fact that we found distinct cluster matches even for rare neuronal types, such as Dm4 and Dm1 that are represented by only ~40 cells in each optic lobe [7].
37	Developmental atlases of the optic lobe	2	11	Thus, our dataset is likely to contain independent clusters for almost all neuron types present at more than 30 cells per optic lobe.
38	Developmental atlases of the optic lobe	2	12	This criterion is satisfied by all unicolumnar and most multicolumnar neuron types [7], i.e. >95% of the cells in our dataset.
39	Developmental atlases of the optic lobe	3	1	We next extended our single-cell atlas to developing neurons, sequencing optic lobe cells at five pupal stages (~30,000 cells each, Methods), covering all stages of neuronal differentiation (Fig1e).
40	Developmental atlases of the optic lobe	3	2	Because developing neurons most often lack marker genes or available bulk transcriptomes, we adopted a supervised approach to annotate these datasets (Fig1f).
41	Developmental atlases of the optic lobe	3	3	We first trained a two-layer neural network (NN) on our labeled adult dataset to classify P70 cells into corresponding adult clusters (Methods).
42	Developmental atlases of the optic lobe	3	4	This allowed us to sequence a lower number of cells at each pupal stage while retaining the high resolution of the adult dataset.
43	Developmental atlases of the optic lobe	3	5	Our method was able to resolve less abundant cell types that were grouped together by unsupervised clustering at P70 (Extended Data Fig6a-b).
44	Developmental atlases of the optic lobe	3	6	It was more robust in distinguishing closely related cell types than Seurat v3 label transfer (Methods, Extended Data Fig6c-d).
45	Developmental atlases of the optic lobe	3	7	However, supervised classifications are inherently unfit to identify new cell types.
46	Developmental atlases of the optic lobe	3	8	To overcome this drawback and assess the accuracy of NN classifications, we compared them to an unsupervised clustering of the P70 dataset and performed manual adjustments where appropriate (Methods).
47	Developmental atlases of the optic lobe	4	1	We then classified the earlier pupal datasets sequentially backwards throughout development (i.e. from P70 to P50, P50 to P40…).
48	Developmental atlases of the optic lobe	4	2	We used a multi-task extension of our NN (Fig1f) in order to prevent over-fitting the classifiers, due to the smaller sample sizes of the pupal datasets (Methods).
49	Developmental atlases of the optic lobe	4	3	At each stage, the NN classifications were also manually assessed and adjusted before proceeding to the next step.
50	Developmental atlases of the optic lobe	4	4	Interestingly, several adult clusters corresponded to two or more unsupervised clusters at earlier timepoints (Suppl.
51	Developmental atlases of the optic lobe	4	5	Table 1, Methods), which we discuss below.
52	Developmental atlases of the optic lobe	4	6	Using this iterative “classify-adjust-retrain” approach, we successfully assigned correspondences between pupal cells and each of our adult clusters (Extended Data Fig7).
53	Developmental atlases of the optic lobe	4	7	The final trained models are provided in Appendix 1 and can be used to annotate any scRNA-seq dataset containing optic lobe cells.
54	Developmental atlases of the optic lobe	4	8	As a benchmark, we tested our classifier on an atlas of the entire adult brain [19].
55	Developmental atlases of the optic lobe	4	9	The optic lobe cells were classified with high confidence and at a much higher resolution than in the original study, while the central brain neurons were clearly set aside as low confidence predictions (Methods, Extended Data Fig6e-f).
56	Developmental atlases of the optic lobe	5	1	Together, these data represent the first single-cell atlas of a complex central nervous structure at near complete saturation and throughout development.
57	Developmental atlases of the optic lobe	5	2	Coupled with the detailed knowledge of optic lobe connectivity through EM reconstruction [4-6] and the Drosophila genetic toolkit, this represents a unique resource to investigate general mechanisms underlying the function and development of neuronal circuits.
58	Developmental atlases of the optic lobe	5	3	In order to facilitate the exploration of our datasets, we provide summary tables of average gene expression, binarized gene expression, and differentially expressed genes for all our clusters at all stages in addition to the annotated objects with raw data (GEO: GSE142787).
59	Developmental atlases of the optic lobe	5	4	In addition, we provide a list of transcription factor (TF) markers that are maintained at all stages, whose combinations uniquely identify each neuronal cluster (Suppl.
60	Developmental atlases of the optic lobe	5	5	Table 2).
61	Discovery of Transient Extrinsic neurons	1	1	We identified two large neuronal clusters in the pupal datasets that received very low confidence scores from the NN classifier (indicating they may not exist in the adult dataset).
62	Discovery of Transient Extrinsic neurons	1	2	These two clusters strongly expressed the pro-apoptotic gene sickle at P70 (Extended Data Fig8a-b), suggesting that the corresponding cells die during late pupal stages.
63	Discovery of Transient Extrinsic neurons	1	3	They specifically expressed throughout development genes for the secreted protein Follistatin (Fs), the pro-secretory TF dimmed (dimm) [23] and the vesicular transporter portabella (prt) (Extended Data Fig8b-c).
64	Discovery of Transient Extrinsic neurons	1	4	R10D10(dimm)-Gal4 and Fs-Gal4 were expressed in pupae in two large sets of cells (Fig2b-d) that were also labeled by anti-Prt antibody (Extended Data Fig8d).
65	Discovery of Transient Extrinsic neurons	1	5	Their projections wrapped the dorsal and ventral edges of all optic lobe neuropils, except the lamina: each neuron possessed multiple branches that contacted (but did not enter) the neuropils at different points (Extended Data Fig8g-h).
66	Discovery of Transient Extrinsic neurons	1	6	These neurons could not be found in adults and cleaved Dcp1 staining, a readout of Caspase-3 activity, confirmed that they were gradually cleared through apoptosis during late pupal stages (Fig2b).
67	Discovery of Transient Extrinsic neurons	1	7	Activation of a FLEXAMP memory cassette [24] at L3 stage using R10D10-Gal4 (Extended Data Fig8e) confirmed that our failure to observe these neurons in adult brains was not due to downregulation of reporter expression.
68	Discovery of Transient Extrinsic neurons	1	8	Furthermore, expression of the anti-apoptotic protein p35 [25] caused the perdurance of these neurons in adult brains (Fig2b).
69	Discovery of Transient Extrinsic neurons	1	9	We thus named these cells transient extrinsic (TE) neurons.
70	Discovery of Transient Extrinsic neurons	2	1	Analysis of the genes differentially expressed between the two TE clusters revealed that only one of the clusters expressed Wnt4 while the other expressed Wnt10 (Fig5c).
71	Discovery of Transient Extrinsic neurons	2	2	Indeed, Wnt4-Gal4 was only expressed in the ventral cluster of TE neurons (Fig2e) that we named TEv, while the Wnt10^+ cluster was named TEd.
72	Discovery of Transient Extrinsic neurons	2	3	Although we never observed TE neurons contacting the lamina, Fs-Gal4 was also expressed at P30 in photoreceptors from one row of ommatidia at the edge of the retina that connect to the edges of the lamina (Fig2d) and are also apoptotically removed during development [26].
73	Discovery of Transient Extrinsic neurons	2	4	This suggests that Follistatin, an inhibitor of Activin signaling that has been implicated in regulating neuron growth [27], [28], is secreted at the edges of all neuropils by neurons that die before adulthood.
74	Discovery of Transient Extrinsic neurons	3	1	A third TE cluster, which we called TEe (early), could only be found at P15 and P30.
75	Discovery of Transient Extrinsic neurons	3	2	This cluster was connected to both TE clusters on UMAP visualization (Fig2a) and was bsh^+/hth^-.
76	Discovery of Transient Extrinsic neurons	3	3	In L3 optic lobes, we could observe a few Bsh^+/Hth^- cells labeled by R10D10-Gal4 at the tips of the OPC (Extended Data Fig8f), suggesting that TE cells are produced there (the only other Bsh^+ neurons are Hth^+ Mi1 [29]).
77	Discovery of Transient Extrinsic neurons	3	4	Bsh was also expressed in a subset of TE neurons at P30 (Extended Data Fig8g).
78	Discovery of Transient Extrinsic neurons	3	5	FLEXAMP memory cassette driven by bsh-Gal4 labeled all TE neurons (Extended Data Fig8i), confirming that TEe cluster contains younger bsh^+ TE neurons that lose bsh expression as they mature.
79	Discovery of Transient Extrinsic neurons	3	6	TE neurons expressing bsh were present in decreasing numbers until P50, but not at P70.
80	Discovery of Transient Extrinsic neurons	3	7	We therefore propose that TE neurons are produced continuously from a relatively small number of progenitors at the OPC tips.
81	Discovery of Transient Extrinsic neurons	4	1	The transient nature of TE neurons, their superficial innervations and enrichment in secretory markers are reminiscent of mammalian Cajal-Retzius cells [30] that are essential for neuronal migration and other developmental processes.
82	Discovery of Transient Extrinsic neurons	4	2	Further investigations will determine whether TE cells serve comparable functions in fly brain development (Supplementary Discussion).
83	Synchronization of serially born neurons	1	1	At larval stages, the IPC and medial OPC are progressively converted into neural stem cells (neuroblasts; NBs) that divide asymmetrically multiple times, each time self-renewing and producing a Ganglion Mother Cell (GMC), which in turn divides once to generate two neurons or glia [31].
84	Synchronization of serially born neurons	1	2	Similar to photoreceptors that are produced sequentially from the posterior to anterior of the eye imaginal disc, optic lobe neurons are also produced sequentially, with the first born neurons connecting to the most posterior photoreceptors while later born neurons connect to more anterior photoreceptors [32], [33],.
85	Synchronization of serially born neurons	1	3	This is also true in the lateral OPC, where Lamina Precursor Cells (LPC) are progressively converted into lamina monopolar neurons [34].
86	Synchronization of serially born neurons	1	4	As a result, neurons of the same types are produced days apart during development and the optic lobes contain neurons at various stages of their differentiation path.
87	Synchronization of serially born neurons	1	5	Accordingly, P15 neuronal clusters displayed ‘tails’ of differentiating cells (Fig3a, Extended Data Fig7f) that expressed several genes known to be transiently expressed by newborn neurons, including Hey [35], nerfin-1 [36], and zelda (vfl) [37] (Extended Data Fig9c).
88	Synchronization of serially born neurons	1	6	Moreover, whereas we could assign all P30-P70 cells directly to adult clusters (Extended Data Fig7a-e) except for TE neurons and a few glia-like cells that were not investigated further (Methods), we found six clusters with low confidence scores from the NN at P15 (Extended Data Fig9a).
89	Synchronization of serially born neurons	1	7	These clusters were identified by known markers (Extended Data Fig9b, Suppl.
90	Synchronization of serially born neurons	1	8	Table 1) as NBs, GMCs (3 clusters), LPCs and undifferentiated apoptotic neurons (Fig3a).
91	Synchronization of serially born neurons	1	9	On UMAP visualization, most P15 neuronal clusters converged towards the GMC and NB clusters while lamina monopolar cells L1-L4 converged specifically towards the LPC cluster (Fig3a).
92	Synchronization of serially born neurons	1	10	This suggests that the cluster tails are intermediate states between progenitors and differentiated neurons.
93	Synchronization of serially born neurons	1	11	Since these convergent tails containing very young neurons might often be mixtures of different cell types, we separated them from the mature neurons wherever possible (Methods) and assigned them an “immature” (Im) designation (Fig3a, Suppl.
94	Synchronization of serially born neurons	1	12	Table 1).
95	Synchronization of serially born neurons	2	1	Remarkably, these tails were not present at any of the later stages, when the clusters appeared homogenous despite containing neurons that were born more than 40 hours apart.
96	Synchronization of serially born neurons	2	2	To further investigate this phenomenon, we generated a UMAP plot containing only T1 and Tm3 neurons, combined from all stages with no batch correction (Extended Data Fig9d).
97	Synchronization of serially born neurons	2	3	Due to continuous production of the neurons of the same type in the optic lobe, a Tm3/T1 cell born at P0 in the P30 dataset would be the same age as a Tm3/T1 cell born at P10 in the P40 dataset.
98	Synchronization of serially born neurons	2	4	Thus, if neurons were to maintain age-dependent differences, cells of the same type would form a continuous trajectory across timepoints; however, they do not.
99	Synchronization of serially born neurons	2	5	Indeed, we observed this only between P15 and P30, whereas all other timepoints remained robustly separated.
100	Synchronization of serially born neurons	2	6	To rule out batch effects between different stages, we also directly assessed the homogeneity of the Tm3 cluster.
101	Synchronization of serially born neurons	2	7	Using Monocle 3 [38], we generated trajectories for Tm3 neurons at both P15 and P30 (Fig3b,d) and calculated marker genes that varied with pseudotime (Methods).
102	Synchronization of serially born neurons	2	8	Analysis of these markers clearly indicated that cells were indeed ordered by age at P15.
103	Synchronization of serially born neurons	2	9	For instance, nerfin-1 [36] was only expressed in the younger P15 cells (Fig3c) (and in almost no P30 cells), whereas expression of nicotinic Acetylcholine Receptor α7 peaked later and serotonin receptor 5-HT2A could only be observed in the most mature cells at P15 (Fig3c).
104	Synchronization of serially born neurons	2	10	On the other hand, all apparent sources of variation within the Tm3 cluster at P30 could be attributed to transcriptome quality, as measured by the percentage of mitochondrial UMIs observed (Fig3e).
105	Synchronization of serially born neurons	2	11	Therefore, the youngest (10-15 hours old) and the oldest (>3 days old) Tm3 cells were no longer distinguishable at P30.
106	Synchronization of serially born neurons	3	1	These data suggest that age information in neurons is lost within 15 hours or less after their birth, as they converge to a common transcriptomic state with older neurons of the same type.
107	Synchronization of serially born neurons	3	2	This generalizes observations previously made in photoreceptors [39], [40] (Supplementary Discussion), and implies that all brain wiring steps beyond initial neuropil targeting (i.e. axon pathfinding, Fig1e) are executed synchronously in the optic lobe.
108	Increased diversity at synaptogenesis	1	1	Both T4 and T5 neurons have 4 subtypes (a/b/c/d) that each processes motion in one of four cardinal directions [41].
109	Increased diversity at synaptogenesis	1	2	Their polarized dendritic arbors mirror their direction selectivity [6], [42].
110	Increased diversity at synaptogenesis	1	3	Unsupervised clustering reliably distinguished these 8 subtypes only at P50.
111	Increased diversity at synaptogenesis	1	4	However, supervised annotation and subclustering of T4-5 cells (Fig 4a, Methods) showed that a/b subtypes could be separated from c/d subtypes at all stages.
112	Increased diversity at synaptogenesis	1	5	Many of the P50 subcluster markers turned off or lost their specificity in adult brains (Extended Data Fig10a), explaining why T4-5 subtypes were transcriptionally indistinguishable in adult brains (Fig1d).
113	Increased diversity at synaptogenesis	1	6	GO analysis of these markers revealed exclusive enrichment for cell surface receptor terms involved in cell adhesion and axon/dendrite development (Extended Data Fig10b-c).
114	Increased diversity at synaptogenesis	2	1	In addition, Dm3 and Tm9 cells were split in two subgroups only at P50 and earlier stages (Extended Data Fig7).
115	Increased diversity at synaptogenesis	2	2	Subgroups of Tm9 have not been previously described (see last section), but Dm3 cells have two known sub-populations with orthogonal dendritic orientations [7].
116	Increased diversity at synaptogenesis	2	3	Immunostainings against Bifid (Bi or Omb), which was differentially expressed between the Dm3 subclusters, showed that the dendrites of the Bi^+ Dm3b cells were always oriented posterior-dorsally while those of Bi^- Dm3a cells were oriented posterior-ventrally (n>100, Fig4b).
117	Increased diversity at synaptogenesis	2	4	As Dm3 subtypes differentially expressed several cell surface molecules (CSM) during synapse formation, we asked whether they also differed in their connectivity.
118	Increased diversity at synaptogenesis	2	5	Analysis of the medulla connectome [4] revealed that the two Dm3 subtypes connect differentially to several postsynaptic partners (Extended Data Fig10d, Methods).
119	Increased diversity at synaptogenesis	2	6	Most notably, Dm3-Dm3 synapses were found almost exclusively between the different subtypes.
120	Increased diversity at synaptogenesis	2	7	Interestingly, Bi is also necessary and sufficient to specify the identity of T4-T5c/d subtypes that have dendrites with orthogonal directionality to those of T4-T5a/b neurons [43].
121	Increased diversity at synaptogenesis	2	8	Thus, bi may specify subtypes with orthogonal dendritic orientations in neurons that have completely different origins and properties.
122	Increased diversity at synaptogenesis	3	1	Attempting to project Dm3 or Tm9 subdivisions onto adult clusters by training binary classifiers on the P50 cells (Methods) proved very unreliable with out-of-bag errors (OOBE, Methods) >20%.
123	Increased diversity at synaptogenesis	3	2	Consistently, the number of differentially expressed genes between subgroups peaked around P50 and dropped sharply thereafter (Extended Data Fig10e).
124	Increased diversity at synaptogenesis	3	3	Even though T4/T5, Dm3 and Tm9 may represent extreme cases, this increased transcriptional diversity during synapse formation is indeed a general phenomenon: Pearson correlations between the average gene expression profiles of clusters that are most similar to each other were significantly lower between P40-P70, across all neuronal clusters (Fig4c).
125	Increased diversity at synaptogenesis	3	4	These results generalize the previous findings that olfactory projection neurons VA1d and DC3 are transcriptionally distinct during development but merge into a single cluster in adults [44].
126	Increased diversity at synaptogenesis	3	5	They also call into question the common practice of cell-type identification based solely on adult transcriptomes and advocate for developmentally based approaches.
127	Increased diversity at synaptogenesis	4	1	To investigate why neuronal types are more easily distinguishable during development, we performed GO analysis of the neuronal cluster markers at each stage.
128	Increased diversity at synaptogenesis	4	2	This consistently revealed at all stages overwhelming enrichment for receptor binding/activity terms related to axon/dendrite development and synapse formation, followed by TF and ion channel terms (Extended Data Fig11a).
129	Increased diversity at synaptogenesis	4	3	If different neurons are distinguished largely by CSMs at all ages, what is the origin of the increased diversity we observe at mid-pupal stages?
130	Increased diversity at synaptogenesis	4	4	We performed GO analysis on ‘stage markers’, i.e. genes that were upregulated in neurons at a particular time point as compared to all other stages (Methods, Extended Data Fig11b).
131	Increased diversity at synaptogenesis	4	5	CSM terms involved in synaptogenesis and membrane potential were particularly upregulated around P50-70 (Fig4d-e), explaining the increased diversity at these stages.
132	Increased diversity at synaptogenesis	4	6	In contrast, early pupal markers were dominated by protein synthesis and adult markers by energy metabolism terms.
133	Increased diversity at synaptogenesis	4	7	This suggests that, as a general principle, the upregulation of CSMs necessary to enable synaptic specificity around P50 (Fig1e) causes a peak of transcriptional diversity.
134	Increased diversity at synaptogenesis	4	8	This diversity is not maintained later, especially between subtypes that perform highly related functions and only differ based on their connectivity.
135	Increased diversity at synaptogenesis	4	9	Moreover, P40 was enriched in molecular terms related to nuclear hormone receptor, driven by ecdysone-responsive TFs, suggesting that global activation of a hormonal switch triggers the upregulation of cell-type specific CSMs at the onset of synaptogenesis (Supplementary discussion).
136	Dorsoventral division of visual circuits	1	1	Differential gene expression analysis between the two Tm9 subgroups at P50 indicated that one of them exclusively expressed Wnt4 while the other expressed Wnt10, similarly to TEv/d neurons.
137	Dorsoventral division of visual circuits	1	2	Since Wnt4-Gal4 expression overlapped only with ventral Tm9s (Fig5a), we named these subtypes Tm9v (Wnt4^+) and Tm9d (Wnt10^+).
138	Dorsoventral division of visual circuits	1	3	Sparse labeling of individual Tm9 neurons did not reveal any obvious morphological differences between these subtypes (Extended Data Fig12a).
139	Dorsoventral division of visual circuits	1	4	However, differential expression of several cell adhesion molecules at P50 raise the possibility that they differ in their connectivity.
140	Dorsoventral division of visual circuits	1	5	Even though these subtypes were statistically mostly indistinguishable in P70 and adult datasets, Wnt4 and Wnt10 expression were found in separate parts of the same cluster on the tSNE (Fig5c).
141	Dorsoventral division of visual circuits	1	6	We also noticed that Wnt4-Gal4 expression was restricted to the ventral photoreceptors R7/R8 in pupae, but not in adult (Fig5a-b, Extended Data Fig12b-c).
142	Dorsoventral division of visual circuits	1	7	Therefore, both the receptive visual field and its downstream circuitry are partitioned by differential Wnt signaling during development.
143	Dorsoventral division of visual circuits	2	1	Flying insects are exposed to very different stimuli in their ventral vs. dorsal visual fields (ground vs. sky) that may need to be processed differently: Dorsoventral asymmetries could be a fundamental adaptation to flight since they have been described in the retinas of flies, butterflies, dragonflies and honeybees (reviewed in [45]).
144	Dorsoventral division of visual circuits	2	2	Our findings expand these differences to the downstream circuitry.
145	Dorsoventral division of visual circuits	2	3	In addition to the cell-autonomous differences during development that could enable these cells to connect with different synaptic partners, secreted Wnt ligands could differentially affect development and function of other neurons in ventral and dorsal parts of the brain (Supplementary Discussion).
146	Dorsoventral division of visual circuits	3	1	Finally, we tested whether the differential expression of Wnt4 vs.
147	Dorsoventral division of visual circuits	3	2	Wnt10 observed in TE, Tm9 and R7/R8 neurons applied to other seemingly homogeneous neuronal types (Methods).
148	Dorsoventral division of visual circuits	3	3	We found two other neurons with dorsoventral asymmetries: Tm4 neurons and the unidentified cluster 62 could be separated into Wnt4^+ and Wnt10^+ populations, with only ventral Tm4 neurons overlapping with Wnt4-Gal4 expression (Extended Data Fig12d-e).
149	Dorsoventral division of visual circuits	3	4	For both Tm4 and cluster 62, Wnt4^+ and Wnt10^+ cells remained separated on the tSNE (Fig5c) but were highly similar: artificially separating them yielded an average OOBE across all stages around 25%.
150	Dorsoventral division of visual circuits	3	5	Despite this similarity, Wnt4^+ and Wnt10^+ neurons differentially expressed several genes throughout development (Extended Data Fig12f).
151	Dorsoventral division of visual circuits	3	6	Interestingly, both Tm4d and Tm9d specifically expressed the serotonin receptor 5-HT1A in adult (Fig5d), raising the possibility that neuromodulatory signals are processed differently in ventral vs. dorsal visual circuits.
152	Conclusions	1	1	We present here the first scRNA-seq dataset reaching near complete saturation of any complex nervous system throughout its development.
153	Conclusions	1	2	Coupled with the available optic lobe connectomes [4], [6], this will provide an important resource for functional studies of adult neurons as well as for the identification of new mechanisms involved in circuit formation.
154	Conclusions	1	3	Our analyses revealed two intriguing populations of pupae-specific neurons that share many characteristics with the mammalian Cajal-Retzius cells and could be involved in neuropil development (Extended Data Fig9e).
155	Conclusions	1	4	We made several observations with important implications on how neural circuits are built (Extended Data Fig9f): We described the convergence of neuronal transcriptomes of the same type and generalized previous observations of increased transcriptomic diversity in neurons during development to the entire optic lobe circuit.
156	Conclusions	1	5	We showed that this is due to a transient upregulation of cell-type specific CSMs involved in synapse formation, which explains how neurons with indistinguishable transcriptomes in adult brains could nevertheless serve different functions due to their developmental history.
157	Conclusions	1	6	Lastly, we demonstrated that ventral and dorsal visual circuits are subjected to differential Wnt signaling, providing potential mechanisms for differential processing of ground vs. sky inputs, in extension of the asymmetries described in the retinas of several flying invertebrates.
158	Methods; Genetics	1	1	All sequencing experiments in this study were performed with female D. melanogaster Canton-S maintained at 18-25°C (unless indicated otherwise) and dissected within 3 days of eclosion (adult dissections) or selected at P0 (white pupae) and maintained at 25°C until the required stage (pupal dissections).
159	Methods; Genetics	1	2	Flies for the other experiments were maintained in the same way but were not selected for gender.
160	Methods; Genetics	1	3	Origin of all individual stocks is detailed in Supplementary Table 3.
161	Methods; Genetics	2	1	Following final genotypes were used for the imaging experiments: Dm3 sparse labeling: hsFLP22/+; CyO/+; R25F07-Gal4/UAS-FSF-CD4-tdGFP.
162	Methods; Genetics	2	2	TE neuron labeling: 10xUAS-myr:GFP/+; R10D10-Gal4/+ or Fs-Gal4/+; UAS-CD4:tdGFP.
163	Methods; Genetics	2	3	Suppression of apoptosis in TE neurons: UAS-P35/+; UAS-myr-GFP/+; R10D10-Gal4/+.
164	Methods; Genetics	2	4	TE neuron FLEXAMP: UAS-Flp; Gal80^ts/Cyo; Act>y+>LexA, LexAop-myr:GFP/R10D10-Gal4.
165	Methods; Genetics	2	5	Bsh FLEXAMP: UAS-Flp; Gal80^ts/Cyo; Act>y+>LexA, LexAop-myr:GFP/Bsh-Gal4 TE neuron sparse labeling: hsFLP2:PEST/+; UAS-FSF-CD4:tdGFP/+; R10D10-Gal4/+.
166	Methods; Genetics	2	6	Tm9 sparse labelling: hsFLP2:PEST; UAS-FSF-CD4:tdGFP/R72F01-p65AD; R82F10-Gal4DBD/TM6B or MKRS.
167	Methods; Genetics	2	7	Wnt4-Gal4 and Tm9-LexA co-expression experiments: 10xUAS-IVSmCD8:RFP,13xLexAop2-mCD8:GFP; R82F10-LexA/Wnt4-Gal4; +/TM2.
168	Methods; Genetics	2	8	Tm4-Gal4 and aop co-expression:;10xUAS-myr:GFP; R35H01-Gal4.
169	Methods; Genetics	2	9	PR stainings: Wnt4-Gal4, UAS-myr:GFP/Cyo; Tm2/Tm6B.
170	Methods; Genetics	2	10	TmY4 labeling: Ac76E-LexA, P3-RFP/CyO; LexOpCD2-GFP/TM2.
171	Methods; Genetics	2	11	TmY8 sparse labeling: pBPhsFlp2::PEST;; HA_V5_FLAG/CG42458-Gal4.
172	Methods; Genetics	2	12	TmY14 labeling: 10xUAS-myr:GFP; R24F10-Gal4.
173	Methods; Genetics	2	13	LC12 labeling:; 10xUAS-myr:GFP/R35D04-p65.
174	Methods; Genetics	2	14	AD; R55F01-GAL4.
175	Methods; Genetics	2	15	DBD/+.
176	Methods; Genetics	2	16	LC17 labeling;; 10xUAS-myr:GFP/+; R92G12-Gal4/+ or; 10xUAS-myr:GFP/R21D03-p65.
177	Methods; Genetics	2	17	AD; R65C12-GAL4.
178	Methods; Genetics	2	18	DBD/+.
179	Methods; Genetics	2	19	Beat-1c expression:; beat 1c MI01467-T2A Gal4/Cyo; 20xUAS 6xGFP/TM6b.
180	Methods; Genetics	2	20	Kn expression:; 10xUAS-myr:GFP/ Mi-Trojan-GAL4.2-kn[MI15480-TG4.2];.
181	Methods; Single-cell RNA sequencing; Sample Preparation	1	1	Fly brains were dissected in ice-cold Schneider’s Insect Medium (SIM, Gibco) and incubated at 25°C for 1.5 hours (adult brains) or 30 minutes (pupal brains) in a dissociation solution of SIM with 2mg/mL Collagenase (Sigma) and 2mg/mL Dispase (Sigma).
182	Methods; Single-cell RNA sequencing; Sample Preparation	1	2	Towards the end of incubation, we placed all appropriate reagents (as indicated in the Chromium™ Single Cell 3’ Reagent Kits v2 User Guide - Rev D) to equilibrate at room temperature.
183	Methods; Single-cell RNA sequencing; Sample Preparation	1	3	We then washed once the whole brains with ice-cold SIM, separated the optic lobes, washed them 3 times with ice-cold Dulbecco’s Phosphate-Buffered Saline (DPBS, without calcium & magnesium, Corning/Fisher) + 0.04% Bovine Serum Albumin (BSA, Sigma), and transferred them into a low-bind tube on ice (150 μL ice-cold DPBS + 0.04% BSA for 12 optic lobes).
184	Methods; Single-cell RNA sequencing; Sample Preparation	1	4	We dissociated the optic lobes by vigorously pipetting up and down the content of the tube 2×50 times, resting the cells on ice for 1 minute in between.
185	Methods; Single-cell RNA sequencing; Sample Preparation	1	5	We then observed the cell suspension under a standard dissecting microscope and pipetted the suspension up to 50 times more, until no large chunks could be seen.
186	Methods; Single-cell RNA sequencing; Sample Preparation	1	6	Limiting the number of pipetting repetitions increased the number of cells recovered and limited the amount of ambient RNA released from damaged cells into the media.
187	Methods; Single-cell RNA sequencing; Sample Preparation	1	7	We then passed the cell suspension through a 20 μm strainer (pluriSelect).
188	Methods; Single-cell RNA sequencing; Sample Preparation	1	8	In order to process the cells as quickly as possible, one experimenter then estimated the concentration of an aliquot of the cell suspension with 1/2000 Hoeschst, using an epifluorescent microscope and a 0.02 mm deep cytometer, while the second experimenter proceeded with the preparation of the microfluidic chip.
189	Methods; Single-cell RNA sequencing; Sample Preparation	2	1	All adult brains were dissected between 9-12am.
190	Methods; Single-cell RNA sequencing; Sample Preparation	2	2	Two adult experiments also included male flies; these cells were removed from the dataset in downstream analysis.
191	Methods; Single-cell RNA sequencing; Sample Preparation	2	3	Incubating the entire brains in the dissociation solution and removing the optic lobes afterwards improved the quality of the sequenced transcriptomes (number of genes recovered, proportion of UMIs from mitochondrial genes) compared to direct dissection of the optic lobes.
192	Methods; Single-cell RNA sequencing; Sample Preparation	2	4	We chose to neither centrifuge the dissociated cells and wash the pellets nor isolate cells from debris by FACS.
193	Methods; Single-cell RNA sequencing; Sample Preparation	2	5	While this could have reduced the amount of ambient RNA sequenced, by further lengthening the protocol these additional steps might have affected gene expression, increased batch effects, or created sampling biases affecting the frequency of sequenced cell types due to differential size or fragility.
194	Methods; Library preparation, sequencing and processing	1	1	Droplet-based purification, amplification and barcoding of single-cell transcriptomes were performed using Chromium™ Single Cell 3’ Reagent Kit v2 (10X Genomics) as described in the manufacturer’s manual (Rev D), with a target recovery of 7,000 cells per experiment.
195	Methods; Library preparation, sequencing and processing	1	2	We prepared 15 libraries from adult brains, 5 libraries each from P15, P30 and P70 brains and 4 libraries each from P40 and P50 brains.
196	Methods; Library preparation, sequencing and processing	1	3	The libraries were subjected to paired-end sequencing (26×8×98) with Illumina NextSeq 550 (Genomics Core at NYU CGSB) or NovaSeq 6000 (Genome Technology Center at NYU Langone Health) to on average 50,000 reads per cell sequenced (i.e. 350,000,000 reads for a 7,000 cells experiment).
197	Methods; Library preparation, sequencing and processing	2	1	We mapped the sequenced libraries to the D. melanogaster genome assembly BDGP6.88 using CellRanger 2.1.0 for the adult stage and 3.0.1 for the pupal stages.
198	Methods; Library preparation, sequencing and processing	2	2	We kept all cell barcodes with 1,000 to 20,000 UMIs and less than 10% of UMIs corresponding to mitochondrial genes.
199	Methods; Library preparation, sequencing and processing	2	3	Note that the incorporation of EmptyDrops algorithm in CellRanger v3 excluded further cells with >1000 UMIs predicted to contain only ambient RNA for pupal datasets.
200	Methods; Library preparation, sequencing and processing	2	4	In addition, for the two experiments that included male cells at the adult stage, we removed all cell barcodes with at least one UMI of any of the genes of the male-specific lethal (MSL) complex (msl-1, msl-2, msl-3, mof, mle, roX1, roX2).
201	Methods; Library preparation, sequencing and processing	2	5	These single-cell transcriptomes are provided in Adult_male.rds (GSE142787).
202	Methods; Library preparation, sequencing and processing	2	6	Lastly, we kept only the genes that were expressed in at least 3 cells across all experiments of a given stage for further analysis.
203	Methods; Library preparation, sequencing and processing	2	7	After processing, the adult dataset comprised 109,743 cells passing quality filters, with a median of 1805 UMIs and 903 genes per cell.
204	Methods; Library preparation, sequencing and processing	2	8	The pupal dataset comprised 31,036 cells passing quality control filters at P15, 35,758 cells at P30, 24,084 cells at P40, 31,340 cells at P50 and 43,740 cells at P70.
205	Methods; RNA sequencing of FACS-sorted cell types	1	1	We crossed the Gal4 lines specific for individual cell types (Pm2-Gal4 (Bl stock no.
206	Methods; RNA sequencing of FACS-sorted cell types	1	2	50240), T4-Gal4 (VT stock no. 37588)) as well as pan-neuronal marker line (Elav-Gal4) and pan-glial marker line (Repo-Gal4) to UAS-Red Stinger to fluorescently label nuclei of individual cell types, sort and sequence them as previously described [18].
207	Methods; RNA sequencing of FACS-sorted cell types	1	3	Briefly, we first dissected adult optic lobes, then dissociated tissue while maintaining cell viability and finally, sorted cells by FACS (Facs Aria III) based on their differences in fluorescence intensity and cell size.
208	Methods; RNA sequencing of FACS-sorted cell types	1	4	RNA was extracted using the Arcturus PicoPure RNA Isolation Kit (Applied Biosystems) and the Smart-Seq v4 Ultra Low Input RNA Kit (Clontech) was used to generate full-length double stranded cDNA with 300 to 500 pg of total RNA input.
209	Methods; RNA sequencing of FACS-sorted cell types	1	5	The quality of RNA and cDNA was assessed by Bioanalyzer using RNA 6000 Pico and High sensitivity DNA assay (Agilent) respectively.
210	Methods; RNA sequencing of FACS-sorted cell types	1	6	Libraries were prepared using Nextera XT DNA Library Prep Kit (Illumina) and run on the Illumina HiSeq 2500 (CGSB at NYUAD).
211	Methods; RNA sequencing of FACS-sorted cell types	1	7	Three barcoded libraries were pooled per sequencing lane and paired-end 100 bp reads were generated.
212	Methods; RNA sequencing of FACS-sorted cell types	1	8	Sequences were mapped to the Drosophila melanogaster genome (BDGP6.81) using TopHat2 (v2.1.0).
213	Methods; RNA sequencing of FACS-sorted cell types	1	9	We obtained three biological replicates for each library.
214	Methods; Antibody generation	1	1	Polyclonal antibodies against Bsh, Hth, Dichaete and Vvl were generated by Genscript (https://www.genscript.com/).
215	Methods; Antibody generation	2	1	The epitope used to immunize the rabbits was the full length Bsh protein:
216	Methods; Antibody generation	3	1	MAMLNEASLS PADAHAHANA TTPTHSKAAA MASATTMLTT KTPFSIEHIL FQNLNSASNN NNSSDTNGIA ANTNNYAPKS SRNAVKSARS AFAHDNNPHK HPSQHSHPPQ SHPPASASAS ATATARSNQA ASGYAGEDYG KSMHSTPRSN HHSRHGTSHY NGDQISQQLG SGAAQHPPVP TTQPQPPPPP PLNGGSGASN GVLYPNAPYT DHGFLQMTLG YLSPSSGTYK SVDPYFLSQA SLFGGAPFFG APGCVPELAL GLGMGVNALR HCRRRKARTV FSDPQLSGLE KRFEGQRYLS TPERVELATA LGLSETQVKT WFQNRRMKHK KQLRRRDNAN EPVDFSRSEP GKQPGEATSS SGDSKHGKLN PGSVGGTPTQ PTSEQQLQMC LMQQGYSTDD YSDLEADSGD EDNSSDVDIV GDAKLYQLT
217	Methods; Antibody generation	4	1	The epitope used to immunize the guinea pigs were the following amino acids of the Hth-PC isoform:
218	Methods; Antibody generation	5	1	HGYHSGAGGHGTPSHVSPVGNHLMGAIPEVHKRDKDAIYEHPLFPLLALIFEKCELATCTPREPGVQGGDVCSSESFNEDIAMFSKQIRSQKPYYTADPEVDSLMVQAIQVLRFHLLELEKVHELCDNFCHRYISCLKGKMPIDLVIDERDTTKPPELGSANGEGRSNADSTSHTDGASTPDVRP
219	Methods; Antibody generation	6	1	The epitope used to immunize the guinea pigs were the following amino acids of Vvl:
220	Methods; Antibody generation	7	1	EVSVKGALEQHFHKQPKPSAQEITSLADSLQLEKEVVRVWFCNRRQKEKRMTPPNTLGGDMMDGMPPGHMHHGGYHPHHDMHGSPMGTHSHSHSPPMLSPQNMQSSAVAAHQLAAH
221	Methods; Antibody generation	8	1	The epitope used to immunize the guinea pigs were the following amino acids of Dicheate:
222	Methods; Antibody generation	9	1	SLATSPGQEGHIKRPMNAFMVWSRLQRRQIAKDNPKMHNSEISKRLGAEWKLLAESEKRPFIDEAKRLRALHMKEHPDYKYRPRRKPKNPLTAGPQGGLQ
223	Methods; Antibody generation	10	1	Polyclonal antibody against Toy was generated by Thermo Scientific, using an epitope with the following amino acids to immunize rabbits:
224	Methods; Antibody generation	11	1	MRTQRRSADTVDGSGRTSTANNPSGTTASSSVATSNNSTPGIVNSAINVAERTSSALVSN SLPEASNGPTVLGGEANTTHTSSESPPLQPAAPRLPLNSGFNTMYSSIPQPIATMAENYN SSLGSMTPSCLQQRDAYPYMFHDPLSLGSPYVSAHHRNTACNPSAAHQQPPQHGVYTNSS PMPSSNTGVISAGVSVPVQISTQNVSDLTGSNYWPRLQ
225	Methods; Immunohistochemistry	1	1	Brains were dissected in ice-cold SIM, fixed in 3.7% formaldehyde (in PBS) at room temperature for 30-50 minutes, washed in PBST (PBS + 0.3% Triton X-100) and incubated for an hour in blocking solution (PBST + 5% horse serum), which we also used to dilute all primary and secondary antibody solutions.
226	Methods; Immunohistochemistry	1	2	They were incubated in primary antibodies for 1 or 2 days at 4°C, washed three times in PBST for 10 minutes and then incubated in secondary antibodies at 4°C overnight followed by washing in PBST again 3×10min.
227	Methods; Immunohistochemistry	1	3	They were then mounted in Slowfade and imaged with a Leica SP8 confocal microscope using a 20x (NA=0.75) or a 63x (NA=1.3) glycerol objective.
228	Methods; Immunohistochemistry	1	4	Images were processed with ImageJ or Imaris.
229	Methods; Immunohistochemistry	2	1	The following primary antibodies were used: Polyclonal rabbit anti-RFP (1:500), Polyclonal rabbit anti-cleaved Dcp-1 Antibody (1:100). sheep anti-GFP (1:200), chicken anti-GFP (1:100), Rabbit anti-PRT (1/100), rabbit anti-GFP (1:250), mouse anti-aop (1:100), rat anti-NCad (1:20), rabbit anti-Bi (1:400), mouse anti-Chaoptin (1:50), rabbit anti-Bsh (1:1800), guinea pig anti-Hth (1:100), rabbit anti-Dve (1:250), mouse anti-Cut (1:20), mouse anti-Acj6 (1:20), rabbit anti-Toy (1:250), rat anti-FLAG (1:200), guinea pig anti-Dichaete (D) (1:50), guinea pig anti-Vvl (1:100), mouse anti-Dac (1:20), mouse anti-Brp (nc82) (1:30).
230	Methods; Immunohistochemistry	3	1	The following secondary antibodies (all donkey, used at 1:400) were used: anti-sheep Alexa 488, anti-chicken Alexa 488, anti-rabbit Alexa 488, anti-rabbit Cy3, anti-mouse Cy3, anti-rat Alexa 555, anti-rat Alexa 647, anti-guinea pig Alexa 488, anti-guinea pig Alexa 647, anti-guinea pig Cy3, anti-rat Alexa 405, anti-rabbit Alexa 647, anti-mouse Alexa 647.
231	Methods; Immunohistochemistry	4	1	Origin of all antibodies used is detailed in Supplementary Table 3.
232	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	1	1	We used the procedure implemented in Seurat v3 [21] to remove batch effects from our sequenced libraries.
233	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	1	2	Briefly, it uses Canonical Correlation Analysis to project the libraries in a low dimensional space where their correlation is maximized.
234	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	1	3	This keeps the variation shared between the libraries (biological variation) and removes the variation specific to each library (technical variation).
235	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	1	4	The cells from different libraries that are mutual nearest neighbors in this shared low dimensional space are then used as anchors to calculate a matrix of ‘integrated’ gene expression, using the 2,000 most variable genes of the dataset, whose expression is corrected for batch-effect and used for downstream analysis.
236	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	1	Using default parameters in Seurat 3.0.0.9000, we first normalized (NormalizeData) independently each sequenced library of a given stage and extracted their 2000 most variable features (FindVariableFeatures).
237	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	2	For the adult stage, we then used the functions FindIntegrationAnchors, IntegrateData, ScaleData and RunPCA with default parameters, except for the dimensionality for which we tried the values 100, 150 and 200.
238	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	3	To compare the results, we assessed how much the integrated dataset conserves the structure its individual libraries had before integration using the Seurat function LocalStruct with default parameters.
239	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	4	This function counts, for each cell of a given library, how many of its 100 closest neighbors in this library are similar before and after integration.
240	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	5	This is done and averaged for all libraries.
241	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	6	The results obtained were 74%, 81% and 75%, respectively.
242	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	7	We therefore chose a dimensionality of 150 for the adult dataset.
243	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	8	This procedure conserved the local structure of each dataset, as the cells shared on average 81% of their closest neighbors before and after integration, and efficiently removed the batch effects, as our final adult clusters contained a uniform distribution of cells from each original library (Extended Data Fig1b).
244	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	9	Lastly, we used a dimensionality of 100 for all pupal datasets due to their smaller sizes.
245	Methods; Data Analysis and Statistics; Integration of scRNA-Seq libraries	2	10	The values obtained with the LocalStruct function were P70 = 81% / P50 = 76% / P40 = 83% / P30 = 82% / P15 = 88%.
246	Methods; Data Analysis and Statistics; Clustering of the datasets	1	1	We used Seurat 3.0.0.9000 to cluster our integrated single-cell transcriptomes to identify groups of cells with similar gene expression patterns.
247	Methods; Data Analysis and Statistics; Clustering of the datasets	1	2	For the adult dataset we used the functions FindNeighbors and FindClusters with default parameters except for the number of principal components (PCs), which are used to reduce the dataset dimensionality and calculate the distance between all pairs of cells, and the resolution, which is used to compensate for the tendency of modularity optimization algorithms to merge small clusters.
248	Methods; Data Analysis and Statistics; Clustering of the datasets	1	3	Small resolution values favor big clusters, and high values favor small clusters but tend to artificially split large clusters (which can be corrected for by subsequent analysis).
249	Methods; Data Analysis and Statistics; Clustering of the datasets	1	4	We therefore performed a grid search of 90 different combinations of parameters aimed to optimize the biological significance of the resulting clusters.
250	Methods; Data Analysis and Statistics; Clustering of the datasets	2	1	We varied the PC number between 100 and 200 (with a step size of 20), and the resolution between 1 and 15 (step size of 1), which yielded between 146 and 229 clusters (Extended Data Fig1c).
251	Methods; Data Analysis and Statistics; Clustering of the datasets	2	2	We assessed the biological significance of the clusters obtained with each pair of clustering parameters by using 54 log-normalized bulk-transcriptomes obtained from purified optic lobe neuronal types: 52 published before [18], [20] and 2 additional (Pm2 and T4) sequenced for this study.
252	Methods; Data Analysis and Statistics; Clustering of the datasets	2	3	For each purified neuronal-type transcriptome, we calculated the Pearson correlation with the average log-normalized non-integrated gene expression of each cluster, using the list of the most variable genes found during the clustering step.
253	Methods; Data Analysis and Statistics; Clustering of the datasets	2	4	We then ranked the clusters by decreasing value of Pearson correlation.
254	Methods; Data Analysis and Statistics; Clustering of the datasets	2	5	If a cluster has a much higher correlation value than the others, the cells from this cluster are very likely to belong to this neuronal type.
255	Methods; Data Analysis and Statistics; Clustering of the datasets	2	6	If several clusters have a much higher correlation value than the others, they might correspond to similar cell types or to an abundant cell type artificially separated in several clusters (i.e. “overclustering”).
256	Methods; Data Analysis and Statistics; Clustering of the datasets	2	7	Thus, we counted for each pair of clustering parameters how many of the 54 isolated neuronal-types match to 1 to 5 clusters (i.e. we tested for the 6 best-correlated clusters for each neuronal type whether the difference in correlation value between a cluster and the subsequent one was higher than 0.05).
257	Methods; Data Analysis and Statistics; Clustering of the datasets	2	8	The results are presented in Extended Data Figure 1d.
258	Methods; Data Analysis and Statistics; Clustering of the datasets	2	9	Increasing the number of PCs decreased this estimate of the biological significance, probably because too many non-relevant principal components dilute the important information, as does increasing too much the resolution parameter.
259	Methods; Data Analysis and Statistics; Clustering of the datasets	2	10	We chose the pair of clustering parameters (120 PCs and 10 resolution) that maximized both our estimation of biological significance and the number of clusters obtained, which resulted in 208 clusters.
260	Methods; Data Analysis and Statistics; Clustering of the datasets	3	1	For clustering the pupal datasets, we also used 120 PCs but a lower resolution of 6 due to their smaller size.
261	Methods; Data Analysis and Statistics; Clustering of the datasets	3	2	We obtained 147 clusters from the P70 dataset, 137 clusters in P50, 135 clusters in P40, 145 clusters in P30 and 134 clusters in P15.
262	Methods; Data Analysis and Statistics; Clustering of the datasets	3	3	We did not perform additional parameter tuning for either integration or clustering of these datasets, nor did we comprehensively assess the quality of these unsupervised clusters (as we do below for adult), because the pupal datasets were primarily annotated in a supervised manner using log-normalized non-integrated expression matrices.
263	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	1	Because keeping small clusters separate using a modularity optimization algorithm results in artificially splitting large clusters [46], before annotation of the adult dataset we merged all pairs of clusters that were improperly separated (Extended Data Fig1e-f).
264	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	2	To do so, we first built a tree grouping the clusters based on the similarity of their average log-normalized non-integrated gene expression, using the Seurat v2 function BuildClusterTree.
265	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	3	For each node, we then trained a random-forest model using the Seurat v2 function AssessNodes to predict to which branch of the node a given cell should be assigned.
266	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	4	The accuracy of the model is measured by the out of bag error (OOBE), which is similar to the percent of cells misclassified by the model.
267	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	5	If a node arbitrarily separates the cells, the random-forest model will not be able to “learn” this split and the OOBE will be high.
268	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	6	Thus, we merged all pairs of clusters connected to a node for which the random-forest model prediction differed from the actual clustering with an OOBE > 5%, and if the two clusters did not have clearly differentially expressed genes.
269	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	7	To do so, we calculated their cluster markers and decided whether to merge the clusters on a case by case basis based on the number of genes differentially expressed, the p-values, and the identity of these genes.
270	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	8	Importantly, most of the merged clusters either matched to the same cell type during the annotation step (see below) and/or were clearly containing a different proportion a low-quality transcriptomes (i.e. the merged clusters differed not by gene expression but by their content of cells with high levels of mitochondrial genes, or low number of UMI/genes expressed).
271	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	9	Lastly, although this is unlikely, we cannot entirely discard the possibility that merged clusters correspond to real neuronal subtypes.
272	Methods; Data Analysis and Statistics; Statistical significance of the clusters	1	10	They are thus still accessible to study in our adult dataset since the metadata field ‘Clustering’ contains the initial unsupervised clusters identities.
273	Methods; Data Analysis and Statistics; Statistical significance of the clusters	2	1	Similarly, we used the Seurat v2 function BuildClusterTree on the T4/T5 subtypes (Extended Data Fig10), and the function AssessNodes to evaluate the statistical significance of the separation between several pairs of cluster throughout this study (Dm3a/b, Tm9v/d, Tm4v/d, cluster 62 Wnt4^+/Wnt10^- and Wnt4^-/Wnt10^+ cells) and during the process of annotating the pupal stages (see below).
274	Methods; Data Analysis and Statistics; Statistical significance of the clusters	2	2	Lastly, we used the Seurat 3.1.0 function BuildClusterTree to produce Extended Data Fig5a.
275	Methods; Data Analysis and Statistics; Differential gene expression analysis	1	1	All differential gene expression analysis of this study was done using the FindAllMarkers function in Seurat 3.0.0.9000 or 3.1.0 with default parameters (two-sided Wilcox rank sum test) to find positive markers, on log-normalized non-integrated gene expression.
276	Methods; Data Analysis and Statistics; Differential gene expression analysis	1	2	We then selected the 5, 10 or 20 highest most differentially expressed genes based of their log fold-change (called top5-20 cluster markers), in either all clusters (when not indicated), a subset of them (when indicated) or two subpopulations of cells from the same cluster (when indicated).
277	Methods; Data Analysis and Statistics; Differential gene expression analysis	2	1	Cluster_markers.xlsx (GSE142787) contains the differentially expressed genes for each stage, calculated as explained above using all clusters.
278	Methods; Data Analysis and Statistics; Differential gene expression analysis	2	2	It also includes a ‘curated’ version of these genes, in which we kept only the differentially expressed genes with an adjusted p-value below 0.001 and that are markers of 10 clusters or less.
279	Methods; Data Analysis and Statistics; Differential gene expression analysis	2	3	These should be the most specific genes, and therefore the best candidates to produce Gal-4 lines targeting specific cell-types.
280	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	1	1	To identify clusters based on their expression of marker genes, we did not use transcript levels from the transcriptome as they are not directly indicative of protein expression.
281	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	1	2	Indeed, the transcript level corresponding to protein expression can differ up to 50 fold from one gene to another [20].
282	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	1	3	In a given cluster, low UMI levels for a gene can indicate an expression level that is either sufficient or insufficient to produce a functional amount of protein, but also contamination of the cluster by another cell type or presence of this gene in the ambient RNA.
283	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	1	4	We therefore inferred binarized expression matrices for all clusters using a mixture modeling approach [20].
284	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	2	1	Briefly, to decide whether the observed expression level is meaningful, mixture modelling [20] assumes that genes exist in two states, either ON or OFF, and compares multiple cell types to model the probability that a given expression level corresponds to the ON state.
285	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	2	2	Mixture modelling discriminates between unimodal genes, that exist only in one state across cell types, and bimodal genes, that exist in both states.
286	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	2	3	Importantly, ON or OFF state of unimodal genes is decided by comparison with the distribution of transcript abundance for ON and OFF states in confidently bimodal genes.
287	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	3	1	We performed mixture modelling for all our datasets using the code made available in [20].
288	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	3	2	As it was developed for replicated bulk-RNA sequencing data, we adapted our scRNA-seq data by separating all of our clusters in two replicates, each of them containing the averaged non-normalized non-integrated gene expression of half the libraries of a given dataset.
289	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	3	3	Moreover, as cluster 192 contains ambient RNA, its expression levels are not representative of genuine cell types and we removed it from each dataset before mixture modelling.
290	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	3	4	Similarly, we removed NBs, GMCs, and clusters of immature neurons in the P15 dataset as they could be mixtures of multiple cell types.
291	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	1	Despite its great usefulness, mixture modelling presents limitations.
292	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	2	If a gene is expressed in more than 2 states (for instance low, medium and high expression), the intermediate expression levels could be wrongfully assigned to ON or OFF states.
293	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	3	In case of doubts, we therefore advise to plot the expression levels across all clusters and assess them manually.
294	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	4	Moreover, for genes not expressed in the optic lobe, a few cells in our dataset might still have a UMI of this gene by chance, and mixture modelling will consider the gene ON in the clusters containing these cells.
295	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	5	If this affects a sufficient number of genes in a dataset, it will lower the average expression levels corresponding to the ON state across bimodal genes, and therefore artificially increase the number of unimodal genes considered to be ON (unimodal genes represent 6.4% of the genes in our adult dataset).
296	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	6	This could be avoided by removing genes with very low expression levels in all clusters, but we decided against it to avoid using an arbitrary threshold.
297	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	7	Thus, we added to our tables two columns, containing the frequency of cells with at least one UMI for a given gene for the clusters where the gene is ON (column ‘freq_cell_ON’) and for the ones where it is OFF (‘freq_cell_OFF’).
298	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	8	It should be noted that some bimodal genes have an expression of 0 in all our clusters, and have therefore a value of NA (non-applicable) in the column ‘freq_cell_ON’.
299	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	4	9	Therefore, for bimodal genes, the higher the ‘freq_cell_ON’ value is, the more confident we can be in the inferred ON and OFF states.
300	Methods; Data Analysis and Statistics; Binarization of gene expression (Mixture modelling)	5	1	Mixture_modeling.xlsx contains mixture modelling for all genes at all stages, and Log_normalized_average_expression.xlsx log-normalized non-integrated average expression of all genes at all stages, for comparison (GSE142787).
301	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	1	In order to assign the adult clusters to specific cell types, we first aimed at distinguishing neuronal and glial clusters by calculating Pearson correlations between the average gene expression profile of each cluster and transcriptomes sequenced from FACS sorted populations of neurons (elav-Gal4) or glia (repo-Gal4).
302	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	2	In addition, we also identified clusters containing low quality transcriptomes using features tending to be higher (proportions of UMI from mitochondrial genes) or lower (number of UMIs or genes per cell) in low quality cells  [47], [48].
303	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	3	Identification of neuronal clusters, glial clusters and low quality transcriptomes is detailed Supplementary Table 1, Extended Data Figs.
304	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	4	2-3.
305	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	5	Cluster 192 is made mainly of low quality transcriptomes, which seem to originate largely from “ambient RNA” released by glial cells broken during brain dissociation (Suppl.
306	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	6	Table 1).
307	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	7	Probably due to this similarity between low quality and glial transcriptomes, 6 of the 19 glial clusters but only 4 of the 172 neuronal clusters (38, 85, 102, 120) were also identified to likely comprise a significant amount of low-quality transcriptomes (Extended Data Fig2, Suppl.
308	Methods; Data Analysis and Statistics; Annotation of the adult dataset	1	8	Table 1).
309	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	1	To further annotate neuronal transcriptomes, the Pearson correlations between the average log-normalized non-integrated gene expression of our clusters and log-normalized transcriptomes of isolated neuronal populations was first done using the 610 top10 cluster markers of the adult dataset (i.e. the genes ranked among the top 10 most differentially expressed genes for at least one of our clusters when compared to all other clusters).
310	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	2	All neuronal types except Pm3, LC6, LC10b, LC16, and LPi3-4 displayed a clear match to a single cluster as evidenced by an obvious correlation gap (of at least 0.05) between the best and second-best cluster matches (Fig1c, Extended Data Fig3).
311	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	3	T4 and T5 cells both matched to the largest cluster, a case discussed in detail in main text.
312	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	4	The Pm3 transcriptome correlated best, but weakly, with cluster 151 which we verified to be the correct Pm3 cluster based on its expression of previously described markers  [13], [19] (Extended Data Fig3).
313	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	5	The LC10b transcriptome correlated best with cluster 79, but also well though more weakly with clusters 93, 78 (corresponding to LC10d) and 77 (LC10a).
314	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	6	Thus, we assigned LC10b identity to cluster 79, cluster 93 likely being LC10c (for which we did not have a bulk transcriptome).
315	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	7	LC6 matched best with cluster 97, which we split into clusters 221 and 222 (see the section “Backprojection of the developmental splits”).
316	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	8	Cluster 222 then matched best with LC6, while the next best ranking clusters where other LC cells.
317	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	9	LC16 matched best with cluster 100, but with a correlation gap of only 0.03.
318	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	10	As LC transcriptomes seem very similar (as illustrated by the examples above), we believe this explains the relatively small correlation gap for LC16: the third best ranking clusters was cluster 222, which we identified as LC6.
319	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	11	The only neurons we could not find a match for were LPi3-4 neurons.
320	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	12	The resulting annotation was used to annotate the pupal cells.
321	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	13	After this, and after backprojection of developmental splits (such as the separation of cluster 97 into 221 and 222, as described below), our final adult dataset contained 587 top10 cluster markers, which we used for the figures of this paper (including Extended Data Figs. 2 and 3).
322	Methods; Data Analysis and Statistics; Annotation of the adult dataset	2	14	The identification of clusters without comparison to a reference transcriptome was primarily done using mixture modelling of known markers (Extended Data Fig4), and is detailed in length for each cluster in Supplementary Table 1, Extended Data Fig 4.
323	Methods; Data Analysis and Statistics; Annotation of the adult dataset	3	1	As explained in main text we could manually split Tm9, Tm4 and cluster 62 in a Wnt4+ and a Wnt10+ subpopulations at the adult stage.
324	Methods; Data Analysis and Statistics; Annotation of the adult dataset	3	2	However, these subtypes do not appear as separate clusters.
325	Methods; Data Analysis and Statistics; Annotation of the adult dataset	3	3	This is explained by the fact that for a given neuronal type, Wnt4+ and Wnt10+ cells are extremely similar: only a few genes (Wnt4, Wnt10, mamo, frizzled, and a few others out of thousands) show a statistically significant differential expression, which is not enough for unsupervised algorithm to differentiate the cells.
326	Methods; Data Analysis and Statistics; Annotation of the adult dataset	3	4	However, since some of those genes are biologically significant and clearly differentially expressed (Fig5, Extended Data Fig12), the division into Wnt4+ and Wnt10+ subtypes is genuine.
327	Methods; Data Analysis and Statistics; Annotation of the adult dataset	3	5	Similarly, it is likely that other subtypes too similar to appear as different unsupervised clusters could be discovered in the dataset by supervised methods based on prior knowledge.
328	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	1	1	We sought to annotate the pupal datasets using our new, expanded adult atlas as a reference.
329	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	1	2	Using supervised learning algorithms trained on one stage to classify another (even assuming identical cellular composition between stages) poses important challenges (generally referred to as domain adaptation) due to developmental changes in gene expression.
330	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	1	3	Any such approach needs to be robust against these changes while still maintaining high accuracy to distinguish cell-types, in addition to being able to handle the sparseness inherent to single-cell datasets.
331	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	1	4	One alternative is to try to minimize these domain differences beforehand, as adopted by Seurat v3 [21], which uses an anchor based approach to find similarity between the datasets to “align” reference and query datasets using Canonical Correlation Analysis before performing a nearest-neighbor based label transfer.
332	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	1	5	Another alternative, as we attempt here, is to train a sufficiently “underfit” model that is versatile enough to maintain its accuracy even if the query dataset structure is slightly different than the reference.
333	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	1	We explored different supervised learning algorithms by attempting to classify our previously published Drop-Seq dataset using simulated single-cells from bulk transcriptomes [18].
334	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	2	This task represented a significant domain adaptation problem in a dataset that is much sparser than the ones used in this study.
335	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	3	As such, most algorithms including support vector machines, random forests and neural networks performed poorly (data not shown).
336	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	4	However, we saw dramatic improvements upon incorporating dropout regularization [49] in a 2-layer neural network (NN), which randomly removes a subset of nodes at each iteration of training.
337	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	5	In particular, using dropout on the input layer in addition to the hidden layer, albeit against convention, appeared to increase the robustness of the network against natural “drop-out” events of single-cell datasets.
338	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	6	In contrast, more complicated network architectures (e.g. additional hidden layers) only resulted in overfitting without significant improvements on the validation set accuracy.
339	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	2	7	This suggests that classification of transcriptomic data is an inherently simple task which does not benefit from higher level embeddings of deep neural networks.
340	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	1	Using the Python library Keras, we therefore trained a NN with a single hidden layer to classify our adult dataset, using a randomly selected 90% sample of the dataset while the remaining 10% served as a validation set.
341	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	2	As input features, we used log-normalized and mean-centered (non-integrated) expression values of 610 top10 cluster markers.
342	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	3	As these marker genes were calculated on the initial adult dataset, before adjustments such as the separation of Tm9 cluster into Tm9v/d, these genes differ very slightly from the 587 top10 cluster markers of our final adult dataset.
343	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	4	Further expansion of the feature space (e.g. top 30 markers, 1119 genes) did not result in significant improvements on the validation set accuracy.
344	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	5	We used 200 rectified linear units (ReLU) in the hidden layer and a softmax classification layer corresponding to 193 adult clusters.
345	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	6	L2 regularization (lambda=0.002) was applied at hidden and softmax layers and dropout regularization was applied at input (p=0.2) and hidden (p=0.5) layers.
346	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	7	As the clusters had vast imbalances in the number of cells they contained (Extended Data Fig5b), we computed “class weights” using the scikit-learn function compute_class_weight to balance the learning rates for clusters of different sizes.
347	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	8	We trained the network for 30 epochs using stochastic gradient descent with Nesterov momentum (0.9) with early stopping based on validation loss (categorical cross-entropy) and kept the model with highest validation accuracy saved by the ModelCheckpoint callback.
348	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	9	The initial learning rate of 0.05 was halved every 3 epochs as long as the training continued.
349	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	3	10	We finally selected a model that achieved 92.9% accuracy on the training set and 92.3% accuracy on the validation set.
350	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	4	1	It has traditionally been difficult to calculate confidence measures on NN model classifications, which limited their usage in bioinformatics.
351	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	4	2	However, recent work [50] suggested that using dropout (which is normally used only during training) also during classification provides a Bayesian approximation of a probabilistic Gaussian process.
352	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	4	3	We therefore modified this approach to turn on dropout at the classification stage, and calculated 500 independent predictions of classification for each cell in the target dataset using different random subnetworks.
353	Methods; Data Analysis and Statistics; An artificial neural network model to classify single cell transcriptomes	4	4	We calculated the classification “confidence” as the ratio of these predictions that agreed with the prediction generated by the regular Keras .predict() function which uses the entire trained network.
354	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	1	We used this NN model trained on the adult dataset to classify the P70 dataset, the pupal timepoint closest to adult.
355	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	2	P70 cells were classified in general with high confidence (Extended Data Fig8a), with the exception of those that corresponded to LQ clusters, some glia and several cases of biologically meaningful exceptions discussed below.
356	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	3	Nevertheless, we did not have a direct way of assessing the accuracy of NN predictions without a preexisting gold standard.
357	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	4	We therefore opted to comprehensively compare these results to the results of unsupervised clustering.
358	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	5	For each “class” (the annotation predicted by the NN, corresponding to the 193 adult clusters), we calculated the percentage of cells from that class that were placed in the top 5 unsupervised clusters containing the most cells of that class.
359	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	6	Similarly, for each unsupervised cluster we calculated the percentage of cells belonging to the 5 most numerous classes.
360	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	7	Strikingly, in the case of large clusters (i.e. unicolumnar neurons), NN predictions and unsupervised clustering results overlapped near perfectly (Extended Data Fig6a-b).
361	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	8	The remaining clusters were handled in a case-by-case basis and manual adjustments to the NN predictions were applied when necessary using the following guidelines (as detailed in Suppl.
362	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	1	9	Table 1):
363	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	2	1	After we completed all manual adjustments, we assessed the statistical significance of our divisions using the Seurat v2 function AssessNodes as described for the adult dataset above.
364	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	2	2	We verified that all nodes had less than 15% error (OOBE), further validating the NN predictions.
365	Methods; Data Analysis and Statistics; Supervised annotation of the P70 dataset	2	3	Finally, we calculated the P70 top10 cluster markers (642 genes, 445 of them overlapping with the 610 adult top10 markers) to serve as input features for the next iteration of NN training.
366	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	1	We aimed to assess how our NN model performs in comparison to established classification methods in the field for single-cell transcriptomes.
367	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	2	Seurat v3 performs label transfer by identifying pairwise single-cell correspondences across two datasets (i.e. anchors) which are then used in a weighted vote classifier to predict cell identities; and it has been benchmarked to achieve higher accuracy than other recently developed methods [21].
368	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	3	We thus used FindTransferAnchors and TransferData functions (with default parameters of v3.1) to classify our P70 dataset by using the adult dataset as reference.
369	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	4	We tried using both integrated and non-integrated expression matrices; for dimensional reduction we used either 150 CCs or 120 PCs (the values we optimized for integration and clustering above).
370	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	5	The highest overlap (79%) with raw NN predictions (Extended Data Fig6b, before manual adjustments described above) occurred with the PCA-project method using the integrate gene expression (Extended Data Fig6c).
371	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	1	6	As these were also the recommended defaults, we further analyzed these results.
372	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	1	Analysis of mismatched classifications between the two methods (Extended Data Fig6d) revealed that the vast majority of disagreements happened within low-quality cells (center of the tSNEs), glia (green circles) or the clusters with no adult correspondence (blue circles), which were predicted with low confidence by both methods.
373	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	2	Within the neuronal populations, Seurat was able to restore some lower quality cells (which were largely classified as LQ by the NN) back to their correct classes (based on their unsupervised clustering); however, it also appeared less robust in differentiating between relatively similar cell types.
374	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	3	This was most obvious in the case of lamina neurons L1/L2 (red ellipse) because this division was captured by unsupervised clustering of the P70 dataset. 90% of L2 cells and 88% of L1 cells predicted by the NN were in these correct clusters.
375	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	4	Seurat, however, misclassified 45% of the L1 cells (mostly as L2s) despite the fact that these were correctly placed in the L1 unsupervised cluster and correctly classified as L1s by the NN.
376	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	5	This was observed, to a lesser extent, in the misclassification of some Dm11 cells as Dm8s as well.
377	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	6	Interestingly, Seurat avoided these mistakes when using CCA projections instead of PCA, but this method in turn classified thousands of additional neurons as class 190 (glia/LQ) which again were classified correctly by the NN based on their unsupervised cluster assignments.
378	Methods; Benchmarking of the NN classifier; Comparison with Seurat label transfer	2	7	Overall, these observations suggest that the NN classifier is more robust in resolving highly related cell types in our datasets.
379	Methods; Benchmarking of the NN classifier; Performance in other datasets	1	1	Next, we assessed the utility of our NN model in datasets beyond this study by classifying a scRNA-Seq dataset of 56,902 cells published by another group [19].
380	Methods; Benchmarking of the NN classifier; Performance in other datasets	1	2	This dataset was generated from whole adult brains and thus included central brain tissue in addition to the optic lobes.
381	Methods; Benchmarking of the NN classifier; Performance in other datasets	1	3	Extended Data Figures 6e-f show that our NN model was able to handle this well: optic lobe neurons were classified with high confidence and at a much higher resolution (see below) than the clustering provided by the original study.
382	Methods; Benchmarking of the NN classifier; Performance in other datasets	1	4	In contrast, the clusters that were identified by the authors as central-brain neurons (circles) were clearly set aside as low-confidence predictions.
383	Methods; Benchmarking of the NN classifier; Performance in other datasets	1	5	The only obvious exception to this was Kenyon cells, which were classified with high confidence as class 112, further suggesting that our adult dataset might have included contaminating Kenyon cells.
384	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	1	Our classifications showed that 8 of the 21 clusters annotated as optic lobe neurons in this study in fact contained multiple cell types, which could now be resolved by our NN.
385	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	2	Some of these (T2/T3, C2/C3, L4/L5) were already acknowledged by the authors; but we also observed, for instance, Pm1/Pm2 neurons constituted only 11% of the cluster that was annotated as such.
386	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	3	Clusters annotated as TmY14 (11) and Tm9 (18) were also very heterogenous and in fact did not contain these cell types (Our TmY14 and Tm9 clusters mapped to their unannotated clusters 54 and 63, respectively).
387	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	4	In addition, 3 optic lobe clusters in that study were homogenous but were misannotated: Tm5ab, Mt1 and Dm8/Tm5c clusters were in fact Tm3, Tm4 and Lai, respectively.
388	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	5	Dm8 instead mapped to their unannotated cluster 52, where it had co-clustered with Dm11 and Dm12; Tm5c was in fact part of their cluster 11 mentioned above.
389	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	6	Note that several of these annotations were made through mapping from our previous Drop-seq atlas [18] and thus likely represent propagation of errors made in that much lower-resolution dataset.
390	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	7	Further, we could see that out of the 46 unannotated clusters within their dataset, 19 of them contained at least some optic lobe neurons.
391	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	8	Out of these, only 7 were homogenous (>80% of their cluster mapping to a single one of our clusters): T2a, Tm9, Dm9, C2 (the cluster identified as C2/C3 by the authors was mostly just C3) and our unidentified cell types 4, 24 and 26.
392	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	9	The remaining 12 were mixtures of different neurons.
393	Methods; Benchmarking of the NN classifier; Performance in other datasets	2	10	These observations highlight the dramatic improvements in coverage and resolution our new atlas provides thanks to the increased sequencing depth and cell number.
394	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	1	After we completed the annotation of the P70 dataset, we aimed to extend our framework to the earlier pupal stages and annotate all pupal datasets by going backwards through development.
395	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	2	While this would have been possible by re-training the NN with the annotated P70 dataset and classifying P50 (and so on) as described above, such a piecewise approach introduces important drawbacks.
396	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	3	All supervised learning algorithms (but in particular neural networks) require large training datasets to be most effective.
397	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	4	As our training sets became smaller (e.g. only 24k at P40), we would have faced increased overfitting that could reduce the effectiveness of our approach.
398	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	5	This reduction in training set sizes would have been especially detrimental for accurately classifying low-frequency cell types.
399	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	6	Even at P70 (the largest of the pupal datasets), 100 classes had fewer than 100 cells, and 44 classes had fewer than 50 cells.
400	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	7	On the other hand, retraining the network with the aggregated data from all previous stages (e.g.
401	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	8	Adult+P70 for classifying P50) would have ignored the higher relevance of the most closely placed dataset, i.e.
402	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	1	9	P50 cells are expected to be much more similar to P70 cells than to adult cells.
403	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	1	We therefore designed a multi-task NN architecture that was able to use all available labeled data for training while still preserving the highest relevance of the immediately following stage (Fig1f).
404	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	2	We achieved this by creating separate models for all annotated stages (i.e.
405	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	3	P70 and adult for P50 classification), with identical structures except for the input features (i.e. top 10 markers), which were chosen separately for each stage.
406	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	4	The models were trained epoch-by-epoch in an alternating fashion, whereby the weights between ReLU and Softmax layers were copied from one model to another after each epoch (i.e. adult to P70, then P70 to P50, etc.).
407	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	5	This setup effectively creates a larger, combined network with multiple input arms but with the same output; whereby the weights between the distinct input layers and the hidden layer are separate and learned independently for each stage but the weights between the hidden and classification layers are learned cooperatively.
408	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	6	It started with two input arms (adult and P70) at the first step.
409	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	7	After training, the P50 dataset was classified using the P70 model, and thus, with P70 markers as the input features, ensuring that the most proximal dataset was the one used directly but the adult dataset still contributed to the training of this model through information leakage at the second layer.
410	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	8	After NN classification, the predictions were comprehensively compared to the unsupervised clustering results as described above for P70.
411	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	9	All required manual adjustments were made before calculation of the cluster markers to serve as features to the newest input arm of the NN for the classification of the next stage.
412	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	10	Supplementary Table 1 includes notes for each identity where such adjustments were applied.
413	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	11	A new model combining P50, P70 and adult annotations was then computed and used to annotate the P40 dataset (and so on) until the P15 dataset.
414	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	12	For P15 annotations, the NN model performed poorly on discriminating Lawf1 vs.
415	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	13	Lawf2 neurons and also between Tm1/Tm2/Tm4/Cluster 62.
416	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	2	14	We thus trained dedicated multitask networks at this stage, trained only on these cell types, to improve the classification power.
417	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	3	1	The multitask model provided slight improvements on classifier accuracy in addition to the expected decrease in overfitting.
418	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	3	2	For instance, the multitask model trained on adult, P70, P50 and P40 datasets had achieved 95.9% accuracy on the P40 validation set, compared to the 95.2% accuracy of a model trained on the P40 dataset alone.
419	Methods; Benchmarking of the NN classifier; Multitask extension of the NN classifier	3	3	Benefits are likely greater for classifying across stages due to lowered overfitting but were not possible to quantify without a developmental gold standard.
420	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	1	In several cases (clusters 88, 97 (LC6), 169, Dm3, Tm9, T4-5, TE), we were able to find multiple clusters for an identity class in the developmental datasets, even though they were present as a single cluster in adults.
421	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	2	These were assigned to new, distinct classes after verification and were thus automatically considered in the next iteration of the neural network.
422	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	3	After we completed all annotations, in order to preserve ID consistency for downstream analyses, we aimed to transfer neuronal subdivisions to the older datasets where they were not captured by clustering but might still exist.
423	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	4	We achieved this by training binary classifiers on these divisions: we isolated only that cell type at the stage where the split was first observed, calculated markers between the subgroups, and trained a dedicated NN (in the same way as the general classifier except with only 60 hidden units and 2 output classes) to classify the subdivision using the top 30 markers as input features.
424	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	5	We then isolated the same cell type in the next older stage and classified its cells with this NN.
425	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	6	If multiple steps were necessary to reach the adult dataset, we employed a multitask scheme as described above for the general classifier.
426	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	7	This was done for classes 97 (LC6), 220 (TE cells, only from P50 to P70), 35 (Dm3), 121 (Tm9), 88 and 169.
427	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	8	Note that even though Dm3 and Tm9 NNs were able to divide the corresponding clusters at P70 and adult into subtypes, these divisions were highly unreliable (OOBE P70/Adult: 27%/32% for Dm3 and 23%/22% for Tm9).
428	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	9	We also calculated the number of differentially expressed genes (with an adjusted p-value of <0.01) between these subtypes at all stages (Extended Data Fig10e), note that all groups were subsetted to 150 cells in this analysis for consistency.
429	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	10	The rest of the divisions could be reliably carried back to the adult stage.
430	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	1	11	We did not perform this for glial subdivisions.
431	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	2	1	In addition, we subclustered TE neurons at all pupal stages using 20 PCs and 0.5 resolution to search for any additional subtypes.
432	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	2	2	In all stages, we identified a small number of cells that did not express several markers of TE neurons (Wnt4, Wnt10, Fs, dimm) but expressed Imp, which is not expressed in the rest of the TE cluster.
433	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	2	3	These likely represented rare peptidergic neurons clustering with TE neurons due to their unique properties.
434	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	2	4	Thus, we filtered out the subcluster containing these cells at each stage before generating the UMAP plots of Fig 2a.
435	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	3	1	T4-T5 neurons (class 130), that each consist of 4 subtypes, also presented as a single cluster in adults and were subdivided in several unsupervised clusters for all developmental datasets, albeit inconsistently.
436	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	3	2	As detailed in the next section, we attempted to subcluster these at all stages, but all 8 subtypes could only be reliably resolved at P50 while the a/b vs. c/d division was possible at all stages.
437	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	3	3	We therefore trained a binary classifier on this division only and projected it to all stages (classes 234 and 235).
438	Methods; Benchmarking of the NN classifier; Backprojection of the developmental splits	3	4	The identities in the Seurat objects provided only includes this subdivision; however, we created a metadata field in the P50 object that also contains the full subclustering (classes 261 to 268).
439	Methods; Benchmarking of the NN classifier; Final datasets and classifier	1	1	After we finalized annotations at all stages, we trained a final multitask NN with newly calculated markers of all stages as features of each of 6 input arms.
440	Methods; Benchmarking of the NN classifier; Final datasets and classifier	1	2	We provide this final model in the Appendix 1 along with all required files and instructions that could be used to classify datasets generated at any stage.
441	Methods; Benchmarking of the NN classifier; Final datasets and classifier	1	3	Importantly, it is now possible to annotate new datasets using these models without a need to handle the original datasets.
442	Methods; Benchmarking of the NN classifier; Final datasets and classifier	1	4	In addition, the cells discarded in the annotation process are still present in the Seurat objects we provide (GSE142787).
443	Methods; Benchmarking of the NN classifier; Final datasets and classifier	1	5	These contain a metadata field ‘FinalIdents’ with the final annotations, in which the discarded cells have the identity ‘0’, a second metadata field ‘Clustering’ with the unsupervised clusters identities, and a third metadata field ‘NNPreds’ with the uncurated NN predictions.
444	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	1	Even though the subtype divisions of T4 and T5 neurons are well characterized both functionally and developmentally [42], the unsupervised divisions within this cluster in the adult dataset were largely based on technical variation (Extended Data Fig1f) and were merged.
445	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	2	At P50, however, all 8 subtypes could be separately observed already on the tSNE (Fig 4a, Extended Data Fig7c).
446	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	3	We thus isolated them at this stage and performed subclustering (resolution=1) using 8 hand-picked principle components whose top 10 feature loadings (positive or negative) included genes that were known markers of their subtypes [51] (klg, bi, lea, Con, TfAP-2, grn, dpr10).
447	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	4	We were able to obtain 8 clusters that corresponded to the known subtypes (see Results) and calculated the marker genes between them (Extended Data Fig10a).
448	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	5	As it was also recently reported by others [51], we could observe that all T4-T5 subtypes can be defined by three distinct axes of division: T4 vs.
449	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	6	T5 (TfAP-2), a/b vs. c/d (bi) and c/b vs. a/d (grn).
450	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	7	We then attempted to subcluster all the other stages in a semi-supervised manner using independent component analysis (ICA).
451	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	8	At each stage, we identified three ICs defined by the above axes and clustered T4-T5 neurons based exclusively on those.
452	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	9	Details on the quality of these divisions are described below, stage by stage, but at no stage other than P50 we could reliably separate all 8 subtypes.
453	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	10	P15 and Adult datasets were particularly difficult, in both cases the IC that defines b/c vs. a/d division (grn) was ranked particularly low (16^th and 17^th, respectively), resulting in very large errors over this axis.
454	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	11	We then built cluster trees for all stages and report below the OOBE values calculated for some terminal nodes.
455	Methods; Benchmarking of the NN classifier; Subclustering of T4-T5 neurons	1	12	Note that 50% OOBE would imply a completely random division and we usually require less than 5% (adult) or 10% (pupae, due to lower size datasets) OOBE to consider a division reliable, and consider any division with >20% OOBE as essentially unusable.
456	Methods; Benchmarking of the NN classifier; Adult	1	1	All terminal nodes corresponding to T4 vs.
457	Methods; Benchmarking of the NN classifier; Adult	1	2	T5, a vs. b or c vs. d divisions had errors larger than 20%. a/b vs. c/d division had an OOBE of 18%.
458	Methods; Benchmarking of the NN classifier; Adult	1	3	Note that we could achieve a much lower error (7%) on this division when performed in a supervised manner using the P50 dataset as reference (see previous section).
459	Methods; Benchmarking of the NN classifier; Adult	1	4	Therefore, in the objects we provide we only include the a/b vs. c/d division made by the neural network.
460	Methods; Benchmarking of the NN classifier; P70	1	1	a/b vs. c/d division was very reliable.
461	Methods; Benchmarking of the NN classifier; P70	1	2	However, a vs. b and c vs. d divisions had OOBE of 13% and 18% respectively.
462	Methods; Benchmarking of the NN classifier; P70	1	3	Terminal divisions T4c vs.
463	Methods; Benchmarking of the NN classifier; P70	1	4	T5c and T4b vs.
464	Methods; Benchmarking of the NN classifier; P70	1	5	T5b had OOBEs of 24% and 16%.
465	Methods; Benchmarking of the NN classifier; P50	1	1	All subtypes could be reliably resolved with all nodes having less than 10% OOBE.
466	Methods; Benchmarking of the NN classifier; P40	1	1	Most subtypes could be reliably resolved except for T4c vs.
467	Methods; Benchmarking of the NN classifier; P40	1	2	T4d and T5c vs.
468	Methods; Benchmarking of the NN classifier; P40	1	3	T5d, with OOBE 13% and 29%, respectively.
469	Methods; Benchmarking of the NN classifier; P30	1	1	a/b vs. c/d division remained very reliable with variable performance in other splits.
470	Methods; Benchmarking of the NN classifier; P30	1	2	T4 vs.
471	Methods; Benchmarking of the NN classifier; P30	1	3	T5 divisions all had OOBE >10%, largest being T4c vs.
472	Methods; Benchmarking of the NN classifier; P30	1	4	T4c at 19%.
473	Methods; Benchmarking of the NN classifier; P15	1	1	a/b vs. c/d division was reliable with OOBE of 5%. a/d vs. c/b and T4 vs.
474	Methods; Benchmarking of the NN classifier; P15	1	2	T5 divisions had OOBEs of 10% and 20% respectively.
475	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	1	1	Our supervised approach allowed us to assign fully consistent identities to all of our cells at all stages.
476	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	1	2	To determine neuron-specific markers (to eliminate pan-neuronal genes), we isolated 175 neuronal clusters (including the backprojected developmental splits described above, excluding the photoreceptors) and re-calculated the clusters markers at each stage.
477	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	1	We filtered the marker lists for each stage using a list of 629 genes annotated as transcription factors in FlyBase.
478	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	2	Next, we determined for each cluster which TFs were consistently significant markers between stages.
479	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	3	Since some markers for smaller clusters may be randomly dropped out due to lower sample sizes in pupal stages and at P15 some clusters have not fully acquired their identity, we allowed some flexibility: We took the TFs that were markers for each cluster in the adult dataset and at least four out of the five pupal datasets.
480	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	4	The resulting combinations of 113 TFs (Suppl.
481	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	5	Table 2) were unique to each cluster, with only the exception of Tm9v/d subtypes.
482	Methods; Benchmarking of the NN classifier; Stable transcription factor markers in neuronal clusters	2	6	The median number of TFs in each cluster is 8, the minimum per cluster is 2 and maximum is 13 TFs for a cluster.
483	Methods; Benchmarking of the NN classifier; Trajectory analysis	1	1	We used Monocle 3 [38] to determine the sources of age-dependent, continuous heterogeneity (if any) within the Tm3 cluster at P15 and P30.
484	Methods; Benchmarking of the NN classifier; Trajectory analysis	1	2	After creating CellDataSet objects with standard preprocessing, we copied UMAP loadings directly from Seurat as we found Seurat integration was better in reducing biologically irrelevant variations than the batch correction methods implemented in Monocle.
485	Methods; Benchmarking of the NN classifier; Trajectory analysis	1	3	We then ordered the cells in pseudotime using learn_graph (minimal branch length=10) and order_cells functions, calculated the genes that varied across pseudotime with graph_test function and filtered those by q value (< 0.05).
486	Methods; Benchmarking of the NN classifier; Trajectory analysis	1	4	Finally, we clustered these marker genes based on their temporal expression patterns using find_gene_modules function (resolution=0.01).
487	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	1	In order to determine the genes that were differentially expressed across different stages, we subsetted all objects (from P15 to adult) to contain only neuronal clusters.
488	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	2	These were merged into a single object which was re-scaled and identities for all cells were set as their stage of origin.
489	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	3	This object was subsetted to include 15,000 cells from each 6 stages and stage markers were calculated with FindAllMarkers function.
490	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	4	The number of significant markers for each stage ranged from 193 in P40 to 746 in adult.
491	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	5	We also calculated independently at each stage the cluster markers between neuronal clusters only.
492	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	1	6	We included only the top 20 markers (by logFC) for each cluster in order to have a similar number of genes per stage as the stage markers. 332 of these markers genes (about half the total at each stage) were shared between all pupal and adult stages, and as a result, GO terms largely overlapped as well (Extended Data Fig11a).
493	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	1	We then performed GO enrichment analysis on both the stage markers and the cluster markers, and calculated enrichment for both Biological Process and Molecular Function terms using The Gene Ontology Resource (http://geneontology.org/).
494	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	2	We filtered the terms to include only those with fold enrichment greater than 2.
495	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	3	We used REVIGO (http://revigo.irb.hr/) to remove redundant terms and group the related ones [52] with a similarity index of 0.5.
496	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	4	The TreeMap tables were then exported from REVIGO and inputted to the Python package CirGO [53] to create the summary graphs of Extended Data Fig11.
497	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	5	Briefly, CirGO determines the relative size of each slice based on the absolute value of log_10(p-value) of each term.
498	Methods; Benchmarking of the NN classifier; GO enrichment analysis of the markers	2	6	To produce the Figure 4 plots, for each stage, the percent enrichment of each summary term as determined by REVIGO (inner rings in Extended Data Fig11) were manually combined into 8 super-terms for Biological Process and 7 super-terms for Molecular Function, and plotted accordingly.
499	Methods; Connectome Analysis	1	1	Processed data for the 7-column medulla connectome [4] with cartesian coordinates of all synaptic sites assigned to the cells traced in the original study was downloaded from https://github.com/connectome-neuprint/neuPrint/blob/master/fib25_neo4j_inputs.zip (Retrieved from April 2019 commit).
500	Methods; Connectome Analysis	1	2	Due to very elongated nature of Dm3 arbors, 2D projection and plotting of these coordinates for each Dm3 cell readily revealed its directionality.
501	Methods; Connectome Analysis	1	3	We thus plotted the synaptic coordinates of all Dm3 neurons together, each individual cell colored differently, to identify the two subtypes with orthogonal orientations.
502	Methods; Connectome Analysis	1	4	Cells with parallelly oriented arbors were placed into the same class, called either Dm3x or Dm3y, as we could not assign anatomical directions without examining the EM images.
503	Methods; Connectome Analysis	2	1	We then calculated the values of normalized inputs/outputs to/from particular cell types for each Dm3 and compared their averages between the two subtypes, excluding the cells with less than 20 total input or outputs in each case.
504	Methods; Connectome Analysis	2	2	Normalization was performed separately for inputs and outputs.
505	Methods; Connectome Analysis	2	3	In each case the number of synapses to/from a specific neuronal identity (pooled total of all cells belonging to that type) was divided by the total number of input/output synapses of that Dm3 neuron.
506	Methods; Connectome Analysis	2	4	As we did not see clear differences in the average normalized inputs between subtypes (besides the synapses between Dm3s), Figure 4d only plots the average normalized outputs to the postsynaptic cell types where we identified differences.
