	section	paragraph	sentence	text
1	Title	1	1	A genetic, genomic, and computational resource for exploring neural circuit function
2	Abstract	1	1	The anatomy of many neural circuits is being characterized with increasing resolution, but their molecular properties remain mostly unknown.
3	Abstract	1	2	Here, we characterize gene expression patterns in distinct neural cell types of the Drosophila visual system using genetic lines to access individual cell types, the TAPIN-seq method to measure their transcriptomes, and a probabilistic method to interpret these measurements.
4	Abstract	1	3	We used these tools to build a resource of high-resolution transcriptomes for 100 driver lines covering 67 cell types, available at http://www.opticlobe.com.
5	Abstract	1	4	Combining these transcriptomes with recently reported connectomes helps characterize how information is transmitted and processed across a range of scales, from individual synapses to circuit pathways.
6	Abstract	1	5	We describe examples that include identifying neurotransmitters, including cases of apparent co-release, generating functional hypotheses based on receptor expression, as well as identifying strong commonalities between different cell types.
7	Abstract	2	1	In the brain, large numbers of different types of neurons connect with each other to form complex networks.
8	Abstract	2	2	In recent years, researchers have made great progress in mapping all the connections between these cells, creating ‘wiring diagrams’ known as connectomes.
9	Abstract	3	1	However, charting the connections between neurons does not give all the answers as to how the brain works; for example, it does not necessarily reveal the nature of the information two connected cells exchange.
10	Abstract	3	2	Assessing which genes are switched on in different neurons can give insight into neuronal properties that are not obvious from physical connections alone.
11	Abstract	4	1	To fill that knowledge gap, Davis, Nern et al. aimed to measure the genes expressed in a well-characterized network of neurons in the fruit fly visual system.
12	Abstract	4	2	First, 100 fly strains were established, each carrying a single type of neuron colored with a fluorescent marker.
13	Abstract	4	3	Then, a biochemical approach was developed to extract the part of the cell that contains the genetic code from the neurons with the marker.
14	Abstract	4	4	Finally, a statistical tool was used to assess which genes were on in each type of neurons.
15	Abstract	4	5	This led to the creation of a database that shows whether 15,000 genes in each neuron type across 100 fly strains were switched on.
16	Abstract	5	1	Combining this information with previous knowledge about the flies’ visual system revealed new information: for example, it helped to understand which chemicals the neurons use to communicate, and whether certain cells activate or inhibit each other.
17	Abstract	6	1	The work by Davis, Nern et al. demonstrates how genetic approaches can complement other methods, and it offers a new tool for other scientists to use in their work.
18	Abstract	6	2	With more advanced genetic methods, it may one day become possible to better grasp how complex brains in other organisms are organized, and how they are disrupted in disease.
19	[Introduction]	1	1	Thank you for submitting your article "A genetic, genomic, and computational resource for exploring neural circuit function" for consideration by eLife.
20	[Introduction]	1	2	Your article has been reviewed by three peer reviewers, and the evaluation has been overseen by a Reviewing Editor and K VijayRaghavan as the Senior Editor.
21	[Introduction]	1	3	The reviewers have opted to remain anonymous.
22	[Introduction]	2	1	The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted this decision to help you prepare a revised submission.
23	[Introduction]	3	1	The three reviewers are in agreement that this work is a very valuable contribution to the literature and that it should be published in eLife.
24	[Introduction]	3	2	I am also of the same opinion.
25	[Introduction]	3	3	However, they all three raised issue that will require some textual changes, better explanations of the modeling.
26	[Introduction]	3	4	Here is a summary of the most important issues.
27	[Introduction]	4	1	Summary
28	[Introduction]	5	1	In this manuscript Davis et al. have used different enhancer combinations to mark diverse subtypes of cells, mostly from the visual system, and conduct RNA-seq analysis on isolated nuclei to assign gene expression patterns observed in 67 cell types.
29	[Introduction]	5	2	The authors first refined the INTACT method, which helps to isolate nuclei specified by a GAL4 expression pattern.
30	[Introduction]	5	3	In the new method (TAPIN) the authors add tandem affinity purification to the nucleus isolation pipeline.
31	[Introduction]	5	4	The authors show that this modification increases sensitivity of detection of transcripts and specificity of isolated nuclei compared to the previous methodology.
32	[Introduction]	5	5	The authors convert the often-graded expression levels to two normal distributions of binary on-off states.
33	[Introduction]	5	6	They then convert this data to probability of expression scores by using mathematical modeling.
34	[Introduction]	5	7	The accuracy of this modelling approach is demonstrated in multiple examples.
35	[Introduction]	5	8	The authors compare the expression patterns that they obtained to the recently available single cell sequencing data sets.
36	[Introduction]	5	9	Interestingly very few expression patterns directly map to a single cell transcription profile.
37	[Introduction]	5	10	Nevertheless, this comparison helped to determine the identity of many single cell sequencing clusters obtained in previous studies.
38	[Introduction]	5	11	Finally, the authors analyze the expression patterns of neurotransmitters and their receptors.
39	[Introduction]	5	12	By combining high resolution connectome obtained by EM with the expression patterns obtained by TAPIN and INTACT methods the authors find multiple wiring paradigms in the Drosophila brain.
40	[Introduction]	6	1	The authors try to find relationships between cell types.
41	[Introduction]	6	2	They unsurprisingly find grouping of cell types with similar developmental origins and structures.
42	[Introduction]	6	3	They compare their results to published single-cell sequencing datasets from the optic lobes and the brain and confirmed that the single-cell datasets consisted of clusters that include more than one cell types, which was already known based on the number of clusters itself.
43	[Introduction]	6	4	They manage to annotate and correct some of the single-cell clusters, showing that bulk transcriptomes can be used to interpret single-cell clusters.
44	[Introduction]	6	5	They go on to analyze neurotransmitter and neurotransmitter receptor expression in different cell types, before finally trying to interpret connectomic data in the light of their transcriptomes.
45	[Introduction]	7	1	Major comments:
46	[Introduction]	8	1	- There are issues that need to be discussed more openly.
47	[Introduction]	8	2	For instance, in many instances the RNA expression pattern of a cell type is referred to a cells expression pattern.
48	[Introduction]	8	3	This would assume that the expression pattern is homogenous in a given cell type.
49	[Introduction]	8	4	This is a big assumption.
50	[Introduction]	8	5	The fact that the TAPIN expression patterns do not directly correlate with the single cell expression profiles can indicate that the cells from a cell type can have divergence in their expression profile.
51	[Introduction]	8	6	This has implications about the cell types that show multiple neurotransmitters.
52	[Introduction]	8	7	This issue should be more clearly discussed.
53	[Introduction]	9	1	- Another issue is that the authors use the RNA levels and protein levels interchangeably, disregarding the possibility of post transcriptional regulation (This is more pronounced when they use the RNA expression data about cell adhesion molecules in Figure 4-figure supplement 1).
54	[Introduction]	9	2	This should also be addressed.
55	[Introduction]	10	1	- The extent to which single cell sequencing clusters can be compared to TAPIN profiles should be better discussed.
56	[Introduction]	10	2	The TAPIN profiles are RNA expression of cells that share one or two enhancers (by the use of GAL4 or splitGAL4).
57	[Introduction]	10	3	Unbiased clustering of single cell sequencing data is based on multiple principle components.
58	[Introduction]	10	4	The manuscript compares the two approaches and suggest one is better than the other.
59	[Introduction]	10	5	These are complementary approaches and the data are different and difficult to compare (due to possible RNA expression heterogeneity within cell types).
60	[Introduction]	10	6	This is reflected in the fact that mid-level hierarchical clustering was not well supported by the TAPIN data (Figure 4A) whereas discrete clustering can be observed in single cell sequencing data.
61	[Introduction]	10	7	The best experiment to address this would be to do single cell sequencing on TAPIN isolated population of neurons nuclei for one or two cell types.
62	[Introduction]	10	8	I am not requiring this but they should discuss this better
63	[Introduction]	11	1	- Although this is a resource paper, the resource is not accessible to people with limited programming or computational skills.
64	[Introduction]	11	2	In the web portal opticlobe.com, a simple heatmap can be generated based on the user input.
65	[Introduction]	11	3	This visualization can hardly reflect the depth and complexity of the data.
66	[Introduction]	11	4	Please refer to https://gtexportal.org/home/ as a reference to add more tools for general users.
67	[Introduction]	12	1	- The description of the mixture model is confusing.
68	[Introduction]	12	2	The lowercase and uppercase p is mixed for different probabilistic events.
69	[Introduction]	12	3	Do they denote different functions?
70	[Introduction]	12	4	Conditioned on "bimodal", the posterior probability equation in subsection “Inferring expression state from transcript abundance” is very confusing.
71	[Introduction]	12	5	Did you integrate out the p(bimodal)?
72	[Introduction]	12	6	If not, how is the Bayesian rule applied here?
73	[Introduction]	12	7	The math equations are not well defined.
74	[Introduction]	13	1	- On the model selection section, the first equation used sums of probability, the second equation uses a log sum of probability.
75	[Introduction]	13	2	Is there a reference or proof for such modeling choices from STAT or machine learning literature?
76	[Introduction]	14	1	- The mixture model is well studied in both Bayesian and Frequentist framework, how does this approach compare to the standard Bayesian Gaussian mixture model?
77	[Introduction]	15	1	- Figure 3C is the main result of the mixture model and the lower heatmap showed about HALF of the cells in the matrix are read and the other half is blue across all the genes and samples.
78	[Introduction]	15	2	This is likely due to an artifact of the customized mixture modeling.
79	[Introduction]	15	3	Since most of the results in the manuscript depend on the probability estimated from the mixture model, it is crucial to show mathematically that the model is correct.
80	[Introduction]	16	1	The reviewers raise several important points.
81	[Introduction]	16	2	By construction, our approach aims to profile the bulk expression of all the cells in a given GAL4 or split-GAL4 pattern.
82	[Introduction]	16	3	Most of the driver lines we used were selected to be primarily expressed in cells with shared anatomical properties that distinguish these cells from the cells of other types.
83	[Introduction]	16	4	In particular, many of the optic lobe cell types we profile are anatomically very well defined and have long been accepted as distinct cell types in the literature on the fly visual system.
84	[Introduction]	16	5	While we go through extensive efforts to characterize the specificity of the driver patterns by anatomy, it is true that the cells in such a pattern could exhibit different profiles.
85	[Introduction]	16	6	In a few cases such heterogeneity is expected: As we discuss in the text and detail in Supplementary file 1A, some of our driver lines combine related cell types or include “contaminants” (cells of other types) in addition to the targeted neurons.
86	[Introduction]	16	7	In addition, as we now explicitly discuss, cells without obvious anatomical differences at the light microscopy level could still include hidden subtypes with distinct gene expression (such as the pale and yellow subtypes of R7 and R8 photoreceptor neurons with different rhodopsin expression but similar anatomy).
87	[Introduction]	16	8	Finally, there are of course sources of variation in gene expression other than cell type differences.
88	[Introduction]	16	9	For example, even within the exact same cell, the transcriptome can vary over time, e.g. due to circadian rhythms or, over a different time-scale, aging (Davie et al., 2018).
89	[Introduction]	17	1	While we sometimes refer to a cell type’s expression as a cell’s expression, we now clarify this wording in the text: “(For simplicity, we will hereon refer to cell type as just cell.
90	[Introduction]	17	2	This is not meant to exclude the possibility of heterogeneity within the individual cells of a profiled population.)”
91	[Introduction]	18	1	For many applications, combined data for populations of related cell types can be useful, since such cells are likely to share many molecular properties.
92	[Introduction]	18	2	For example, we profile driver lines expressed in motion-sensitive T4/T5 neurons that combine eight anatomically distinct subpopulations.
93	[Introduction]	18	3	As we highlight in Figure 4D-H, using drivers that express in different subsets of these eight cell types, we can identify clear differences between the transcriptomes of some subtypes.
94	[Introduction]	18	4	Nevertheless, most molecular properties of T4/T5 cells appear to be shared across the different subpopulations.
95	[Introduction]	18	5	Recently, the Zipursky lab has sorted T4 and T5 cells and used single cell RNA-seq to more comprehensively characterize T4/T5 subtypes (Kurmangaliyev et al., eLife 2019).
96	[Introduction]	18	6	This scRNA analysis identified eight T4/T5 subclusters, exactly in line with the predictions from anatomy.
97	[Introduction]	18	7	This work also confirms our finding of Tfap2 and klg as markers for different T4/T5 subsets and supports the general similarity of the eight subtypes.
98	[Introduction]	19	1	To the reviewers specific point of how heterogeneity within cell types might explain differences between TAPIN and single cell profiles, we would remind the reviewer that we compared our TAPIN profiles to the average profile of single cells within each cluster, not to individual single cells.
99	[Introduction]	19	2	And so, any heterogeneity within a single cell cluster would be averaged out in the comparison to TAPIN-seq profiles.
100	[Introduction]	19	3	In fact, the resolution of the single cell maps that we analyzed (e.g. collapsing the eight T4/T5 subtypes into a single cluster) makes it unlikely that they resolved many named cell types into previously unknown distinct molecular subtypes, and the authors of those maps make no such claims.
101	[Introduction]	20	1	Finally, we agree that, using only a given bulk profile, it is not possible to formally rule out that two neurotransmitter markers (or, for that matter, any other combination of transcripts) that appear co-expressed are actually present in distinct, non-overlapping sets of cells.
102	[Introduction]	20	2	Single cell studies do not necessarily avoid this issue either: For example, Konstatinides et al. report two clusters with apparent co-expression of cholinergic with glutamatergic or GABAergic markers, respectively, but are unable to determine whether this is true co-expression (and in addition do not know the identity of the cell type(s) involved).
103	[Introduction]	20	3	In our view, the best approach to resolve such uncertainty are follow-up experiments with an independent method: For example, we used immunolabeling of a tagged VAChT protein (Figure 8A) to confirm the unexpected expression of cholinergic markers in R8 photoreceptors cells.
104	[Introduction]	20	4	Together with published work on histamine expression in R-cells and our observation that histamine receptors are expressed in some but not all synaptic partners of R8 cells (Figure 8B-F), this strongly suggests a co-transmitter phenotype of these neurons.
105	[Introduction]	20	5	In general, because TAPIN-seq profiles are linked to markers (driver lines) for the profiled cells, performing validation experiments for selected transcripts is straightforward and we provide several examples of this.
106	[Introduction]	21	1	All of the TAPIN-seq data that we measured were at the transcript level.
107	[Introduction]	21	2	We compared it to protein expression as a more stringent functional-requirement on “real” expression.
108	[Introduction]	21	3	The reviewer is correct that there could be additional levels of post-transcriptional regulation and we clarify this point in the text.
109	[Introduction]	22	1	“Protein expression can of course differ from that of the corresponding mRNA due to post-transcriptional regulation.
110	[Introduction]	22	2	However, since most functional interpretations of transcriptome data are implicitly about protein expression, we used this as a more stringent and practical test of our model.”
111	[Introduction]	23	1	We agree with the reviewer that single cell sequencing and bulk profiling such as TAPIN-seq are complementary approaches.
112	[Introduction]	23	2	Indeed, we mention this repeatedly in the text, as well as titling Figure 5 to reflect this idea: “TAPIN-seq complements single cell RNA seq profiling”.
113	[Introduction]	24	1	We also devote extensive discussion to this theme, including the reviewers suggestion of combining single cell sequencing and TAPIN profiling.
114	[Introduction]	25	1	“TAPIN-seq complements single-cell RNA-seq studies of neurons in several ways”“
115	[Introduction]	26	1	“Having both deep bulk transcriptomes and single cell maps of the same tissue also provides an opportunity for developing new analytical tools that can harness available cell type-identified information while clustering single cell data.”
116	[Introduction]	27	1	“Second, combining our approach with single-cell profiling could more efficiently profile heterogeneity within a brain region or genetically defined cell population”
117	[Introduction]	28	1	“Finally, the complementarity between bulk and single-cell measurements extends to other genomic features that can be measured in TAPIN-seq purified nuclei, including accessible chromatin and modified histones.”
118	[Introduction]	29	1	In the recent Zipursky lab single cell study of T4/T5 neurons (see above), a GAL4 driver was used to mark cells for presorting by FACS prior to scRNASeq.
119	[Introduction]	29	2	In this case, the results provide strong support for the notion that anatomical features can be reliable criteria for cell type classification (both anatomy and single cell sequencing indicate exactly eight T4/T5 subtypes).
120	[Introduction]	30	1	We anticipate that similar experiments with other optic lobe neurons using our driver lines would produce similar results (i.e. support for anatomically and genetically defined cell types), but do not exclude the possibility that there could be unexpected subdivisions within some of the cell types we profile (as we now discuss).
121	[Introduction]	31	1	The reviewer suggests that unbiased clustering of single cell data is somehow more informative (“uses multiple principal components”, a dimension reduction of the 15K gene abundances) and better powered to detect cellular differences than TAPIN-seq profiles of cells that “share one or two enhancers” (although we also measure 15K gene levels).
122	[Introduction]	31	2	We think this might reflect a mis-understanding of what exactly the one or two enhancers represent.
123	[Introduction]	31	3	The key feature of our driver lines is not the number of elements used in their construction but the specificity of the expression patterns.
124	[Introduction]	31	4	The cells labeled by one of these GAL4 or split-GAL4 lines are not randomly related, but through extensive anatomical efforts, are believed to be of the same (anatomically-defined) cell type (or group of cell types).
125	[Introduction]	31	5	Therefore, the expectation, and our observation in this paper, are that the transcriptomes we measure in these cells using TAPIN-seq in fact reflect the transcriptome of specific cell types.
126	[Introduction]	32	1	Bulk and single-cell data are difficult to compare for a number of reasons, that we discuss in the manuscript.
127	[Introduction]	32	2	Within-cell heterogeneity could potentially be one reason, but we doubt that is the main reason.
128	[Introduction]	32	3	In fact, as we showed, the unbiased clustering of single cell maps often merge cells of different types, which TAPIN-seq is able to resolve thanks to the genetic tools that differentially mark them.
129	[Introduction]	32	4	Even if the single cells were correctly clustered so that each cluster does reflect a cell type, their transcriptomes would still be difficult to compare directly to bulk transcriptomes, as the measurement characteristics are quite different, with single cell data using current technologies exhibiting high levels of dropout, as we describe in the text.
130	[Introduction]	32	5	Nevertheless, as we showed, comparing the two datasets is still a fruitful way of overcoming the main limitations of both: the requirement for genetic tools of TAPIN-seq, and the difficulty of resolving and labeling cell types in scRNA-seq.
131	[Introduction]	32	6	We also further emphasized the potential of combining bulk and single cell methods in the Discussion:
132	[Introduction]	33	1	”Second, combining our approach with single-cell profiling could more efficiently profile heterogeneity within a brain region or genetically defined cell population.
133	[Introduction]	33	2	Such a combined approach could also help to characterize known cell types for which specific driver lines are not yet available or help to identify and exclude contributions from “off-target” cells to a bulk profile.”
134	[Introduction]	34	1	The lack of support for a mid-level hierarchical clustering in the TAPIN-seq profiles is not contradicted by a discrete clustering of single cell data.
135	[Introduction]	34	2	Whether single cells of a type cluster together is not the same as asking which other cell types/clusters they are most closely related to.
136	[Introduction]	34	3	We went to lengths to evaluate the uncertainty within our clustering trees and present the confidence values alongside the tree.
137	[Introduction]	34	4	In contrast, the trees presented in most single cell approaches, either do not perform this evaluation or do not present it alongside the tree.
138	[Introduction]	34	5	For example, the tree presented in Figure 3 of Konstantinides et al., 2018 does not show this type of evaluation.
139	[Introduction]	34	6	They do show a similar bootstrapped evaluation as a supplemental Figure (S4), and this shows that very few of their branch points have significant statistical support.
140	[Introduction]	34	7	In brief, just because you can build a tree doesn’t mean it accurately reflects the transcriptome measurements, let alone provide reliable clues to biological features such as developmental or evolutionary lineage that might conceivably be reflected in such trees.
141	[Introduction]	35	1	We agree with the reviewer that access to the data is key.
142	[Introduction]	35	2	For this reason, we have made the expression tables available for download so that any user can explore them using user-friendly spreadsheet programs, such as Microsoft Excel.
143	[Introduction]	35	3	To remove the hurdle of downloading and opening the table in Excel, we also developed a web portal to support simple queries.
144	[Introduction]	35	4	We see this web portal mainly as a tool for initial queries which can then be followed up by downloading the spreadsheets or even reanalyzing the original data.
145	[Introduction]	35	5	This web portal has been useful for others in the field (eg, doi 10.1523/JNEUROSCI.3213-18.2019).
146	[Introduction]	36	1	We agree that a better developed web interface would be ideal, and the GTEX portal is indeed an informative guide for this: This project received $800K from the NIH this year to develop “a portal and integrative collaborative analysis platform for GTEX” (https://projectreporter.nih.gov/project_info_description.cfm?
147	[Introduction]	36	2	aid=9729842&icde=47359899).
148	[Introduction]	36	3	This kind of effort is beyond the scope of this paper.
149	[Introduction]	37	1	We thank the reviewer for bringing the confusion about lowercase and uppercase p to our attention.
150	[Introduction]	37	2	In the statistics literature, uppercase P refers to the probability of a discrete event and lowercase p refers to a continuous density function.
151	[Introduction]	37	3	We fixed three cases where we inconsistently used uppercase P where it should have been lowercase p.
152	[Introduction]	38	1	Yes, in a discrete sense, we did integrate out p(bimodal).
153	[Introduction]	38	2	As we described in the text, we used the PSIS-LOO approach to selecting whether each gene was better described by a unimodal or bimodal model.
154	[Introduction]	38	3	Depending on this binary call (either unimodal or bimodal was selected), we chose either the p(expressed | bimodal) or the p(expressed | unimodal).
155	[Introduction]	38	4	This is equivalent to using the model selection to decide p(gene type = bimodal) = 1 or p(gene type = unimodal) = 1.
156	[Introduction]	39	1	This math is widely adopted in the Bayesian inference field, and comes from the PSIS-LOO paper that we cite at the beginning of this section (See Equations 20 and 21 from Vehtari et al., 2015; https://arxiv.org/pdf/1507.04544.pdf).
157	[Introduction]	40	1	Our model is mostly a standard bayesian mixture model, with the wrinkle of the model selection process that we describe in the paper.
158	[Introduction]	40	2	It would have been ideal if there was a single hierarchical model that jointly learned both the gene type (bimodal vs unimodal) as well as the gene-specific on/off distributions.
159	[Introduction]	40	3	However, we were unable to build such a model, and the one that we did ultimately build was sufficient to help us successfully navigate our transcriptome catalog.
160	[Introduction]	41	1	While there are indeed several choices that go into the modeling, we go through extensive comparison to published expression datasets and extensive protein-level validation of two genes across thirty cell types.
161	[Introduction]	41	2	In our hands, the probability model was a useful guide for navigating our data.
162	[Introduction]	41	3	In the case that one is not comfortable with the model calls, they can also use the raw expression levels, which we also provide for download.
163	[Introduction]	42	1	In reality, all mathematical models are wrong.
164	[Introduction]	42	2	As we described in the text, genes are not just on and off; different RNA species have different degradation rates, different translation rates, etc.
165	[Introduction]	42	3	Like all experiments, every step in a transcriptome study suffers from various kinds of artifacts, ranging from the raw measurements to interpretation.
166	[Introduction]	43	1	But in practice, we showed that the measurements are informative, recapitulate known biology, serve as a guide to interpret other genomics datasets, are consistent and corroborated by connectomics data, and provide new insight into the Drosophila visual system.
167	Introduction	1	1	The anatomy of neural circuits is being characterized with increasing resolution and throughput, in part following a dramatic increase in the size of circuits amenable to detailed electron microscopy reconstruction (Swanson and Lichtman, 2016) and the development of genetic tools to access individual cell types (Luo et al., 2018).
168	Introduction	1	2	These efforts reveal anatomy at unprecedented detail, but not the molecular properties of cells.
169	Introduction	1	3	In principle, the genes expressed in each cell of a neural circuit should serve as a molecular proxy for cell physiology.
170	Introduction	1	4	However, most genomic efforts have focused on surveying neuronal diversity rather than characterizing circuit function (Ecker et al., 2017).
171	Introduction	1	5	To develop a resource exploring molecular correlates of circuit function, here we use an approach that genetically targets cell types within a well-characterized brain region to measure high-quality transcriptomes that can be integrated with connectomes.
172	Introduction	2	1	Drosophila affords an ideal system to study neural circuits in detail, as both excellent genetic tools and high resolution connectomes are available.
173	Introduction	2	2	Here we focus on the repeating columnar circuits of the visual system, found in the optic lobes, a widely used model for studying circuit development and function with an extensive genetic toolbox and well-described anatomy (Figure 1A; Nériec and Desplan, 2016; Silies et al., 2014; Apitz and Salecker, 2014).
174	Introduction	2	3	This network begins with photoreceptor neurons and contains several layers of connected neurons which process incoming luminance signals into multiple parallel streams of visual information (Figure 1B).
175	Introduction	2	4	Many of its cellular components have been described by light microscopy, including classical Golgi studies (Fischbach and Dittrich, 1989) and recent analyses using genetic methods (Morante and Desplan, 2008; Otsuna and Ito, 2006; Nern et al., 2015; Wu et al., 2016).
176	Introduction	2	5	Electron microscopy reconstruction work has characterized the synaptic connections of many optic lobe neurons (Meinertzhagen and O'Neil, 1991; Meinertzhagen and Sorra, 2001; Rivera-Alba et al., 2011; Takemura et al., 2013; Takemura et al., 2015; Takemura et al., 2017; Shinomiya et al., 2019).
177	Introduction	2	6	Comparative studies have also explored the evolution of this ancient brain structure (Strausfeld, 2009).
178	Introduction	2	7	Despite this wealth of information, many of its fundamental properties remain unknown, including the neurotransmitters used at many of its synapses.
179	Introduction	3	1	Measuring the genes expressed in specific cells of the brain is challenging due to its compact and complex organization.
180	Introduction	3	2	RNA sequencing (RNA-seq) addresses this challenge by profiling either single cells or genetically labeled populations of cells (Ecker et al., 2017).
181	Introduction	3	3	The latter approach requires genetic tools to access individual cell types but provides more direct access to cells of interests than sampling of unmarked single cells, especially for sparse cell types.
182	Introduction	3	4	Profiling identified cell types provides a direct link to previous work on the anatomy and physiology of those cell types.
183	Introduction	3	5	Cell type-specific drivers also facilitate follow-up experiments, for example evaluating the role of individual genes in individual cells.
184	Introduction	3	6	In Drosophila, large collections of GAL4 driver lines (Jenett et al., 2012; Tirian and Dickson, 2017) and the possibility to further refine these patterns with intersectional methods such as split-GAL4 (Luan et al., 2006; Dionne et al., 2018) enable genetic access to many neuronal populations (see, for example, Tuthill et al., 2013; Aso et al., 2014; Wu et al., 2016).
185	Introduction	3	7	We therefore chose the genetic, rather than single cell, approach to build a genomics resource to explore circuit function.
186	Introduction	4	1	We previously developed an Isolation of Nuclei Tagged in a specific Cell Type (INTACT) method (Deal and Henikoff, 2010) to measure transcriptomes and epigenomes of genetically-marked neuronal populations in Drosophila (Henry et al., 2012) and mouse (Mo et al., 2015).
187	Introduction	4	2	Here, we develop a tandem affinity purification of INTACT nuclei (TAPIN) method with increased specificity, sensitivity, and throughput.
188	Introduction	4	3	By combining this method with an extensive set of new driver lines with predominant expression in specific cell types and a new probabilistic method to interpret transcript abundance, we build a resource of high-quality transcriptomes for one hundred driver lines.
189	Introduction	4	4	We selected drivers that expressed in cell types constituting the lamina (Fischbach and Dittrich, 1989; Tuthill et al., 2013; Edwards et al., 2012) as well as the major cell types of the circuits that compute the direction of visual motion (Mauss et al., 2017; Figure 1C).
190	Introduction	4	5	We further included neuronal populations in two central brain regions, the mushroom body and central complex, primarily to serve as informative outgroups.
191	Introduction	5	1	By profiling these driver lines, we develop an expression catalog for 67 Drosophila cell types as well as several broader cell populations.
192	Introduction	5	2	Through validation experiments and comparisons to the literature we demonstrate that this resource is useful both for identifying individual genes expressed in specific cell types and for revealing broader patterns such as the expression of all members of a gene family across many cell types.
193	Introduction	5	3	As an example, we describe the expression of neurotransmitters and their receptors and use this information to interpret synaptic connectivity.
194	Introduction	5	4	For example, we unexpectedly found that the R8 photoreceptors express acetylcholine in addition to histamine and show that this apparent co-transmitter phenotype is further supported by differential expression of neurotransmitter receptors in R8 postsynaptic partners.
195	Introduction	5	5	Our results demonstrate that combining expression and connectomes leads to specific testable hypotheses about circuit mechanisms that are inaccessible to either approach alone.
196	Results; Genetic tools for labeling the visual system	1	1	To enable transcriptome analyses of defined cell populations, we first assembled a collection of genetic drivers to access them.
197	Results; Genetic tools for labeling the visual system	1	2	For this study, we combined drivers from existing collections for cell types in the lamina (Tuthill et al., 2013), the mushroom body (Aso et al., 2014), and the lobula (Wu et al., 2016) with new driver lines for many additional optic lobe cell types and also some neurons of the central complex (Wolff and Rubin, 2018), T.
198	Results; Genetic tools for labeling the visual system	1	3	Wolff, personal communication).
199	Results; Genetic tools for labeling the visual system	1	4	Nearly all of these drivers were generated using an intersectional method, split-GAL4, to refine expression patterns of GAL4 driver lines.
200	Results; Genetic tools for labeling the visual system	1	5	To characterize new driver lines, we imaged expression patterns across the entire fly brain to determine overall driver specificity (Figure 1D, Figure 1-figure supplement 1) and examined anatomical features such as layer patterns in higher resolution images to identify specific cell types (Supplementary file 1A, Figure 1-figure supplement 2).
201	Results; Genetic tools for labeling the visual system	1	6	For most lines, we further confirmed the identity of labeled cells by examining the morphology of individual cells using stochastic labeling (Figure 1-figure supplement 2).
202	Results; Genetic tools for labeling the visual system	1	7	Although we noted that a few patterns also include some additional contaminating cells (Supplementary file 1A), these driver lines are the most specific tools currently available to access individual cell types in the optic lobe.
203	Results; Purifying nuclei with TAPIN	1	1	Next, we employed an improved INTACT method to measure nuclear transcriptomes in genetically defined cell populations (Henry et al., 2012), and we also developed a new variant of the method that permits higher throughput with increased purity and sensitivity.
204	Results; Purifying nuclei with TAPIN	1	2	In both approaches, nuclei are purified using a nuclear tag whose expression is driven in a cell population of interest by either a standard or split GAL4 driver (Figure 2A).
205	Results; Purifying nuclei with TAPIN	1	3	The new variant protocol, tandem affinity purification of INTACT nuclei (TAPIN), uses a bacterial protease (IdeZ) to specifically cleave antibodies in the hinge region separating their Fc and antigen binding F(ab’)_2 fragments (Figure 2B, Figure 2-figure supplement 1B).
206	Results; Purifying nuclei with TAPIN	1	4	Treating protein A magnetic bead-bound nuclei with this protease generates both nucleus-F(ab’)_2 and bead-Fc complexes.
207	Results; Purifying nuclei with TAPIN	1	5	Soluble nucleus-F(ab’)_2 is then recaptured on protein G magnetic beads, removing non-specifically bound material from the first capture.
208	Results; Purifying nuclei with TAPIN	1	6	INTACT successfully profiled many of the abundant cell types in the optic lobe (>1000 cells per brain), but failed for sparser cell types and those whose nuclei were difficult to purify by differential centrifugation (photoreceptors, glia, T4, T5).
209	Results; Purifying nuclei with TAPIN	1	7	We solved these problems with TAPIN, which does not purify nuclei prior to bead capture.
210	Results; Purifying nuclei with TAPIN	2	1	The greatest advantage of TAPIN is its ability to purify nuclei from sparse cell types (<50 cells/brain) (Supplementary file 1A).
211	Results; Purifying nuclei with TAPIN	2	2	INTACT is not suitable for these lines because of loss during differential centrifugation.
212	Results; Purifying nuclei with TAPIN	2	3	This difficulty cannot be overcome by processing more brains per experiment because differential centrifugation is difficult to scale.
213	Results; Purifying nuclei with TAPIN	2	4	TAPIN solves this problem by running a first capture on crude extracts generated from hundreds to thousands of fly heads.
214	Results; Purifying nuclei with TAPIN	2	5	The substantial background in this first capture is reduced 5- to 6- fold in a second capture with only a modest decline in both the yield of nuclei and amplified cDNA (Figure 2C).
215	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	1	We applied INTACT and TAPIN to the cell populations defined by the genetic drivers we described above (Supplementary file 1B).
216	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	2	Most drivers express in a single anatomically defined cell type or a small group of related cell types.
217	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	3	We note that a few of our cell types are strictly groups of related cell types (for example, the muscle cells or, at a different level of a cell type hierarchy, the T4 and T5 cells, with four subtypes each).
218	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	4	Additional drivers target more heterogeneous cell populations sharing a common property (e.g., driver lines aimed at recapitulating the expression of a neurotransmitter marker).
219	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	5	Altogether, we built 250 RNA-seq libraries from 242 samples of purified nuclei (46 using INTACT and 196 using TAPIN) and eight manually dissected samples (Supplementary file 1B).
220	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	6	We estimated relative transcript abundance in each library using kallisto (Bray et al., 2016).
221	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	7	Libraries built from more nuclei yielded more cDNA (Figure 2D), allowed more genes to be detected (Figure 2E), had more estimated transcripts (Figure 2-figure supplement 1C), more reproducible transcript abundance (Figure 2F), and less bias in coverage across gene bodies (Figure 2-figure supplement 1D,E).
222	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	8	We focused on 203 libraries that had at least 8500 genes detected, 3µg cDNA yield, and 0.85 Pearson’s correlation of transcript abundances in two biological replicates.
223	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	9	These 203 libraries consist of at least two biological replicates built from 100 drivers that covered 67 cell types (53 visual system, 7 mushroom body, 5 central complex, 2 muscle), 6 broader cell populations (ChAT, Gad1, VGlut, Kdm2, Crz, and NPF), and 2 manually dissected tissues (the lamina and remainder of the optic lobe) (Materials and methods).
224	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	10	We provide the read and abundance data for the remaining sub-optimal libraries (47 libraries covering 24 cell types) in the event they may be informative, but we do not consider these to be of sufficient quality and do not consider them further here.
225	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	1	11	We did not sort the sex of flies when preparing TAPIN-seq libraries, as we did not observe large differences in male and female expression profiles (Figure 2-figure supplement 1F).
226	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	2	1	We were encouraged by the clear enrichment of previously identified markers in cell types where they were expected.
227	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	2	2	For example, we recovered transcription factors (TFs) previously found in the developing monopolar interneurons and inner photoreceptors (Tan et al., 2015; Figure 2G).
228	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	2	3	We further confirmed our measurements by comparing TAPIN-seq results for twelve cell types that were also recently profiled by FACS-seq (Konstantinides et al., 2018; Figure 2-figure supplement 2A,B) and found concordant expression of cell type-enriched genes.
229	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	2	4	This concordance also argues against major differences between nuclear and cytoplasmic transcriptomes.
230	Results; Measuring transcriptomes with INTACT- and TAPIN-seq	2	5	In combination with the technical quality of our libraries, this confirmation by independent gene expression measurements validated our approach, and also motivated us to explore how to best interpret a large dataset of relative abundances.
231	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	1	1	Deriving biological insights from a matrix of transcript abundances is not straightforward.
232	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	1	2	While a cell’s expression of a gene can be used to infer a specific functional property of that cell, the level of expression that is needed to establish confidence in such an inference is much less clear.
233	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	1	3	For example, expressing the vesicular acetylcholine transporter (VAChT) implies that a neuron is cholinergic.
234	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	1	4	However, VAChT transcript abundance exhibits a wide distribution and it is not clear, a priori, what level is necessary to conclude that a cell is cholinergic (Figure 3A).
235	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	1	We used mixture modeling to address this challenge by describing the expression levels of each gene as arising from a mixture of two log-normal distributions representing binary ‘on’ and ‘off’ states (Figure 3A; Materials and methods).
236	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	2	Genes can of course express in more than two states, but we show through extensive validation that this simplifying assumption is a useful one.
237	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	3	Modelling VAChT expression in the high-quality TAPIN/INTACT-seq libraries unambiguously inferred VAChT states for all drivers (Figure 3B).
238	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	4	We also found that the model was useful for addressing transcript-carryover, evident in our data (as well as published bulk and single cell studies in the fly [Davie et al., 2018] and mouse [Siegert et al., 2012; Macosko et al., 2015]) as photoreceptor transcripts detected in non-photoreceptor cells (Figure 3-figure supplement 1A).
239	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	5	For example, the model correctly inferred that only R1-6 photoreceptors expressed the primary rhodopsin ninaE, although ninaE abundance in other cells reached as high as 2,702 TPM (the mushroom body cell type PAM_1) (Figure 3-figure supplement 1B,C).
240	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	6	We used this method to transform our catalog of transcript abundances to probabilities of expression (Figure 3C), observing a wide spectrum of on levels and dynamic ranges between on and off states (Figure 3-figure supplement 1D,E).
241	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	7	To further simplify these probabilities, we discretized them into on (p>=0.8) and off (p<=0.2) states, and otherwise considered them to be ambiguous (0.2 < p < 0.8).
242	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	8	The expression states inferred for replicates had a median 95% concordance (Figure 3-figure supplement 1F).
243	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	2	9	We combined information from replicates to infer expression at the driver and cell type levels (Materials and methods).
244	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	3	1	We found many genes that express in all cell types, and many that express in only one, with a range in between (Figure 3D,E).
245	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	3	2	As expected, given their roles in specifying identity, homeobox transcription factors (TF) expressed more specifically than transcription factors in general (Figure 3E).
246	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	3	3	Neuropeptides also expressed specifically, while genes with the more general function of synaptic vesicle endocytosis were broadly expressed.
247	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Interpreting transcript abundance with mixture modeling	3	4	We explore these functional properties in more detail later (Figure 4C).
248	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	1	To validate our TAPIN-seq measurements, we first compared our inferred expression states to FlyBase curated reports of protein expression (n = 197 data points of gene/cell pairs; four negative points, 193 positive points; n = 22 cells; n = 69 genes, Supplementary file 1C).
249	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	2	Protein expression can of course differ from that of the corresponding mRNA due to post-transcriptional regulation.
250	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	3	However, since most functional interpretations of transcriptome data are implicitly about protein expression, we used this as a more stringent and practical test of our model.
251	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	4	We found 93% concordance (183 matches; 14 mismatches from six genes; 0 mismatches for negative benchmark points; Figure 3-figure supplement 1G).
252	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	5	The benchmark mismatches fell into three categories: expression levels near the transition between inferred on and off components (veli, verm, para; Figure 3-figure supplement 1H-J), genes with a wide dynamic range of expression (Syx, Rab11; Figure 3-figure supplement 1K,L), and genes with undetected transcript but previously detected protein (Myo61F; Figure 3-figure supplement 1M).
253	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	6	The first two categories likely arise from imprecision in the model’s fitted components and its representation of transcript abundance as bimodal, rather than continuous.
254	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	1	7	The third category (conflicting transcript and protein levels) could reflect either technical issues (low sensitivity in our measurements, or false positives in the prior work due to antibody cross-reaction) or biological complexities (e.g., long-lived transcripts, subcellular localization, post-transcriptional regulation).
255	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	1	To further evaluate our results for genes expressed across a wide range of levels, we compared the model output to protein expression patterns for two transcription factors: Forkhead (fkh) and Ets65A.
256	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	2	We visualized each protein using a C-terminal GFP tag; the tagged proteins were expressed from BAC transgenes with large flanking sequences to ensure a near native genomic context (Kudron et al., 2018).
257	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	3	From the transcript data, we inferred fkh gene expression in 14 cell types across a 35-fold range of abundance (60 to 2,103 TPM).
258	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	4	Of 28 cell types that we visualized at the protein level, fkh was detected in all but one that we expected from TAPIN-seq (Figure 3F,G, Figure 3-figure supplement 2A).
259	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	5	The sole exception, Tm4, has a fkh abundance (60 TPM) near the border between the inferred off and on states (Figure 3F).
260	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	6	However, we did detect protein in Dm9, which had a near identical raw transcript abundance (61 TPM).
261	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	7	Similarly evaluating Ets65A expression identified two mismatches out of 11 tested cells (Figure 3H, Figure 3-figure supplement 2B).
262	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	8	Ets65a protein was not detected in Tm20 (70 TPM) and epithelial glia (161 TPM), while it was weakly detected in Dm3 (77 TPM).
263	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	9	These results further support the accuracy of TAPIN-seq and our statistical model even for genes with a wide dynamic range.
264	Results; Measuring transcriptomes with INTACT- and TAPIN-seq; Evaluating accuracy of TAPIN-seq measurements	2	10	The agreement between our transcript on/off calls and protein expression encouraged us to use the discretized on/off calls for all further analyses; the unprocessed relative abundances in TPM are reserved for deeper analysis when needed.
265	Results; Examining the relation between cell types using transcriptomes	1	1	To study the relation between cell types, we built a dendrogram based on the expression states we inferred for the whole transcriptome and estimated the support for each branch point with bootstrap resampling (Figure 4A).
266	Results; Examining the relation between cell types using transcriptomes	1	2	The broad groupings were well supported and mostly intuitive: muscle were outgroups, followed by a mushroom body cell type (PAM_4), the glia, the photoreceptors, and the remaining neurons.
267	Results; Examining the relation between cell types using transcriptomes	1	3	Several fine groupings of anatomically closely related neurons were also well supported (e.g., Kenyon cells; C2, C3; Lawf1, Lawf2; T4, T5; LPLC1, LPLC2).
268	Results; Examining the relation between cell types using transcriptomes	1	4	However, mid-level branchings were not well supported, indicating the lack of a simple hierarchical relationship.
269	Results; Examining the relation between cell types using transcriptomes	1	5	Neurons were generally grouped by region: central complex, mushroom body, and optic lobe.
270	Results; Examining the relation between cell types using transcriptomes	1	6	One surprise was the grouping of Tm20 and Dm1, away from all other optic lobe cell types.
271	Results; Examining the relation between cell types using transcriptomes	1	7	Upon closer examination, the identity of genes expressed exclusively in these two lines (lz, Pdh, bw) suggest that this grouping is driven by shared pigment cell contamination in the GAL4-tagged patterns of these driver lines.
272	Results; Examining the relation between cell types using transcriptomes	1	8	Similarly, the unusual position of PAM_4 is likely due to some unidentified non-neuronal cells in the driver.
273	Results; Examining the relation between cell types using transcriptomes	1	9	These are examples of imperfections in the GAL4 driver lines.
274	Results; Examining the relation between cell types using transcriptomes	1	10	While they can lead to some false positives for the main target cell types, they can also provide additional information.
275	Results; Examining the relation between cell types using transcriptomes	1	11	For example, analyzing the overlap between Dm1 and Tm20 allowed us to infer marker genes expressed in the pigment cell population.
276	Results; Identifying genes that mark cell types and groups	1	1	We next identified genes that marked cell groups in the tree, using three criteria: genes that expressed in all the cells within a group, at most two cells outside this group, and with transcript abundance higher than all cells outside the group (For simplicity, we will hereon refer to cell type as just cell.
277	Results; Identifying genes that mark cell types and groups	1	2	This is not meant to exclude the possibility of heterogeneity within the individual cells of a profiled population.).
278	Results; Identifying genes that mark cell types and groups	1	3	We used these criteria to identify markers for photoreceptors (n = 108), glia (n = 60), and muscle (n = 76) (Figure 4B, Supplementary file 1D).
279	Results; Identifying genes that mark cell types and groups	1	4	These genes included many known as well as new markers.
280	Results; Identifying genes that mark cell types and groups	1	5	For example, genes enriched in photoreceptors include signaling components (Arr2, Galphaq) and transporters (trpl, Eaat2) with known physiological roles as well as uncharacterized orphan transporters (e.g., CG8468).
281	Results; Identifying genes that mark cell types and groups	1	6	We also identified 18 markers for pigment cells using the Tm20 and Dm1 profiles.
282	Results; Identifying genes that mark cell types and groups	1	7	In addition to the three types of lamina glia we profiled, several other glia types are present in both the lamina and the medulla.
283	Results; Identifying genes that mark cell types and groups	1	8	Genes expressed exclusively in the dissected samples (lamina, remainder of optic lobe) and not in the TAPIN libraries identified marker genes for optic lobe cells that we did not directly profile, such as medulla glia.
284	Results; Identifying genes that mark cell types and groups	1	9	Indeed, the genes identified in this way included several known markers for astrocytes (alrm, wun2, Obp44a) (Huang et al., 2015).
285	Results; Identifying genes that mark cell types and groups	2	1	We examined the breadth of expression of different functional groups of genes, as defined by FlyBase gene group curation.
286	Results; Identifying genes that mark cell types and groups	2	2	HOX-like homeobox TFs were among the most specifically expressed group, while groups of core cellular machinery (e.g., beta importins, mitochondrial complexes) were among the most broadly expressed groups (Figure 4C).
287	Results; Identifying genes that mark cell types and groups	2	3	Some groups included both broadly and very specifically expressed genes.
288	Results; Identifying genes that mark cell types and groups	2	4	For example, among cell adhesion molecules, we noted an interesting distribution for three gene groups proposed to be involved in protein-protein interactions that underlie synaptic connectivity (Özkan et al., 2013; Tan et al., 2015; Carrillo et al., 2015).
289	Results; Identifying genes that mark cell types and groups	2	5	While 11 DPR-interacting proteins (DIP) were among the most specifically expressed genes (expressed in a median of 6 cells), beat (median, 25.5 cells) and DPR (median, 51 cells) genes were more broadly expressed (Figure 4-figure supplement 1A-D).
290	Results; Identifying genes that mark cell types and groups	2	6	As physical interactions among these and other extracellular proteins have been systematically characterized (Özkan et al., 2013), we combined their expression and interaction patterns to estimate the number of potential interaction between cells in the lamina (Figure 4-figure supplement 1E), many of which are in actual contact (Figure 4-figure supplement 1F).
291	Results; Identifying genes that mark cell types and groups	2	7	Except for a clear paucity of transcripts encoding interacting protein pairs expressed by glia, these global expression-based patterns did not correlate well with connectivity in the lamina.
292	Results; Identifying genes that mark cell types and groups	2	8	However, we found that every pair of lamina cells expressed mRNAs for tens of interacting protein pairs, highlighting the broad potential for cell-cell interactions not only in the developing (Tan et al., 2015) but also adult optic lobe.
293	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	1	1	To ask whether we could identify genes distinguishing closely related cell types, we examined T4 and T5.
294	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	1	2	These cells had similar transcriptomes and were neighbors in the phylogenetic tree, but we found one transcription factor, TfAP-2, that was expressed nearly two orders of magnitude higher in T4 (390 TPM) than T5 (6 TPM) (Figure 4D).
295	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	1	3	We confirmed this pattern at the protein level (Figure 4E,F).
296	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	2	1	T4 and T5 cells can each be further divided into four subtypes that preferentially respond to motion in one of four cardinal directions and differ in anatomical details such as the lobula plate layer to which they project axons.
297	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	2	2	While our split-GAL4 lines do not isolate single T4/T5 subtypes, the T5_d1 and T5_d2 drivers show differences in subtype expression (Figure 1-figure supplement 1B,B’,C,C’).
298	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	2	3	Comparing the transcriptomes of these two drivers confirmed previously described markers (Con, bi, dac; Apitz and Salecker, 2018) that distinguish T4/T5 cells of lobula plate layers 1/2 and 3/4, and indicated additional genes, including a transcription factor (dysf) and cell adhesion molecules (klg, Dscam3) with selective expression in these subtypes (Figure 4G).
299	Results; Identifying genes that mark cell types and groups; Transcriptomes can distinguish closely related cell types and subtypes	2	4	As a further confirmation of this finding, we verified that a tagged klg protein showed layer-specific expression in the lobula-plate consistent with these T4/T5 subtypes (Figure 4H).
300	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	1	Single cell RNA-seq (scRNA-seq) was recently used to map the optic lobe (Konstantinides et al., 2018) and brain (Davie et al., 2018).
301	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	2	Despite its routine use, interpreting scRNA-seq measurements - clustering single cell transcriptomes and labeling these clusters as known cell types - remains challenging.
302	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	3	For example, the 52 single cell clusters found in the optic lobe (23 labeled as known cell types, including 7 types of glia; Konstantinides et al., 2018) and the 87 clusters found in the whole brain (41 labeled, also including seven glia; Davie et al., 2018) far under-estimate the expected diversity of cell types - over one hundred anatomically distinct neuronal cell types have been described in the optic lobe alone (Fischbach and Dittrich, 1989; Morante and Desplan, 2008; Otsuna and Ito, 2006; Nern et al., 2015; Wu et al., 2016).
303	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	4	Furthermore, comparing the number of single cells in each optic lobe cluster to the true abundance of each cell type (as established by neuroanatomical studies) reveals that the single cell map does not proportionally represent abundance (ranging from ~5 times fewer Dm8/Tm5c cells to ~7 times more Dm12 cells than expected in the optic lobe map; Figure 5A).
304	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	5	The whole brain map, measured using the more sensitive 10X scRNA-seq platform rather than Drop-seq used for the optic lobe map (Svensson et al., 2017), showed similar cell type abundances (Figure 5B).
305	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	6	Without detailed neuroanatomy to serve as ground-truth, this similarity could be interpreted as reproducibility across platforms.
306	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	7	Instead, our results suggest caution when interpreting cell type frequencies from scRNA-seq maps, as they can be skewed by experimental artifacts such as cell type-specific differences in RNA isolation yields, computational over-clustering, or inaccurate cell type labeling.
307	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	1	8	Given the known number of cell types and their frequencies, it is clear that interpreting single cell measurements is challenging.
308	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	1	Comparison with our data reveals additional challenges in mapping scRNA-seq clusters to known cell types.
309	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	2	To compare our data to the brain map, we used non-negative least squares regression to model each TAPIN-seq transcriptome as a linear weighted sum of single cell cluster transcriptomes, assuming that large regression coefficients reflect matching cell types (Davie et al., 2018; Cao et al., 2019).
310	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	3	We interpreted the results of this comparison against an ideal scenario where single cell clusters were perfectly resolved and accurately labeled, and assuming that the driver lines used for TAPIN-seq profiling had minimal expression outside of the main target cell type.
311	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	4	In this scenario, we would expect a unique cluster matching each of our TAPIN-seq profiles of cell type-specific driver lines, as well as many unmatched clusters, reflecting cell types that we did not profile.
312	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	5	However, we observed few one-to-one matching clusters for our TAPIN-seq profiles (e.g., T1, Tm1, Dm8, Dm9, Pm3), several one-to-many matches (e.g., photoreceptor cluster #53 matching our R1-6, R7, R8-Rh5, and R8-Rh6 profiles; also, L1-5 cluster #20, Lawf1/2 cluster #58, and T4/T5 cluster #24), clusters with no TAPIN-seq matches (e.g., clusters #7, 15, 23), as well as TAPIN-seq cell types without a matching cluster (e.g., Dm4, Dm11, Mi4, Tm2, Tm20, LPLC1) (Figure 5C).
313	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	6	The matches confirmed several clusters labeled as single cell types (e.g., Tm1, Mi1) or multiple cell types (e.g., photoreceptors, L1-5, Lawf1/2, T4/5, Kenyon cells) and also suggested possible labels for previously unlabeled clusters (e.g., Dm8 cluster #52, Dm9 cluster #74, pigment cell cluster #76) and alternative labels for previously labeled clusters (e.g., TmY5a TAPIN matches the TmY14 cluster #11; Lai TAPIN matches Dm8/Tm5c cluster #39).
314	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	7	We observed similar results when analyzing the optic lobe map, with few apparent single cell - TAPIN-seq matches (Figure 5-figure supplement 1).
315	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	2	8	Although this result could arise from major errors in our TAPIN-seq profiles, this possibility is unlikely given our earlier validation results and the concordance between our TAPIN-seq profiles and cell type-enriched genes identified from independent FACS-seq measurements (Figure 2-figure supplement 2).
316	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	3	1	As a separate comparison of the bulk and single cell profiles, we examined the bulk expression of genes marking each single cell cluster (Figure 5-figure supplement 2).
317	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	3	2	Confirming the regression results, this analysis also found few one-to-one matches in which single cell cluster markers were enriched in only a single TAPIN-seq profile.
318	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	3	3	Instead, most cluster markers were either enriched in multiple bulk cell types (over-clustering), or were not enriched in our data (cell types we did not profile by TAPIN-seq).
319	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	3	4	As before, many TAPIN-seq profiles were not enriched for cluster markers, reflecting cell types that were either missing or clustered with other cell types in the single cell map.
320	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	1	We further explored specific examples where the TAPIN-seq data offered new insight into the single cell maps by suggesting alternative labels or labeling unannotated clusters.
321	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	2	The single cell clusters labeled as TmY14 matched the TmY5a TAPIN profile (Figure 5C).
322	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	3	The cluster was originally labeled based on the expression of a single transcription factor, knot (kn), as determined using a kn-GAL4 reporter.
323	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	4	We also observed kn expression in our TmY5a measurements and further confirmed its expression in both TmY14 and TmY5a cells using the kn-GAL4 reporter line, suggesting that the cluster likely includes not only TmY14 cells, but also TmY5a and other kn-expressing cells (Figure 5-figure supplement 3).
324	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	5	Similarly, we found that the Dm2 cluster (optic lobe cluster #55), which was labeled based on a Dm2 FACS-seq profile, matched our Mi15 profile (Figure 5-figure supplement 2A).
325	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	6	This observation is concordant with previous reports that the line used to FACS sort Dm2 also expresses in Mi15 (Supplementary Figure 2 in Takemura et al., 2013, Supplementary file 1 Table S4 in Nern et al., 2015).
326	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	7	Finally, we found that the Dm8/Tm5c cluster (brain cluster #39) matches our Lai TAPIN-seq profile, while unlabeled clusters match our Dm8 and Dm9 TAPIN-seq profiles (Figure 5D).
327	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	8	Our measurements also suggest labels for other previously unannotated clusters, such as brain cluster #76 which likely reflects pigment cell, as demonstrated by enrichment of its marker genes in both Dm1 and Tm20 profiles - both measured with lines that also express in pigment cells (Figure 5-figure supplement 2B).
328	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	9	As expected, the genes marking this cluster include known pigment cell markers (e.g., Pdh, rdhB).
329	Results; Reference bulk transcriptomes help interpret single cell transcriptomes	4	10	Altogether, our results demonstrate that cell type-identified data, such as bulk transcriptomes, can help interpret single cell RNA-seq measurements.
330	Results; Profiles identify candidate neurotransmitter output for most neuron types	1	1	The proteins that synthesize and transport neurotransmitters are well known, enabling us to use their expression to predict neurotransmitter phenotype.
331	Results; Profiles identify candidate neurotransmitter output for most neuron types	1	2	We used histamine decarboxylase (Hdc), glutamate decarboxylase (Gad1), the vesicular acetylcholine transporter (VAChT), and the vesicular glutamate transporter (VGlut) to identify potential histaminergic, GABAergic, cholinergic, and glutamatergic cell types, respectively (Figure 6A).
332	Results; Profiles identify candidate neurotransmitter output for most neuron types	1	3	Our model unambiguously inferred expression states for these genes and indicated a single transmitter (from this group) for nearly all neurons we profiled.
333	Results; Profiles identify candidate neurotransmitter output for most neuron types	1	4	A second cholinergic marker, choline acetyltransferase (ChaT), matched VAChT expression almost perfectly (the two genes also share an exon).
334	Results; Profiles identify candidate neurotransmitter output for most neuron types	1	5	The sole exception, apparent expression of ChAT but not VAChT in R7 photoreceptors, likely results from a subset of dorsal rim R8 cells labeled by the R7 driver line (further discussed below, also see Supplementary file 1A).
335	Results; Profiles identify candidate neurotransmitter output for most neuron types	2	1	Besides these four neurotransmitters that we identified by one or two marker genes, we also identified candidate dopaminergic neurons based on the combined expression of tyrosine hydroxylase (ple), dopa decarboxylase (ddc), vesicular monoamine transporter (Vmat) and dopamine transporter (DAT).
336	Results; Profiles identify candidate neurotransmitter output for most neuron types	2	2	While DAT, ple, and ddc were also expressed individually in several cell types that did not express Vmat, only known dopaminergic cell types and one medulla neuron (Mi15) expressed this combination (Figure 6A).
337	Results; Profiles identify candidate neurotransmitter output for most neuron types	3	1	One neuronal cell type, T1, expressed none of the neurotransmitter markers VGlut, VAChT, Vmat, and Gad1 (Figure 6A).
338	Results; Profiles identify candidate neurotransmitter output for most neuron types	3	2	Although T1 does express most pan-neuronal genes, it does not express bruchpilot (brp), a key component of presynaptic active zones.
339	Results; Profiles identify candidate neurotransmitter output for most neuron types	3	3	Consistent with this result, EM reconstruction has identified very few T1 presynaptic specializations (Takemura et al., 2008).
340	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	1	Transmitters for nearly half of our cell types have been previously proposed and generally agree with our results.
341	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	2	For example, VAChT/ChAT expression in Kenyon cells supports recent reports showing they are cholinergic (Barnstedt et al., 2016; Crocker et al., 2016).
342	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	3	Fluorescence in situ hybridization and immunolabeling guided by our measurements confirmed the expression of ChAT, Gad1, and VGlut in Mi1, Mi4, and Mi9, respectively (Long et al., 2017; Takemura et al., 2017).
343	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	4	However, we see considerable differences between our assignments and some previous work that used reporter transgenes (Raghu and Borst, 2011; Varija Raghu et al., 2011; Raghu et al., 2013), which we generally attribute to unfaithful transgene expression patterns.
344	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	5	We believe our assignments to be more reliable, however they are not without problems.
345	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	6	For example, one assignment inferred by our model that seems unlikely and is not supported by other available data is the presence of Gad1 in Mi9, which was not detected in the FISH or antibody experiments mentioned above.
346	Results; Profiles identify candidate neurotransmitter output for most neuron types	4	7	Given the presence of some contaminating Mi4 cells in at least one Mi9 driver and the lower Gad1 abundance (mean 276 TPM in Mi9; 2165 TPM in Mi4; 1870 mean TPM in predicted GABAergic cells), we attribute the Mi9 Gad1 signal to contaminating contributions from other GABAergic cells such as Mi4.
347	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	1	We next tried to identify transcriptional regulators of neurotransmitter output, by searching for TF genes expressed in strong correlation with transmitter phenotype.
348	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	2	However, we only found such TFs for histaminergic output (Figure 6-figure supplement 1A), which in our dataset is only represented by photoreceptor neurons.
349	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	3	This observation agrees with work on neuronal identity showing that single TFs rarely encode transmitter identity, but rather different TFs and TF combinations are used to specify the same neurotransmitter output (Hobert, 2016).
350	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	4	We thus expanded our search to TFs whose expression was informative about transmitter phenotype (i.e., cells expressing TF A are likely to produce neurotransmitter B; even if not all cells producing neurotransmitter B express TF A; Figure 6-figure supplement 1A).
351	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	5	This search identified candidate TFs for nearly all neurotransmitter types.
352	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	6	For example, the 19 neuronal types (including the broad chat-GAL4 line) expressing apterous (ap) are cholinergic.
353	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	7	Its worm ortholog, ttx-3, regulates the cholinergic phenotype of the AIY neuron (Wenick and Hobert, 2004).
354	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	8	Several other TFs we identified also have worm or mouse orthologs implicated in neuronal identity (Figure 6-figure supplement 1B).
355	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	9	Several TFs appeared to identify a transmitter phenotype within a group of cell types but not across the entire dataset.
356	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	10	For example, Lim3 distinguishes the GABAergic Dm10 from the other Dm cell types in our dataset and is also expressed in several other GABAergic cells (Mi4, Pm3, Pm4) but was also detected in the cholinergic LC4 and the glutamatergic TmY5a and Tm29.
357	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	11	We confirmed the differential Lim3 protein expression in Dm10 and Dm12 cells (Figure 6-figure supplement 1C).
358	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	12	Several of the transcription factors that we found to be informative of neurotransmitter output were also implicated by single cell RNA-seq data, including ap (cholinergic), tj (glutamatergic), and Lim3 (GABAergic) (Konstantinides et al., 2018).
359	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	13	Our data also indicate exceptions to these patterns (i.e., neurons expressing tj and Lim3 but with a different neurotransmitter phenotype; Figure 6-figure supplement 1A).
360	Results; Profiles identify candidate neurotransmitter output for most neuron types; Transcriptional regulation of neurotransmitter output	1	14	These observations indicate that neuronal features are likely regulated in a context-dependent and combinatorial manner, and that transcriptomes can identify putative regulators.
361	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	1	1	Co-release of multiple neurotransmitters can enhance the signaling capacity of neurons and neural circuits.
362	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	1	2	For example, the same cell type might release different transmitters under distinct conditions or use them to elicit distinct responses in different target cells.
363	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	1	3	In addition to Mi9 (discussed above as being likely due to contamination), we observed two cases of potential co-transmission involving the canonical small molecule neurotransmitters.
364	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	1	4	Both Mi15 drivers express dopaminergic and cholinergic markers, and both R8 drivers expressed cholinergic and histaminergic markers.
365	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	1	5	We confirmed expression of Vmat protein in Mi15 (Figure 6B), the first identified columnar dopaminergic cell type within the optic lobe, and further below we confirm the unexpected VAChT expression in R8 (Figure 8A).
366	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	2	1	Evidence for co-transmission involving additional molecules, such as neuropeptides or nitric oxide, appears frequently in our data set.
367	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	2	2	Nitric oxide is a widely conserved signaling molecule that can act on many kinds of cells, including neurons (Lowenstein and Snyder, 1992).
368	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	2	3	We observed very specific expression of its synthesizing enzyme, nitric oxide synthase (Nos), in the lamina (C2, C3, and Lawf2) and medulla (Mi4, Pm4, Tm4 and Mi15).
369	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	2	4	To further validate these results, we confirmed Nos expression at the protein level in C3 neurons (Figure 6C).
370	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	2	5	Nitric oxide can be released extra-synaptically, potentially enabling signaling between neurons that are not synaptic partners.
371	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	3	1	Several neuropeptides and their receptors were also expressed in distinct patterns suggesting widespread yet specific peptidergic signaling in the visual system (Figure 6D).
372	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	3	2	For example, AstA was observed in just one cell type (Pm3; confirmed at the protein level; Figure 6E), while AstC was expressed in several cell types, and pigment-dispersing factor (Pdf) was expressed in none of the optic lobe cells we profiled.
373	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	3	3	The receptors for all three of these neuropeptides were more broadly expressed (Figure 6D).
374	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	3	4	The broad expression of Pdf receptor (Pdfr) is consistent with the extensive arborization previously observed for Pdf-expressing neurons at the surface of the medulla.
375	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	4	1	While we focused on genes with well-known functions, our expression patterns also suggest new functions for poorly characterized genes (Figure 6A).
376	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	4	2	For example, photoreceptors specifically expressed CG8468, an orphan transporter in the solute carrier 16 (SLC16) family of monocarboxylate transporters.
377	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	4	3	This gene might represent a candidate vesicular or plasma membrane transporter of histamine, which remains unidentified in any species.
378	Results; Profiles identify candidate neurotransmitter output for most neuron types; Co-expression of canonical small molecule transmitters with non-canonical transmitters is widespread	4	4	We also observed photoreceptor-specific expression of CG45782 (lovit), a member of the SLC45 sucrose transporter family recently reported as a putative histamine transporter (Xu and Wang, 2019).
379	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	1	1	Since the functional consequences of the release of a neurotransmitter depend on which receptors for this transmitter are expressed in the receiving cell, measuring the expression of both neurotransmitter input and output genes is necessary to assign potential synaptic signs to connectomes.
380	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	1	2	For example, glutamatergic transmission in Drosophila may be either inhibitory or excitatory, depending on the receptors.
381	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	1	In general, neurotransmitter receptors are broadly expressed, qualifying each cell type to detect multiple neurotransmitters (Figure 7A).
382	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	2	Patterns for individual receptors (or receptor subunits) varied widely.
383	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	3	Some receptors, such as the GluClalpha glutamate-gated chloride channel, thought to be the main mediator of inhibitory glutamatergic transmission in flies, were expressed in most but not all cell types (Figure 7A,B).
384	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	4	Expression of others was much more restricted, such as the EKAR glutamate receptor subunit detected only in photoreceptor neurons, consistent with previous work (Hu et al., 2015).
385	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	5	Nearly all cells expressed receptors for acetylcholine, GABA, and glutamate, as expected from the combination of predicted transmitter phenotypes and connectomics data.
386	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	6	Receptors for neuromodulators such as serotonin, dopamine, octopamine, and neuropeptides in general were also widespread (Figure 6D).
387	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	7	For example, octopamine receptors were expressed in broad, yet gene- and cell-type specific patterns, consistent with widespread octopaminergic modulation of visual processing (for example, Arenz et al., 2017; Strother et al., 2018; Tuthill et al., 2014).
388	Results; Profiles identify candidate neurotransmitter output for most neuron types; Broad and patterned expression of neurotransmitter receptors	2	8	We confirmed Oamb expression at the protein level in specific lamina neurons and glia, including Lawf2 cells previously shown to be octopamine sensitive (Tuthill et al., 2014; Figure 7C).
389	Results; Combining transcriptomes and connectomes	1	1	A principal goal of our work is to provide a foundation for combining molecular data such as neurotransmitter and receptor expression patterns with anatomical or functional connectivity data.
390	Results; Combining transcriptomes and connectomes	1	2	One application of expression information is to constrain mechanistic models of neural circuits such as the extensively studied motion detection circuit in the fly eye (reviewed in Mauss et al., 2017; Figure 7-figure supplement 1A).
391	Results; Combining transcriptomes and connectomes	1	3	The combined availability of expression and connectomics data for many cell types in a brain region also makes it possible to systematically identify and further explore unusual patterns of receptor or transmitter expression; for example, cell types in which an otherwise widely expressed receptor is absent or cells with unusual combinations of receptor subunits.
392	Results; Combining transcriptomes and connectomes	1	4	Below we discuss three examples, focused on potential signs of synaptic transmission, of how such patterns can lead to specific and unexpected hypotheses about circuit function.
393	Results; Combining transcriptomes and connectomes	1	5	As we illustrate, combining expression data with synapse-level anatomy permits analyses which are inaccessible to either approach alone.
394	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	1	1	Fly photoreceptors have long been known to release histamine (Hardie, 1987; Sarthy, 1991).
395	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	1	2	Our data indicate that inner (color vision) R8 photoreceptors also express the cholinergic markers ChAT and VAChT, suggesting an unexpected additional cholinergic phenotype (Figure 6A).
396	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	1	3	To confirm these results, we visualized a tagged VAChT protein (VAChT-HA; Pankova and Borst, 2017), expressed from the endogenous locus, selectively in photoreceptor cells.
397	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	1	4	These experiments showed VAChT-HA labeling in medulla terminals of R8 but not R7 cells (Figure 8A,A’,A’’,B), including the specialized polarized light-responsive R8-cells in the dorsal rim of the medulla.
398	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	1	5	The latter express the rhodopsin Rh3 (which is otherwise expressed in R7s; Fortini and Rubin, 1990), consistent with the presence of ChAT and VAChT transcripts in the R7 driver line (for which the model inferred expression for VAChT but not ChAT).
399	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	2	1	We asked whether the apparent co-transmitter phenotype of R8 neurons was reflected in the expression of neurotransmitter receptors in their different postsynaptic partners.
400	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	2	2	Postsynaptic partners of R8 cells identified by electron microscopy reconstructions include seven cell types in our dataset: Dm9, Mi1, Mi4, Mi15, R7, L1 and Tm20 (Figure 8C; Takemura et al., 2013; Takemura et al., 2015).
401	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	2	3	All of these express one or more nAChR subunits (Figure 7A).
402	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	2	4	By contrast, expression of the histamine-gated chloride channels HisCl1 and ort, which mediate histaminergic transmission by photoreceptors (Pantazis et al., 2008), was more selective (Figure 8C,D): L1, Tm20 and Dm9 express ort, consistent with previous reports (Gao et al., 2008), while HisCl1 transcripts were detected in the R7 as well as R8 driver lines, in agreement with another recent report (Schnaitmann et al., 2018; Tan et al., 2015).
403	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	2	5	However, we did not find evidence of expression of ort or HisCl1 in Mi4, Mi1 and Mi15, further supporting R8 signaling via a transmitter other than histamine.
404	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	1	We were interested in whether release of ACh and histamine might occur at spatially distinct locations.
405	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	2	Insect synapses often consist of multiple postsynaptic sites apposed to the same presynapse.
406	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	3	For cells that release more than one transmitter, two general distributions of postsynaptic processes at such multicomponent synapses are possible (Figure 8E).
407	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	4	Postsynaptic cells with different receptors could be grouped at different sites based on receptor expression (Figure 8E-left) or occur together at the same locations (Figure 8E-right).
408	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	5	To distinguish these possibilities for R8 cells, we used EM reconstruction data (Takemura et al., 2013) to map the predicted expression of histamine receptors in postsynaptic cells at the single synapse level for all presynaptic sites of one reconstructed R8 cell (Figure 8F).
409	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	6	The resulting pattern indicates that processes of cell types with and without histamine receptor expression are often located near the same R8 presynapse (Figure 8F), whereas this is not the case for a reconstructed R7 cell (Figure 8G).
410	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	7	This is consistent with the VAChT-HA labeling observed throughout the medulla terminals of R8s (Figure 8A).
411	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	3	8	This spatial pattern is compatible with either co-release of histamine and ACh or independently regulated release from different vesicles at the same sites.
412	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	4	1	A combined cholinergic and histaminergic phenotype has been reported for a small group of extraretinal photoreceptors (the Hofbauer-Buchner eyelet) located near the lamina (Yasuyama and Meinertzhagen, 1999) but was unexpected for R-cells of the compound eye.
413	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	4	2	Establishing the functional significance of potential acetylcholine release by R8 cells will require further experiments.
414	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	4	3	However, we note that double mutants lacking both histamine receptors are not completely blind (Gao et al., 2008), consistent with histamine-independent transmission by photoreceptor neurons.
415	Results; Combining transcriptomes and connectomes; Presynaptic cholinergic markers and absence of histamine receptors in some postsynaptic targets: R8 photoreceptors may signal via two fast transmitters	4	4	In addition, a very recent study suggests a role of cholinergic R8 signaling in the entrainment of the fly’s circadian rhythm to light-dark cycles (Alejevski et al., 2019), perhaps similar to that of ACh-release from the Hofbauer-Buchner eyelet (Schlichting et al., 2016).
416	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	1	Fast GABAergic transmission via GABA-A receptors is a major source of inhibition in the nervous system.
417	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	2	However, some GABA-A subunit combinations could mediate depolarizing GABA-signaling: in vitro assays indicate that homomeric Rdl or heteromeric Rdl/Lcch3 receptors are typical GABA-gated chloride channels (Zhang et al., 1995), while Lcch3/Grd form GABA-gated cation channels (Gisselmann et al., 2004).
418	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	3	However, the in vivo significance of this difference is unknown.
419	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	4	Rdl and Lcch3 were expressed in nearly all neurons in our dataset (Figure 7A, Figure 9A,B), consistent with the general inhibitory nature of GABA signaling.
420	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	5	By contrast, Grd and another predicted GABA-A receptor subunit, CG8916, were expressed in a minority of cell types (Figure 7A, Figure 9A,B).
421	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	6	Photoreceptor neurons, for which no major GABAergic inputs have been identified by connectomics, expressed none of the four transcripts (Figure 9B).
422	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	7	Lamina monopolar L1 and L2 were the only neurons other than photoreceptors that did not express significant levels of Rdl.
423	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	8	However, both express Grd, Lcch3 and also CG8916.
424	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	9	Together with the in vitro findings mentioned above, this result suggests that some or all GABA-A receptors in L1 and L2 may be cation rather than chloride channels.
425	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	10	Remarkably, lamina monopolar cells in the housefly Musca, which are thought to have very similar functional properties to those in Drosophila, depolarize in response to GABA (Hardie, 1987) but hyperpolarize in response to histamine (via ort-containing chloride channels).
426	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	1	11	Thus our data identify a potential link between in vivo electrophysiology, in vitro receptor properties and cell type differences in GABA-A subunit (Rdl or Grd) expression.
427	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	1	We next asked whether depolarizing GABA-signaling to L1 and L2 was plausible given their synaptic connectivity.
428	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	2	Based on synapse counts and our transmitter data, the main GABAergic inputs to L1 and L2 are C2 and C3 neurons (Meinertzhagen and O'Neil, 1991; Rivera-Alba et al., 2011; Takemura et al., 2013; Takemura et al., 2015).
429	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	3	Conversely, L1 is the main input to both C2 and C3 cells, followed by the cholinergic L1 targets L5 and Mi1.
430	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	4	These strong connections (illustrated for C2 in Figure 9C) indicate that the effective sign of GABA input to L1 and L2 is almost certainly of functional significance.
431	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	5	In the illustrated circuit (Figure 9C), L1 cells hyperpolarize in response to luminance increases (as histamine from photoreceptors opens ort chloride channels).
432	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	6	The resulting reduced secretion of glutamate is thought to depolarize L1 targets such as Mi1 (via closing of GluClalpha channels).
433	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	7	One plausible, though speculative scenario, is that similar to Mi1, C2 cells also depolarize in response to light.
434	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	8	In this case, GABA-gated cation channels in L1 (formed by Grd and Lcch3) would enable negative feedback (counter-acting) from C2 to L1, which for example could return the membrane potential closer to resting levels - speeding up the response to subsequent luminance changes.
435	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	9	By contrast, opening of conventional GABA-A receptors (GABA-gated chloride channels) in L1 would resemble a light response (opening of histamine-gated chloride channels), and thus provide positive (reinforcing) feedback in this case.
436	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	10	The latter possibility appears less consistent with the transient nature of the L1 (and L2) response to light (Jarvilehto and Zettler, 1971; Laughlin and Hardie, 1978).
437	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	2	11	Distinguishing these and other possibilities will of course require future experimental work.
438	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	3	1	Similar to the findings for histamine receptors described above (Figure 8F), again using connectivity data for the medulla, we observed that cells with different GABA-A profiles can be postsynaptic at the same synapse (Figure 9D).
439	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	3	2	In addition to L1 and L2, Grd expression indicated several other candidates for cells with unusual GABA responses (Figures 7A and 9B).
440	Results; Combining transcriptomes and connectomes; Potentially excitatory GABA-A receptors in lamina monopolar cells	3	3	In these neurons (e.g., Dm8 or Mi4), Rdl and Grd were detected together, raising questions such as whether their subcellular distribution is synapse-specific or whether these subunits might co-assemble into channels with yet unexplored properties.
441	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	1	The diverse expression of glutamate receptor subunits, which can mediate both inhibitory and excitatory signaling, was particularly striking in the lamina (Figures 7A and 9E,F).
442	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	2	Notable patterns include the photoreceptor-specific expression of EKAR, the predicted absence of GluClalpha, otherwise broadly expressed in neurons, from some cell types, including photoreceptors (Figures 7A and 9F) and its strong expression in epithelial glia.
443	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	3	CG3822, a Kainate-type receptor subunit recently reported to function in presynaptic homeostatic control at the neuromuscular junction (Kiragasi et al., 2017), was strongly enriched in the lamina intrinsic Lai cells.
444	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	4	Since Lai neurons are the only known source of vesicular glutamate release in the lamina, CG3822 function in Lai is predicted to also be pre- or perhaps extrasynaptic.
445	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	5	T1 and L3, while not expressing VGlut, might also influence glutamate levels in the lamina via the Eaat1 plasma membrane glutamate transporter.
446	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	6	The strong expression of this transporter in T1 rather than glia is another unusual feature of glutamatergic signaling in the lamina and may be a clue to the enigmatic function of T1 cells (Tuthill et al., 2013).
447	Results; Combining transcriptomes and connectomes; Diverse patterns of glutamate receptor expression in the targets of a single local interneuron type in the lamina	1	7	These examples further highlight how a transmitter released by one neuron type, here Lai, is predicted to have very different effects on target cells due to the receptors they express.
448	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	1	1	The combination of highly specific EKAR expression and the unusual absence of GluClalpha in photoreceptors prompted us to further explore cellular sources and potential functions for glutamatergic signaling to photoreceptor neurons.
449	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	1	Photoreceptor neurons function over an extremely wide range of light levels, from moonlight to bright sunlight.
450	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	2	One mechanism proposed to enable this behavior is a depolarizing feedback signal from photoreceptor targets that increases photoreceptor output under low light conditions, but reduces output at higher light intensities (Zheng et al., 2009).
451	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	3	As Lai cells express ort, and thus, like other ort-expressing photoreceptor targets, are thought to hyperpolarize in response to light, increased glutamate release from Lai could provide such light-dependent feedback via EKAR in R-cells.
452	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	4	This scenario is consistent with reduced photoreceptor responses at low light intensities after reduction of Lai output or EKAR function (Hu et al., 2015).
453	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	5	EKAR is also expressed in R7 and R8 cells, which project to the medulla and are not postsynaptic to Lai.
454	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	2	6	We therefore asked whether there might be a medulla counterpart of Lai neurons.
455	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	3	1	Synaptic connectivity data identify Dm9 as a strong candidate for such a role: Dm9 is both a major pre- and postsynaptic partner of R7 and R8; it is the only identified R7/R8 target with these properties (other known R7 or R8 targets appear to form few if any feedback synapses on these cells).
456	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	3	2	Remarkably, the overall anatomy of Dm9 cells is also very similar to Lai (Figure 9G,H): Both Lai and Dm9 cells span multiple visual columns but the precise number and distribution of columns innervated by each individual cell is variable.
457	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	3	3	Finally, Lai and Dm9 share key molecular properties: for example, both are glutamatergic and express ort histamine receptors.
458	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	3	4	Based on connectivity and gene expression (Figure 9F,J), Dm9 cells are predicted to receive hyperpolarizing R7 and R8 input via ort and excitatory input from the photoreceptor targets L3 and Dm8.
459	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	3	5	Thus, similar to Lai (Figure 9G,I), Dm9 appears qualified to increase photoreceptor output in the medulla under low light conditions, similar to a proposed function of Lai in the lamina.
460	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	4	1	One notable difference between Lai and Dm9 is that in contrast to Lai, Dm9 cells receive input from photoreceptor neurons with different spectral tuning.
461	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	4	2	This input involves direct (R7, R8) and indirect pathways (R7 via Dm8, R1-6 via L3) (Figure 9J).
462	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	4	3	This integration of multiple spectral inputs could support a role of Dm9 in color processing.
463	Results; Combining transcriptomes and connectomes; Comparisons of cell shape, synaptic connectivity and receptor expression reveal multiple similarities between local interneurons Lai in the lamina and Dm9 in the medulla	4	4	Indeed, the anatomical and predicted functional properties of Dm9 match those of an as yet unidentified ort expressing cell type proposed to contribute to color opponent signaling between R7 and R8 cells (Schnaitmann et al., 2018).
464	Discussion	1	1	We present an approach to characterize the function of neural circuits by combining genetic tools to access their component cells, TAPIN-seq to measure their transcriptomes, and a probabilistic model to interpret these measurements (Figures 1, 2 and 3).
465	Discussion	1	2	We used this approach to establish an extensive resource of the genes expressed in 67 Drosophila cell types, including 53 in the visual system, covering photoreceptors, lamina, and components of the motion detection circuit (Figure 4) and systematically compare our results to single cell RNA-seq (Figure 5).
466	Discussion	1	3	Our approach enables an extensive analysis of neurotransmission in the Drosophila visual system, including the neurotransmitters sent and received across the network as well as transcription factors that potentially regulate neurotransmitter identity (Figures 6 and 7).
467	Discussion	1	4	We also provide specific examples of integrating transcriptomes and connectomes to illuminate circuit function (Figures 8 and 9).
468	Discussion	2	1	Many recent studies have explored gene expression in neurons.
469	Discussion	2	2	However, only a few of these were aimed at neurons in genetically tractable organisms and brain regions for which detailed anatomical data, especially at the level of synaptic connections, are available.
470	Discussion	2	3	Previous work in the mouse retina has used both genetic (Siegert et al., 2012) and single cell approaches (Macosko et al., 2015) to characterize transcriptional regulators as well as classify cell types.
471	Discussion	2	4	More recent work in Drosophila used single cell RNA-sequencing to characterize heterogeneity in olfactory projection neurons (Li et al., 2017), the midbrain (Croset et al., 2018), the optic lobe (Konstantinides et al., 2018), and the whole brain (Davie et al., 2018).
472	Discussion	2	5	The expression patterns of many genes have also been mapped in C. elegans neurons, whose connectivity has long been known, although these studies typically focus on individual genes rather than genome-wide catalogs (Hobert, 2016).
473	Discussion	2	6	The unique combination of an extensive genetic toolbox to access individual cell types in the Drosophila visual system and systematic efforts to map its connectivity, make it well suited for exploring whether a comprehensive catalog of gene expression is useful for understanding circuit function.
474	Discussion	2	7	Towards this end, we profiled a diverse array of cell types including all of the neuronal cell types that populate the lamina and a subset of cell types in the medulla and lobula complex including those known to play a central role in the detection of motion.
475	Discussion	2	8	We also analyzed a number of cell types residing in deeper brain structures such as the mushroom body and central complex.
476	Discussion	3	1	Our approach requires genetic driver lines to obtain transcriptomes of specific cell populations.
477	Discussion	3	2	The recent availability of large collections of reagents for split-GAL4 intersections (Dionne et al., 2018; Tirian and Dickson, 2017) make it possible to obtain such lines for virtually any cell type of interest.
478	Discussion	3	3	This expanding genetic toolbox works well with our TAPIN-seq method to profile transcriptomes.
479	Discussion	4	1	In some cases, available driver lines, including some used in this study (see Supplementary file 1A), may label some additional cell types.
480	Discussion	4	2	In addition to the presence of different, anatomically distinct cell types in a driver pattern, heterogeneity could also result from as yet unrecognized subpopulations within a seemingly uniform group of cells.
481	Discussion	4	3	For example, R7 and R8 photoreceptor neurons each include two major subtypes (pale and yellow) with different rhodopsin expression but very similar, if not identical, cell morphology (Wernet and Desplan, 2004).
482	Discussion	4	4	While drivers with even higher specificity could be obtained through testing of additional split-GAL4 intersections or perhaps triple intersections (Dolan et al., 2017), we did not find the contributions of small numbers of ‘off-target’ cells to be a major limitation for many applications of expression data.
483	Discussion	4	5	In general, the transcriptomes support the high specificity of the intersectional lines we used to access visual system cells (Figure 1).
484	Discussion	4	6	For example, we found specific expression of known marker genes (Figures 2G and 4B) and also that most neurons only express genes for a single neurotransmitter type (Figure 6A).
485	Discussion	4	7	In general, the expression patterns observed in our validation experiments (for example, Figure 3G and Figure 3-figure supplement 2) were highly consistent within a cell type.
486	Discussion	4	8	This suggests that individual cells of many if not all of the anatomical cell types we profile do indeed share specific molecular signatures, even if subdivisions within some types might exist.
487	Discussion	4	9	The availability of specific driver lines makes such validation at cellular resolution possible in a way that is otherwise difficult, for example in single cell RNA-seq studies.
488	Discussion	4	10	Driver lines also permit repeated access to the same cell type in multiple animals at defined time points, enabling the study of behavioral or circadian conditions in individual cell types without having to sequence the whole brain or dissected brain regions.
489	Discussion	5	1	Modifying the one-step affinity capture in the original INTACT method to a two-step capture in TAPIN-seq increased its specificity, sensitivity, and throughput without the need for time-consuming and labor-intensive centrifugation steps (Figure 1).
490	Discussion	5	2	We initially tried improving the original INTACT method by using density gradient centrifugation to purify nuclei prior to the bead capture step, but this was cumbersome, low throughput, and ineffective for cell types with few nuclei per brain.
491	Discussion	5	3	In addition, for reasons that remain unclear, both photoreceptors and T4 cells consistently yielded few nuclei with this approach.
492	Discussion	5	4	Even with TAPIN, the libraries obtained with some sparser driver lines did not meet the quality control standards we applied.
493	Discussion	5	5	We suspect that the quality of these sub-optimal libraries can be improved by starting with more flies, which is simplified by TAPIN-seq’s ability to use frozen material, enabling the collection of many flies on multiple days at defined time points.
494	Discussion	5	6	In contrast, manual or FACS sorting of dissociated cells is more challenging to scale up, because these more labor-intensive tissue procurement schemes cannot be simplified in the same way.
495	Discussion	5	7	It is also worth noting that our tandem affinity purification approach can improve the specificity of any immunopurification method that uses a capture antibody that is cleavable by IdeZ (all IgG subclasses), without requiring expression of a traditional TAP tag (Rigaut et al., 1999).
496	Discussion	6	1	TAPIN-seq complements single-cell RNA-seq studies of neurons in several ways (Ecker et al., 2017; Konstantinides et al., 2018).
497	Discussion	6	2	First, our high-resolution transcriptomes will serve as a reference for interpreting single-cell measurements.
498	Discussion	6	3	In particular, comparing our expression catalog to recent single cell maps of the optic lobe and whole brain highlights the challenges in interpreting single cell measurements.
499	Discussion	6	4	Several cell types that we profiled don’t appear as clusters in the single cell map, while others are grouped into the same cluster.
500	Discussion	6	5	The well-established neuroanatomy of the optic lobe makes it an ideal setting to evaluate the accuracy of single cell RNA-seq measurements and raises a broader caution when interpreting scRNA-seq surveys of less well-characterized tissues: the composition of cell types (or states or clusters) observed by scRNA-seq can deviate significantly from their true abundance and requires validation with independent methods.
501	Discussion	6	6	While we analyze fly neurons here, the cautions may also be worth considering in other tissues and species (e.g., the Human Cell Atlas effort; Regev et al., 2017).
502	Discussion	6	7	Having both deep bulk transcriptomes and single cell maps of the same tissue also provides an opportunity for developing new analytical tools that can harness available cell type-identified information while clustering single cell data.
503	Discussion	6	8	Second, combining our approach with single-cell profiling could more efficiently profile heterogeneity within a brain region or genetically defined cell population.
504	Discussion	6	9	Such a combined approach could also help to characterize known cell types for which specific driver lines are not yet available or help to identify and exclude contributions from ‘off-target’ cells to a bulk profile.
505	Discussion	6	10	Finally, the complementarity between bulk and single-cell measurements extends to other genomic features that can be measured in TAPIN-seq purified nuclei, including accessible chromatin and modified histones.
506	Discussion	6	11	We expect this combination of genomic tools to help decipher the transcriptional and epigenetic regulation of neuronal expression programs.
507	Discussion	7	1	Transcriptome measurements can be of limited utility because it is challenging to interpret relative transcript abundance.
508	Discussion	7	2	In this study we developed a probabilistic mixture modeling approach to classify relative abundances into binary on and off states.
509	Discussion	7	3	This model was a useful guide for interpreting our measurements; most genes are readily described with the two-state model, although the expression of some genes is not (e.g., Rab11; Figure 3-figure supplement 1L).
510	Discussion	7	4	Even for specific genes whose expression is more continuous than bimodal, the results still offer a useful family-wide summary of expression patterns.
511	Discussion	7	5	For example, DPR family members are more broadly expressed than DIP genes (Figure 4C; Figure 4-figure supplement 1D), an observation supported by two recent studies using different methods (Cosmanescu et al., 2018; Venkatasubramanian et al., 2019).
512	Discussion	7	6	Despite our model’s utility, it is important to remember the many potential sources of error (minor cell types in driver line patterns, transcript carry over during TAPIN, biases in RNA-seq library construction and sequencing, etc.) that can affect measurements of relative transcript abundance and the resulting model inferences.
513	Discussion	7	7	Having observed most discrepancies between our modeling results and protein-level expression near the boundary between on and off states, it is prudent to treat these cases more carefully.
514	Discussion	8	1	Our resource provides additional foundation for systematic functional and molecular studies of the Drosophila visual system.
515	Discussion	8	2	We illustrated how the resource can characterize neurotransmission in the network, particularly when combined with connectome information detailing connectivity between cell types as well as the grouping of post-synaptic partner cell types.
516	Discussion	8	3	We predict neurotransmitters used by every cell we profiled and found two likely cases of co-transmission (Figure 6A).
517	Discussion	8	4	The expression patterns of the major fast-acting transmitters histamine, acetylcholine, glutamate and GABA were comparatively simple: Nearly all neuronal cell types in our catalogue appear to express exactly one of these four transmitters.
518	Discussion	8	5	However, the transcriptomes suggest that many cells also have the potential to release specific neuropeptides, other chemical messengers such as nitric oxide, or form gap junctions with other cells.
519	Discussion	9	1	While selected transmitter markers (e.g., Gad1 or VGlut) could also be assigned to cell types using methods such as immunolabeling or FISH, these approaches are not practical for comprehensive sampling of markers across these different modes of cell-cell communication.
520	Discussion	9	2	This is particularly clear when the expression patterns of neurotransmitter receptors are also considered (Figure 7A).
521	Discussion	9	3	Our results suggest that, for canonical small molecule transmitters, neurotransmitter output space is tightly tuned while input space is not: neurons typically send just one type of signal but can receive many (Figures 6 and 7).
522	Discussion	9	4	The expression patterns of neurotransmitter receptors provide further context for determining circuit mechanisms (Figure 7-figure supplement 1, Figures 8 and 9).
523	Discussion	9	5	Our results also implicate transcription factors involved in regulating neurotransmitter phenotype, including several that appear to have conserved roles in specifying neuronal identity in other species (Figure 6-figure supplement 1).
524	Discussion	10	1	The availability of connectivity data for many neurons in the visual system allowed us to interpret neurotransmitter use and receptor distribution in the context of circuit architecture (Takemura et al., 2013; Takemura et al., 2015; Rivera-Alba et al., 2011).
525	Discussion	10	2	For example, our data show expression of both histaminergic and cholinergic markers in R8 photoreceptors.
526	Discussion	10	3	We further find that some major synaptic targets of R8 cells, as identified by electron microscopy, do not express known receptors for histamine (Figure 8F).
527	Discussion	10	4	Given that R7 and R8 cells were previously thought to be exclusively histaminergic both results are unexpected and individually might appear difficult to explain (Gao et al., 2008).
528	Discussion	10	5	However, in combination, these findings make a strong case for a dual histaminergic and cholinergic transmitter phenotype of R8 cells.
529	Discussion	10	6	In contrast, R7 only expresses the histaminergic marker Hdc, and all of its targets express a histamine receptor (Figure 8G).
530	Discussion	11	1	Finally, our approach especially complements ongoing efforts to map circuit connectivity, which is complete for C. elegans, and is becoming accessible on a whole brain level for Drosophila (Zheng et al., 2018), and for portions of the mouse brain such as the retina.
531	Discussion	11	2	Methods to obtain and interpret serial electron micrographs, array tomography and other methods for mapping connectivity are rapidly progressing (Swanson and Lichtman, 2016; Micheva and Smith, 2007; Kebschull et al., 2016).
532	Discussion	11	3	All told, we are entering a period in neuroscience where connectomics will become pivotal.
533	Discussion	11	4	We expect that genomic approaches, such as the methods for data collection and analysis that we describe here, will enhance these efforts by using transcriptomes to provide, at high-throughput, a molecular proxy for physiological features that are otherwise inaccessible to connectomic methods.
534	Materials and methods	1	1	All reagents and other resources are listed in the Key Resource Table (Supplementary file 2).
535	Materials and methods	1	2	A detailed description of split-GAL4 hemidrivers (https://bdsc.indiana.edu/stocks/gal4/split_intro.html) and cell-type specific split-GAl4 lines is available online (https://www.janelia.org/split-GAL4).
536	Materials and methods; Experimental models and subject details	1	1	Flies were reared on standard cornmeal/molasses food at 25°C.
537	Materials and methods; Experimental models and subject details	1	2	For profiling experiments adults, 4-7 days of age, were entrained to a 12:12 light:dark cycle and anesthetized by CO_2 at ZT8 - ZT12.
538	Materials and methods; Experimental models and subject details	1	3	Samples can be stored indefinitely at −80°C after flash freezing in liquid N_2.
539	Materials and methods; Experimental models and subject details	1	4	We used female flies for all anatomical characterizations.
540	Materials and methods; Method details; Anatomical analyses	1	1	Details of individual genotypes and labeling methods used in the characterization of the driver lines and other anatomical experiments are summarized in Supplementary file 1E.
541	Materials and methods; Method details; Anatomical analyses	1	2	Details of the driver lines are provided in Supplementary file 1A.
542	Materials and methods; Method details; Anatomical analyses	1	3	For the naming of RNA-seq samples, we identified all drivers with a main cell type or cell types (e.g., Mi9_d1).
543	Materials and methods; Method details; Anatomical analyses	1	4	Most of these cell types have been described in detail and were identified based on prior descriptions (for details see Supplementary file 1A; Takemura et al., 2013; Gao et al., 2008; Nern et al., 2015; Fischbach and Dittrich, 1989; Tuthill et al., 2013; Aso et al., 2014; Wu et al., 2016; Wolff and Rubin, 2018; Wolff and Rubin, 2018; Edwards et al., 2012; Helfrich-Förster et al., 2007; Panser et al., 2016; Mauss et al., 2015).
544	Materials and methods; Method details; Anatomical analyses	1	5	The driver names do not attempt to include additional cells present in some drivers.
545	Materials and methods; Method details; Anatomical analyses	1	6	A few of our cell types are strictly groups of related cell types (for example, the muscle cells or, at a different level of a cell type hierarchy, the T4 and T5 cells, with four subtypes each, or R7 photoreceptor neurons, which include R7s of pale and yellow ommatidia).
546	Materials and methods; Method details; Generation and characterization of new driver lines	1	1	Split-GAL4 and GAL4 driver lines (Supplementary file 1A) were used to express UNC84-2XGFP in defined cell populations.
547	Materials and methods; Method details; Generation and characterization of new driver lines	1	2	Previously published driver lines were from the following studies (see Supplementary file 1A for details; Tuthill et al., 2013; Diao et al., 2015; Aso et al., 2014; Wu et al., 2016; Strother et al., 2017; Park et al., 2003; Rulifson et al., 2002; Tayler et al., 2012; Taghert et al., 2001; Brand and Perrimon, 1993; Wu et al., 2003; Park et al., 2000; Sweeney et al., 1995; Wolff and Rubin, 2018; von Reyn et al., 2017).
548	Materials and methods; Method details; Generation and characterization of new driver lines	1	3	New split-GAl4 lines were generated as in previous work (Tuthill et al., 2013; Wu et al., 2016).
549	Materials and methods; Method details; Generation and characterization of new driver lines	1	4	Briefly, we first identified GAL4 lines with expression in the cell type of interest by screening images of the expression patterns of large collections of such lines (Jenett et al., 2012; Tirian and Dickson, 2017).
550	Materials and methods; Method details; Generation and characterization of new driver lines	1	5	Typically, several candidate combinations of AD- and DBD-hemidrivers were tested to identify lines with sufficient specificity.
551	Materials and methods; Method details; Generation and characterization of new driver lines	2	1	To characterize new driver lines, we examined both overall expression pattern in the brain and optic lobe and, for most lines, confirmed the identity of the main cell type or types using MultiColor FlpOut (MCFO)-labeled single cells (Nern et al., 2015).
552	Materials and methods; Method details; Generation and characterization of new driver lines	2	2	Since details of the expression patterns of GAL4 or split-GAL4 driver lines can depend on the particular UAS reporter used, we re-imaged 20 drivers with the TAPIN nuclear marker used for the profiling experiments (Figure 2A).
553	Materials and methods; Method details; Generation and characterization of new driver lines	2	3	In general, the distribution of labeled nuclei in these images appeared to match the expression patterns and specificity expected from the driver line’s original characterization using a membrane marker.
554	Materials and methods; Method details; Generation and characterization of new driver lines	2	4	As expected, a small number of off-target cells were detectable (often more weakly labeled) in many driver lines.
555	Materials and methods; Method details; Validation experiments	1	1	For validation experiments, we examined expression patterns of tagged proteins expressed in a near native genomic context using either large BAC-transgenes or modifications of the endogenous loci (Nagarkar-Jaiswal et al., 2015; Diao et al., 2015; Kudron et al., 2018; Lee et al., 2018).
556	Materials and methods; Method details; Validation experiments	2	1	We classified fkh-GFP and Ets65A-GFP as expressed or not expressed by visually comparing nuclear GFP signal in cells of interest (identified using a split-GAL4 driver) to background labeling in surrounding cells.
557	Materials and methods; Method details; Validation experiments	2	2	Because of considerable differences in the GFP signal for different cell types, confocal settings and post-imaging adjustments were done individually for different cell types for these experiments.
558	Materials and methods; Method details; Validation experiments	3	1	The following transgenes were used (also see Supplementary file 1E):
559	Materials and methods; Method details; Validation experiments	4	1	PBac{y[+mDint2] w[+mC]=fkh GFP.FPTB}VK00037 (RRID:BDSC_43951), PBac{y[+mDint2] w[+mC]=Ets65 A-GFP.FLAG}VK00037 (RRID:BDSC_38640), Mi{PT-GFSTF.0}Nos[MI09718-GFSTF.0] (RRID:BDSC_60278), Mi{Trojan-GAL4.1}Oamb[MI12417-TG4.1] (RRID:BDSC_67506), Mi{Trojan-GAL4.1}Lim3[MI03817-TG4.1] (RRID:BDSC_67450), Mi{PT-GFSTF.1}klg[MI02135-GFSTF.1] (RRID:BDSC_59787), Mi{PT-GFSTF.2}GluClalpha[MI02890-GFSTF.2] (RRID:BDSC_60533), Mi{PT-GFSTF.0}TfAP-2[MI04611-GFSTF.0] (RRID:BDSC_61776), Mi{Trojan-GAL4.2}kn[MI15480-TG4.2] (RRID:BDSC_67516) pJFRC12-10XUAS-IVS-myr::GFP in attP2 (RRID:BDSC_32197), pJFRC19-13XLexAop2-IVS-myr::GFP in su(Hw)attP8 (RRID:BDSC_32211), and pJFRC21-10XUAS-IVS-mCD8::RFP in attP18.
560	Materials and methods; Method details; Validation experiments	5	1	The VAChT-FRT-STOP-FRT-HA transgene (TI{TI}VAChT[FRT-STOP-FRT.HA] (RRID:BDSC_76021) described in Pankova and Borst (2017) was used to examine VAChT expression in photoreceptor neurons.
561	Materials and methods; Method details; Validation experiments	5	2	Flp-recombinase, either sens-FLP (expressed in R8 cells; Chen et al., 2014) (fly stock w[*] P{y[+t7.7] w[+mC]=sens-FLPG5.
562	Materials and methods; Method details; Validation experiments	5	3	C}attP18; wg[Sp-1]/CyO; sens[Ly-1]/TM6B, Tb[1] (RRID:BDSC_55768) or ey3.5FLP (expressed in all R-cells; Bazigou et al., 2007) (fly stock P{w[+mC]=ey3.5 FLP.B}1, y[1] w[*]; CyO/In(2LR)Gla, wg[Gla-1] PPO1[Bc] (RRID:BDSC_35542) was used to induce VAChT stop-cassette excision.
563	Materials and methods; Method details; Histology	1	1	Visualization of split-GAL4 driver line expression patterns with pJFRC51-3XUAS-IVS-Syt::smHA in su(Hw)attP1 and pJFRC225-5XUAS-IVS-myr::smFLAG in VK00005 (Nern et al., 2015) or, in a few cases, 20XUAS-CsChrimson-mVenus in attP18 (Klapoetke et al., 2014) as reporters was performed as described (Aso et al., 2014; Wu et al., 2016).
564	Materials and methods; Method details; Histology	1	2	Detailed protocols are also available online (https://www.janelia.org/project-team/flylight/protocols under ‘IHC - Anti-GFP’, ‘IHC - Polarity Sequential’ and ‘DPX mounting’).
565	Materials and methods; Method details; Histology	1	3	Multicolor Flp-out (MCFO) markers were detected by immunolabeling with antibodies against HA, FLAG and V5 epitopes as described (Nern et al., 2015).
566	Materials and methods; Method details; Histology	1	4	Detailed protocols are also available online (https://www.janelia.org/project-team/flylight/protocols under ‘IHC - MCFO’.
567	Materials and methods; Method details; Histology	2	1	For other experiments, brains of female flies were dissected in insect cell culture medium (Schneider’s Insect Medium, Sigma Aldrich, #S0146) and fixed with 2% PFA (w/v) (prepared from a 20% stock solution, Electron Microscopy Sciences: 15713) also in cell culture medium for 1 hr at room temperature.
568	Materials and methods; Method details; Histology	2	2	Brains were washed with 0.5% (v/v) TX-100 (Sigma Aldrich: X100) in PBS and incubated in PBT-NGS (5% Goat Serum [ThermoFisher: 16210-064] in PBT) for at least 30 min.
569	Materials and methods; Method details; Histology	2	3	Incubations with primary antibodies and subsequently, after additional PBT washes, secondary antibodies, were in PBT-NGS at 4°C overnight.
570	Materials and methods; Method details; Histology	2	4	After additional washes with PBT and then PBS, brains were mounted in SlowFadeGold (ThermoFisher: S36937) and imaged on a Zeiss LSM 710 confocal microscope using 20 × 0.8 NA, 40x NA 1.3 or 63 × 1.4 NA objectives.
571	Materials and methods; Method details; Histology	2	5	A few specimens were mounted in DPX following the protocol described in Nern et al.
572	Materials and methods; Method details; Histology	2	6	(2015).
573	Materials and methods; Method details; Histology	2	7	For experiments using only native fluorescence, brains were fixed as above and mounted and imaged after the initial post-fixation washes.
574	Materials and methods; Method details; Histology	3	1	Primary antibodies used in each experiment are indicated in Supplementary file 1E.
575	Materials and methods; Method details; Histology	3	2	Primary antibodies were anti-GFP rabbit polyclonal (ThermoFisher: A-11122, RRID:AB_221569; used at 1:1000 dilution), anti-GFP mouse monoclonal 3E6 (ThermoFisher: A-11120, RRID:AB_221568; dilution 1:100), anti-dsRed rabbit polyclonal (Clontech Laboratories, Inc.: 632496, RRID:AB_10013483; dilution 1:1000), anti-HA rabbit monoclonal C29F4 (Cell Signaling Technologies: 3724S, RRID:AB_1549585; dilution 1:300), anti-FLAG rat monoclonal (DYKDDDDK Epitope Tag Antibody [L5], Novus Biologicals: NBP1-06712, RRID:AB_1625981; 1:200), DyLight 549 or DyLight 550 conjugated anti-V5 mouse monoclonals (AbD Serotec: MCA1360D549GA or MCA1360D550GA, RRID:AB_10850329 or RRID:AB_2687576; 1:500 dilution), anti-cockroach allatostatin (Ast7) mouse monoclonal 5F10 (Stay et al., 1992) (also detects Drosophila AstA (Hergarden et al., 2012); Developmental Studies Hybridoma Bank (DSHB): RRID:AB_528076; dilution 1:5), anti-CadN rat monoclonal DN-Ex #8 (DSHB: RRID:AB_528121; dilution 1:20) (Iwai et al., 1997), anti-chaoptin mouse monoclonal 24B10 (DSHB: RRID:AB_528161, dilution 1:20.
576	Materials and methods; Method details; Histology	3	3	Fujita et al., 1982) and anti-Brp mouse monoclonal nc82 (Wagh et al., 2006) (DSHB: RRID:AB_2314866; dilution 1:30).
577	Materials and methods; Method details; Histology	4	1	Secondary antibodies (all from Jackson ImmunoResearch Laboratories, Inc) were DyLight 488-AffiniPure Donkey Anti-Mouse IgG (H+L): 715-485-151, 1:500 dilution; DyLight 594 AffiniPure Donkey anti Rabbit IgG (H+L): 711-515-152, 1:300 dilution; Alexa Fluor 647 AffiniPure Donkey Anti-Rat IgG (H+L): 712-605-153, 1:300 dilution; Alexa Fluor 594 AffiniPure Donkey Anti-Mouse IgG (H+L): 715-585-151,1:300 dilution; Alexa Fluor 647 AffiniPure Donkey Anti-Mouse IgG (H+L): 715-605-151, 1:300 dilution and Alexa Fluor 488 AffiniPure Donkey Anti-Rabbit IgG (H+L): 711-545-152, 1:1000 dilution.
578	Materials and methods; Method details; Image processing	1	1	Image analyses and processing were mainly done using Fiji (http://fiji.sc) and Vaa3D (Peng et al., 2010).
579	Materials and methods; Method details; Image processing	1	2	Brightness and contrast were adjusted separately for individual images and channels.
580	Materials and methods; Method details; Image processing	1	3	Figure panels were assembled using Adobe Indesign.
581	Materials and methods; Method details; Image processing	1	4	This included selection of fields of view and adjustments of image size.
582	Materials and methods; Method details; Image processing	1	5	Some images were rotated or mirrored.
583	Materials and methods; Method details; Image processing	1	6	In some panels with rotated images, empty space outside the original image was filled in with zero pixels.
584	Materials and methods; Method details; Image processing	1	7	Most of the images in Figure 1-figure supplement 1C,C’ and Figure 1-figure supplement 2 show resampled views that were generated from three dimensional image stacks using the Neuronannotator mode of Vaa3D and exported as TIFF format screenshots.
585	Materials and methods; Method details; INTACT purification of nuclei	1	1	Frozen adult flies were decapitated by vigorous vortexing.
586	Materials and methods; Method details; INTACT purification of nuclei	1	2	Heads or wings/appendages were then collected on cooled metal sieves (H and C Sieving Systems: 1296, 1297, 1298, 1301).
587	Materials and methods; Method details; INTACT purification of nuclei	1	3	Both flies and purified frozen material can be stored indefinitely at −80°C.
588	Materials and methods; Method details; INTACT purification of nuclei	1	4	In a typical experiment 100-500 frozen heads were added to 5 ml of 20 mM β-glycerophosphate pH7, 200 mM NaCl, 2 mM EDTA, 0.5% NP40, 0.5 mM spermidine, 0.15 mM spermine, 1 mM DTT, 1X complete protease inhibitor (Sigma: 5056489001), 1.5 mg/ml BSA (ThermoFisher: AM2618), 1 mg/ml torula yeast RNA (ThermoFisher: AM7118), 0.6 mg/ml carboxyl coated Dynabeads (ThermoFisher: 14306D) and 2µg anti-GFP antibody (ThermoFisher: G10362, RRID:AB_2536526).
589	Materials and methods; Method details; INTACT purification of nuclei	1	5	Homogenization was carried out on ice by 50 tractions in a Dounce homogenizer using the tight pestle followed by filtration over a 10µm cup filter (Partec: 0400422314).
590	Materials and methods; Method details; INTACT purification of nuclei	1	6	Released chromatin and broken nuclei were adsorbed to carboxyl coated magnetic beads for 30 min at 4°C with constant rotation.
591	Materials and methods; Method details; INTACT purification of nuclei	1	7	Beads were removed on a magnetic stand and the supernatant was diluted to 50 ml with 20 mM β-glycerophosphate pH7, 200 mM NaCl, 2 mM EDTA, 0.5% NP40, 0.5 mM spermidine, 0.15 mM spermine, 1 mM DTT and 1X complete protease inhibitor (Sigma: 5056489001), filtered over a 1µm cup filter (Pluriselect: 435000103) and split into two equal volumes.
592	Materials and methods; Method details; INTACT purification of nuclei	1	8	A 40% Optiprep (Sigma: D1556), 20 mM β-glycerophosphate pH7, 2 mM EDTA and 0.5% NP40 solution was then gently placed under each aliquot, followed by a lower layer of 50% Optiprep, 20 mM β-glycerophosphate pH7, 2 mM EDTA and 0.5% NP40.
593	Materials and methods; Method details; INTACT purification of nuclei	1	9	Nuclei were then pelleted on to the 50% layer for 30 min at 2300Xg.
594	Materials and methods; Method details; INTACT purification of nuclei	1	10	Purified nuclei were passed over a 10µm cup filter, diluted to 10 ml with 20 mM β-glycerophosphate pH7, 200 mM NaCl, 2 mM EDTA, 0.5% NP40, 0.5 mM spermidine, 0.15 mM spermine, 1 mM DTT and 1X complete protease inhibitor and incubated with 30µl of protein G Dynabeads (ThermoFisher: 10004D) for 40 min on ice with occasional agitation.
595	Materials and methods; Method details; INTACT purification of nuclei	1	11	Bead-bound nuclei were recovered on a magnet stand followed by a 20 min incubation on ice in 9mls of 20 mM β-glycerophosphate pH7, 300 mM NaCl, 1M urea, 0.5% NP40, 2 mM EDTA, 0.5 mM spermidine, 0.15 mM spermine, 1 mM DTT, 1X complete protease inhibitor, 0.075 mg/ml torula RNA and 0.05 U/ml Superasin (ThermoFisher: AM2696).
596	Materials and methods; Method details; INTACT purification of nuclei	1	12	Nuclei were then recovered on a magnet stand, resuspended in 1 ml of the previous buffer, passed over a 10µm cup filter, a 5µl aliquot was withdrawn for quantitation and the remainder of the sample solubilized in Arcturus Picopure RNA extraction buffer (ThermoFisher: KIT0204).
597	Materials and methods; Method details; TAPIN purification of nuclei	1	1	100-3000 frozen heads were added to 5 ml of 20 mM sodium acetate pH8.5, 2.5 mM MgCl_2, 250 mM sucrose, 0.5% NP-40, 0.6 mM spermidine, 0.2 mM spermine, 1 mM DTT, 1X complete protease inhibitor, 0.5 mg/ml torula RNA, 0.6 mg/ml carboxyl coated Dynabeads and 2µg anti-GFP antibody (Supplementary file 1F).
598	Materials and methods; Method details; TAPIN purification of nuclei	1	2	Homogenization was carried out on ice by 50 tractions in a Dounce homogenizer using the tight pestle followed by filtration over either a 10 or 20µm cup filter (Partec: 0400422314 or 040042315).
599	Materials and methods; Method details; TAPIN purification of nuclei	1	3	Released chromatin and broken nuclei were adsorbed to carboxyl coated magnetic beads for 30 min at 4°C with constant rotation.
600	Materials and methods; Method details; TAPIN purification of nuclei	1	4	Unbound antibody was removed by incubating the sample on ice for 20 min with 100µl of UNOsphere SUPra resin (Biorad: 1560218), which was previously washed 2X with 500 mM sodium acetate ph8.5/0.5% NP40 and 2 × 20 mM sodium acetate ph8.5/0.5% NP40.
601	Materials and methods; Method details; TAPIN purification of nuclei	1	5	After the resin was removed on a 10µm cup filter and the carboxyl beads on a magnet stand, the nuclei-containing supernatant was mixed with an equal volume of 500 mM sodium acetate pH8.5, 250 mM sucrose, 6 mM EGTA, 6 mM EDTA, 0.6 mM spermidine, 0.2 mM spermine, 1 mM DTT, 1X complete protease inhibitor, 0.25 mg/ml torula yeast RNA and 30µl Protein A Dynabeads (ThermoFisher: 10002D) (Supplementary file 1F).
602	Materials and methods; Method details; TAPIN purification of nuclei	1	6	A 2 hr incubation on ice with occasional agitation was used to recover tagged nuclei.
603	Materials and methods; Method details; TAPIN purification of nuclei	1	7	Bead-bound nuclei were then recovered on a magnet stand and washed twice with 250 mM sodium acetate ph8.5, 250 mM sucrose and 0.1% NP40 (Supplementary file 1F).
604	Materials and methods; Method details; TAPIN purification of nuclei	1	8	Nuclei were then released at 37°C for 1 hr by incubation in 50µl of 10 mM Tris pH7.5, 2.5 mM MgCl_2, 0.5 mM CaCl_2, 250 mM sucrose, 0.1% NP40, 1 mg/ml torula RNA, 40 units RNAsin (Promega: N2515), 2 units DNAseI (NEB: M0303L), 320 units IdeZ protease (NEB: P0770S) (Supplementary file 1F).
605	Materials and methods; Method details; TAPIN purification of nuclei	1	9	The sample was diluted to 100µl with 10 mM Tris pH7.5, 2.5 mM MgCl_2, 0.5 mM CaCl_2, 250 mM sucrose and 0.1% NP40, EGTA was added to 1 mM and the suspension was rapidly triturated 100 times.
606	Materials and methods; Method details; TAPIN purification of nuclei	1	10	After returning the sample to a magnet stand, 90µls of buffer containing released nuclei was removed and added to 1.5µl of Protein G Dynabeads that were previously resuspended in 10µl of 10 mM Tris pH7.5, 2.5 mM MgCl_2, 0.5 mM CaCl_2, 250 mM sucrose and 0.1% NP40.
607	Materials and methods; Method details; TAPIN purification of nuclei	1	11	The second binding reaction was run for 1-3 hr on ice with occasional agitation, followed by two 250µl washes in 10 mM Tris pH7.5, 2.5 mM MgCl_2, 0.5 mM CaCl_2, 250 mM sucrose and 0.1% NP40.
608	Materials and methods; Method details; TAPIN purification of nuclei	1	12	Prior to the last wash a 5µl aliquot was removed for quantitation and the remainder of the sample was solubilized in Arcturus Picopure RNA extraction buffer.
609	Materials and methods; Method details; RNA-seq library construction	1	1	Nuclear RNA was DNAseI (Qiagen: 79254) treated and purified using the Arcturus PicoPure (ThermoFisher: KIT0204) system as instructed by the supplier.
610	Materials and methods; Method details; RNA-seq library construction	1	2	Purified RNA was mixed with a 1:100,000 dilution of ERCC standard RNA mix #1 (ThermoFisher: 4456740) and amplified using the Nugen Ovation v2 system (Nugen: 7102-32). cDNA was then blunted, ligated to barcoded linkers (Nugen: 0319-32, 0320-32) and sequenced on an Illumina Hiseq 2500 to 50 bp read length using Rapid Run flow cells.
611	Materials and methods; Method details; RNA-seq library construction	2	1	In total we built 266 RNA-seq libraries, including 46 INTACT-seq, 196 TAPIN-seq, eight total RNA libraries from dissected tissues, and 16 control libraries that we used to characterize each INTACT/TAPIN-seq step (Figure 2C, Supplementary file 1A).
612	Materials and methods; Method details; RNA-seq data processing	1	1	We trimmed five nucleotides from the 5’ end of reads using seqtk (https://github.com/lh3/seqtk) to remove potential contaminating adapter sequence from the NuGen Ovation kit.
613	Materials and methods; Method details; RNA-seq data processing	1	2	We estimated the abundance of annotated genes using kallisto (v0.43.1; Bray et al., 2016) to pseudo-align trimmed reads to the fly transcriptome (cDNA and ncRNA transcript sequences from ENSEMBL release 91, based on FlyBase release 2017_04), ERCC spike-ins, and the INTACT construct sequences GAL4-DBD, p65-AD, and UNC84_2XGFP.
614	Materials and methods; Method details; RNA-seq data processing	1	3	ERCC, INTACT tag constructs, and rRNA genes were removed from the abundance tables and the estimated abundances of the remaining genes were renormalized to one million total transcripts.
615	Materials and methods; Method details; RNA-seq data processing	1	4	The ERCC spike-ins and nuclear yield values allowed us to convert relative transcript abundance (in Transcripts Per Million, TPM) to absolute abundance (Figure 3-figure supplement 1G).
616	Materials and methods; Method details; RNA-seq data processing	1	5	However, we only used relative abundance for our analyses.
617	Materials and methods; Method details; RNA-seq data processing	1	6	We also aligned the trimmed reads to the genome using STAR (v2.5.3c; Dobin et al., 2013) and evaluated gene body coverage bias using Picard (v 1.9.1; http://broadinstitute.github.io/picard).
618	Materials and methods; Method details; RNA-seq data processing	2	1	We used three criteria to quantify the quality of each library: the number of genes detected, the pearson correlation between transcript abundances measured in replicates, and the cDNA yield.
619	Materials and methods; Method details; RNA-seq data processing	2	2	We used only high-quality libraries (at least 8500 genes detected, 3µg cDNA yield, and 0.85 Pearson’s correlation of transcript abundances in two biological replicates) as input to the model described below.
620	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	1	1	We obtained genes reported to mark the single cell clusters in a recent scRNA-seq study of the optic lobe (Konstantinides et al., 2018).
621	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	1	2	We also obtained the cluster assignments for each single cell in this dataset from the SCope database (Davie et al., 2018), using Seurat clustering resolution 4.0, as reported by the authors.
622	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	1	3	We analyzed FACS-sorted RNA-seq samples reported by Konstantinides et al. by downloading the raw sequencing reads from the NCBI Sequence Read Archive (https://www.ncbi.nlm.nih.gov/sra) and estimating transcript abundance using kallisto and the same transcriptome index as above.
623	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	2	1	To compare actual and predicted cluster sizes, we used the following numbers for cells per type: Cell types that are thought to be present once (L1, L2, L3, L4, L5, T1, Mi1, T2, T3, Tm2, Tm9, C2,C3, T4a,T4b,T4c,T4d,T5a,T5b,T5c,T5d) or approximately once (Dm8, Tm3) per medulla column based on EM studies (Takemura et al., 2013; Takemura et al., 2015; Takemura et al., 2017) and light microscopy of specific driver lines (for example, T4/T5 Mauss et al., 2014; lamina cells Tuthill et al., 2013, T4 inputs Strother et al., 2017, Dm8 Nern et al., 2015) were estimated as 1 cell/column * 750 columns/medulla * two hemispheres = 1500 cells per brain.
624	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	2	2	Estimates for Dm12 (~120×2 cells per brain, Nern et al., 2015) and Lawf2 (~140×2 cells per brain, Tuthill et al., 2014) were as published.
625	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	2	3	We performed new counts for Pm3 (mean +/- SD 37 +/- 3 cells per optic lobe; n = 4 optic lobes; driver line SS00328) and Lawf1 (151+/- 7 cells per optic lobe; n = 4 optic lobes; two optic lobes each for driver lines SS00689 and SS00800).
626	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	2	4	No precise count was available for Tm5c; since this cell type is known to be present in many but not all medulla columns, we used an estimate of 400 cells per optic lobe x two hemispheres = 800 cells per brain (Takemura et al., 2013; Melnattur et al., 2014; Karuppudurai et al., 2014).
627	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	1	To compare our bulk TAPIN-seq profiles to published single cell datasets, we used non-negative least squares regression to model each bulk TAPIN-seq profile as a linear weighted sum of single cell clusters and a profile-specific residual (TAPIN ~cluster).
628	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	2	We began with single-cell expression matrices extracted from the loom files deposited in the SCope database, using the SCopeLoomR package (Davie et al., 2018).
629	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	3	After normalizing the transcriptome of each cell from transcript counts to counts per million, we calculated the mean transcriptome for each single cell cluster.
630	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	4	We then selected genes that were enriched in either single cell clusters or TAPIN-seq cell types, using the following criteria (adapted from Cao et al., 2019): union of the top-50 genes that were most enriched relative to the average of all other clusters (or TAPIN-seq cell types) and the top-50 genes that were most enriched relative to the maximum level in all other clusters (or TAPIN-seq cell types).
631	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	5	We then performed NNLS regression using the Lawson-Hanson implementation (Lawson and Hanson, 1974) available through the nnls R package (Mullen and Stokkum, 2012).
632	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	3	6	To visualize the results, we created heatmaps of the regression coefficients, normalizing the values for each single cell cluster across TAPIN-seq cell types.
633	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	4	1	We also performed the NNLS regression in the opposite direction (cluster ~TAPIN, explaining single cell clusters as combination of TAPIN-seq profiles), as we thought this direction would more naturally describe mixed clusters composed of multiple cell types (e.g., all photoreceptors, or all monopolar cells).
634	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	4	2	In practice however, this regression assigned coefficients of exactly zero to several TAPIN-seq profiles - as expected given the power of NNLS to recover sparse solutions (Slawski and Hein, 2013) and the collinearity amongst TAPIN-seq profiles (e.g., highly correlated expression amongst photoreceptor subtypes).
635	Materials and methods; Method details; Comparison to published single cell and FACS-seq datasets	4	3	In contrast, the TAPIN ~ cluster regression correctly matched mixed clusters with the corresponding TAPIN-seq profiles.
636	Materials and methods; Method details; Inferring expression state from transcript abundance	1	1	We begin with a catalog of S RNA-seq samples generated from nuclei isolated from cell type cell(s) and the estimated abundance (in TPM), of Egs transcripts from gene g in each sample s.
637	Materials and methods; Method details; Inferring expression state from transcript abundance	1	2	We consider only protein-coding genes with at least 10 TPM abundance in at least one sample (n = 12,377 of 13,931 total coding genes).
638	Materials and methods; Method details; Inferring expression state from transcript abundance	2	1	To interpret Egs, we assume that all genes express in either an 'on' or an 'off' state.
639	Materials and methods; Method details; Inferring expression state from transcript abundance	2	2	Our goal is to infer from these abundances the probability that each gene is expressed in each cell type, P(zgc=on).
640	Materials and methods; Method details; Inferring expression state from transcript abundance	2	3	Depending on the cell types in our catalog, we will observe some genes in both on and off states (bimodal), while others are exclusively off (unimodal-off) or on (unimodal-on).
641	Materials and methods; Method details; Inferring expression state from transcript abundance	2	4	We deal with these scenarios in turn below.
642	Materials and methods; Method details; Inferring expression state from transcript abundance	3	1	Assuming that a gene is bimodal, we model its expression as arising from a mixture of two gene-specific log-normal distributions describing expression in cells where the gene is off, P(Eg|z=off), and those where the gene is on, p(Eg|z=on), combined with a mixing weight, πg.
643	Materials and methods; Method details; Inferring expression state from transcript abundance	3	2	We use the same standard deviation for both on and off distributions to ensure a monotonic relationship between transcript abundance and the posterior probability of the on state.
644	Materials and methods; Method details; Inferring expression state from transcript abundance	3	3	If we use different standard deviations for each component distribution, the wider one would become more probable than the narrower one at both low and high expression levels.
645	Materials and methods; Method details; Inferring expression state from transcript abundance	4	1	We estimate the posterior probability of the on state (assuming bimodal expression):
646	Materials and methods; Method details; Inferring expression state from transcript abundance	5	1	We treated each replicate sample of the same driver as an independent probe of the same underlying driver-line expression state.
647	Materials and methods; Method details; Inferring expression state from transcript abundance	5	2	To combine replicates of the same driver we sum over their likelihoods:
648	Materials and methods; Method details; Inferring expression state from transcript abundance	6	1	Similarly, to combine samples from the same cell type we sum over their likelihoods:
649	Materials and methods; Method details; Inferring expression state from transcript abundance	7	1	We estimated parameters for each gene-specific mixture model by maximizing the likelihood for the observed sample-level data:
650	Materials and methods; Method details; Inferring expression state from transcript abundance	8	1	Because we assume independence of genes, we separately optimized the model parameters for each gene.
651	Materials and methods; Method details; Inferring expression state from transcript abundance	8	2	To model the possibility that a gene is unimodally expressed across the cell types we analyzed, we also model the data using a single log-normal distribution, estimating the distribution parameters μ and σ and estimating the data likelihood as:
652	Materials and methods; Method details; Inferring expression state from transcript abundance	9	1	Deciding whether a gene is bimodally or unimodally expressed is an example of the model selection problem in statistics.
653	Materials and methods; Method details; Inferring expression state from transcript abundance	9	2	To compare the quality of the unimodal and bimodal models for each gene, we used a recently developed approach to leave-one-out cross-validation that uses Pareto-smoothed importance sampling (PSIS-LOO; Vehtari et al., 2017).
654	Materials and methods; Method details; Inferring expression state from transcript abundance	9	3	Specifically, we performed 10-fold cross validation, by randomly holding out 1/10 of the samples as a ‘test’ set (requiring that at least one replicate of each driver exist in the remaining ‘training’ set), fitting the models using only the training data, and then evaluating the likelihood of the test data using the fitted parameters.
655	Materials and methods; Method details; Inferring expression state from transcript abundance	9	4	Each of the ten cross-validation fits, i, returns an ensemble of S = 500 draws from the posterior distribution of the model parameters.
656	Materials and methods; Method details; Inferring expression state from transcript abundance	9	5	We estimated the expected log pointwise predictive density (elpd) of each cross-validation fit by evaluating the likelihood of each held-out dataset i using each parameter draw s:
657	Materials and methods; Method details; Inferring expression state from transcript abundance	10	1	We then combined the pointwise log-likelihoods for each cross-validation fit to calculate a single estimate for each model:
658	Materials and methods; Method details; Inferring expression state from transcript abundance	11	1	To compare the unimodal and bimodal models, we calculated the difference in elpd as well as its standard error:
659	Materials and methods; Method details; Inferring expression state from transcript abundance	12	1	We then picked the model with the higher elpd, unless the difference in elpd was within two multiples of its standard error (abs(Δelpd^)≤2⋅se(Δelpd^), corresponding approximately to the half-width of a 95% confidence interval in a normal sampling distribution) in which case we considered the two models’ performance to be indistinguishable and chose the simpler unimodal model.
660	Materials and methods; Method details; Inferring expression state from transcript abundance	13	1	If we decide a gene is unimodal, we must still decide if it is expressed or not.
661	Materials and methods; Method details; Inferring expression state from transcript abundance	13	2	To model the expression state of unimodal genes, we created two separate log-normal distributions of abundances of confidently bimodal genes (Δelpd^>10) using samples where they were either estimated to be on according to the bimodal model (P(zgs=on|bimodal)>0.9) and where they were estimated to be off (P(zgs=on|bimodal)<0.1), combined with a mixing weight, π, set to the fraction of datapoints that were estimated to be ‘on’ according to the bimodal model.
662	Materials and methods; Method details; Inferring expression state from transcript abundance	14	1	We estimate the posterior probability of the on state assuming unimodal expression as:
663	Materials and methods; Method details; Inferring expression state from transcript abundance	15	1	To build the final matrix of P(zgs=on) calls, we used bimodal estimates for genes where the bimodal model was a better fit than the unimodal model, and the unimodal estimates for the remaining genes.
664	Materials and methods; Method details; Inferring expression state from transcript abundance	16	1	We did not include the transcriptomes of the dissected samples in the mixture models because we were concerned that their cellular heterogeneity would violate our assumption of binary gene expression in each sample.
665	Materials and methods; Method details; Inferring expression state from transcript abundance	16	2	That is, genes expressed in a subset of the cells of a dissected sample would give rise to transcript abundance intermediate between the off and on states, and thus make it more difficult to accurately infer the component distributions.
666	Materials and methods; Method details; Inferring expression state from transcript abundance	16	3	However, in some cases the dissected samples could be useful for interpreting transcript levels in the cells that we profiled, by providing examples that extend the observed dynamic range.
667	Materials and methods; Method details; Inferring expression state from transcript abundance	16	4	For example, in the case of a gene expressed in a dissected tissue, but not in the cells that we specifically profiled, the dissected levels would add ‘on’ examples that would make it easier to interpret the levels in the cell types as ‘off’.
668	Materials and methods; Method details; Inferring expression state from transcript abundance	16	5	To use the dissected samples to better model dynamic range, we added two ‘dummy’ samples to each model: the minimum and maximum observed level across both the cell catalog and the dissected samples.
669	Materials and methods; Method details; Inferring expression state from transcript abundance	16	6	This choice allowed us to use the dissected levels if they in fact outflanked the cell type-specific levels, while not confusing the model with intermediate abundance levels.
670	Materials and methods; Method details; Inferring expression state from transcript abundance	16	7	Once the models were fit, we could use the inferred parameters to estimate expression probabilities for samples that were not used in the model fit.
671	Materials and methods; Method details; Inferring expression state from transcript abundance	16	8	For example, we estimated the probabilities of expression in the dissected samples to search for genes expressed exclusively in the dissected samples and not in the anatomically defined cell type libraries, indicating potential markers for cells that we did not specifically profile.
672	Materials and methods; Method details; Inferring expression state from transcript abundance	17	1	We implemented all models using RStan (Stan Development Team, 2017; Carpenter et al., 2017) to infer the posterior distribution of unknown parameters using hamiltonian Markov chain Monte Carlo.
673	Materials and methods; Method details; Inferring expression state from transcript abundance	17	2	We used the same weak prior (N(7,5)) for the mean log-expression levels of both on and off components, allowing us to use Stan’s positive_ordered data type to describe the location of the two components.
674	Materials and methods; Method details; Inferring expression state from transcript abundance	17	3	The models were sampled using 4 independent Markov chains, each run for 500 iterations.
675	Materials and methods; Method details; Inferring expression state from transcript abundance	17	4	Additional details of the model fitting procedure can be found in the STAN files specifying the model and the R code that calls the model fitting procedures (github repository http://github.com/fredpdavis/opticlobe; copy archived at https://github.com/elifesciences-publications/opticlobe; David, 2020).
676	Materials and methods; Method details; Evaluating model accuracy	1	1	To evaluate the accuracy of the mixture modeling approach we created a benchmark set of expression data extracted from FlyBase.
677	Materials and methods; Method details; Evaluating model accuracy	1	2	Specifically, we queried the FlyBase website (http://flybase.org) for genes expressed in the optic lobe or the photoreceptor.
678	Materials and methods; Method details; Evaluating model accuracy	1	3	The resulting benchmark set included 193 positive and 4 negative expression datapoints.
679	Materials and methods; Method details; Evaluating model accuracy	1	4	We quantified the model’s accuracy on this benchmark in two ways.
680	Materials and methods; Method details; Evaluating model accuracy	1	5	First, we quantified concordance between the benchmark expression state and our model’s inferred state.
681	Materials and methods; Method details; Evaluating model accuracy	1	6	Second, we computed the cumulative distribution function of the inferred probabilities of expression for the positive benchmark datapoints.
682	Materials and methods; Method details; Expression-based tree of cell types	1	1	To study cell relationships, we used phylogenetic tree-building to compare their expression profiles.
683	Materials and methods; Method details; Expression-based tree of cell types	1	2	We first selected a subset of genes with on-component means of at least exp(3) ~ 21 TPM and difference between on and off components of at least exp(1.5) ~ 4.5 fold.
684	Materials and methods; Method details; Expression-based tree of cell types	1	3	We then encoded the expression profile of each cell as a ‘sequence’ of expression states, where each position represents a gene, and the character indicates the gene is expressed (‘A’, P(zgc=on)> 0.8), not expressed (‘C’, P(zgc=on) < 0.2), or its expression is uncertain (‘N’, 0.2 < P(zgc=on) < 0.8).
685	Materials and methods; Method details; Expression-based tree of cell types	1	4	We computed the Hamming distance between pairs of expression ‘sequences’ considering only unambiguous positions, using the dist.dna() routine in the ape R package (Paradis et al., 2004).
686	Materials and methods; Method details; Expression-based tree of cell types	1	5	We then used the minimum evolution approach to estimate the ‘phylogeny’ of the cells, using the balanced weighting scheme (Desper and Gascuel, 2002), as implemented in the ape fastme.bal() routine.
687	Materials and methods; Method details; Expression-based tree of cell types	1	6	We then built trees from 1000 bootstrapped replicates and quantified the support for each branch on the original tree.
688	Materials and methods; Method details; Expression-based tree of cell types	1	7	We visualized the tree using the phytools R package (Revell, 2012).
689	Materials and methods; Method details; Identifying marker genes	1	1	We identified marker genes specifically enriched in individual cell types and groups of cells (photoreceptor, glia, muscle, neuron) by searching for genes inferred to be almost exclusively expressed in a single cell type or cell group (P(zgc=on)>=0.9 for all cells within a group, and at most two cells outside a group) and with transcript abundance higher than all cells outside the group.
690	Materials and methods; Method details; Evaluating expression patterns for genes with different functions	1	1	We used FlyBase Gene Groups (release 2018_02) to assign functions to genes, and considered the most terminal groups in the hierarchy that had at least 10 genes.
691	Materials and methods; Method details; Mapping receptor expression onto synapses	1	1	To map receptor expression onto synaptic connectivity, we first obtained synapse pairs from Takemura et al. (2013) to identify synaptic targets of R8 (cell #111), R7 (cell #205), and C2 (cell #214) cells in the medulla.
692	Materials and methods; Method details; Mapping receptor expression onto synapses	1	2	When multiple instances of a cell type were available in the synaptic table, we chose the one with the greatest number of synaptic partners.
693	Materials and methods; Method details; Mapping receptor expression onto synapses	1	3	For target cell types that we profiled with TAPIN/INTACT-seq, we discretized their expression as either on (p(on)>=0.8) or off (p(on)<0.8).
694	Materials and methods; Method details; Mapping receptor expression onto synapses	1	4	For cell types that we did not profile, we classified them as unknown receptor expression.
695	Materials and methods; Data and software availability	1	1	All raw and processed transcriptome data is available from NCBI GEO (accession GSE116969).
696	Materials and methods; Data and software availability	1	2	The shell scripts used to process the raw RNA-seq data, and the R and Stan programs that implement the mixture model as well as generate all figures and tables in this paper are available at github (http://github.com/fredpdavis/opticlobe).
697	Materials and methods; Data and software availability	1	3	The cell type-level expression table can be explored interactively at http://www.opticlobe.com.
